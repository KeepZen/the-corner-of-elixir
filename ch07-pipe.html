<!DOCTYPE html>
<html lang="cn-zh">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="generator" content="ExDoc v0.28.4">
    <meta name="project" content="the_corner_of_elixir v0.1.0">

      <meta name="author" content="Keep Zen">

    <title>第七章 管道操作符 — the_corner_of_elixir v0.1.0</title>
    <link rel="stylesheet" href="dist/elixir-b6f1ed5df9b1d42a7309.css" />

    <script src="dist/sidebar_items-a0514d8df2.js"></script>

      <script src="docs_config.js"></script>

    <script async src="dist/app-bd1cb213813bf4825aa2.js"></script>

<style>
  a.footnote {
    vertical-align: super;
  }
  a.reversefootnote {
    display: inline-block;
    text-indent: -9999px;
    line-height: 0;
  }
  a.reversefootnote:after {
    content: '↩'; /* or any other text you want */
    text-indent: 0;
    display: block;
    line-height: initial;
  }
</style>

<script>
MathJax = {
tex: {
inlineMath: [['$', '$']]
}
};
</script>
<script id="MathJax-script" async
src="./assets/tex-chtml.js">
</script>

<script src="assets/mermaid.min.js"></script>
<script>
document.addEventListener("DOMContentLoaded", function () {
mermaid.initialize({ startOnLoad: false });
let id = 0;
for (const codeEl of document.querySelectorAll("pre code.mermaid")) {
  const preEl = codeEl.parentElement;
  const graphDefinition = codeEl.textContent;
  const graphEl = document.createElement("div");
  const graphId = "mermaid-graph-" + id++;
  mermaid.render(graphId, graphDefinition, function (svgSource, bindListeners) {
    graphEl.innerHTML = svgSource;
    bindListeners && bindListeners(graphEl);
    preEl.insertAdjacentElement("afterend", graphEl);
    preEl.remove();
  });
}
});
</script>

  </head>
  <body data-type="extras">
    <script>

      try {
        var settings = JSON.parse(localStorage.getItem('ex_doc:settings') || '{}');

        if (settings.theme === 'dark' ||
           ((settings.theme === 'system' || settings.theme == null) &&
             window.matchMedia('(prefers-color-scheme: dark)').matches)
           ) {
          document.body.classList.add('dark')
        }
      } catch (error) { }
    </script>

<div class="main">


<section class="sidebar">
  <button class="sidebar-button sidebar-toggle" aria-label="toggle sidebar">
    <i class="ri-menu-line ri-lg" title="Collapse/expand sidebar"></i>
  </button>

  <form class="sidebar-search" action="search.html">
    <button type="submit" class="search-button" aria-label="Submit Search">
      <i class="ri-search-2-line" aria-hidden="true" title="Submit search"></i>
    </button>
    <button type="button" tabindex="-1" class="search-close-button" aria-label="Cancel Search">
      <i class="ri-close-line ri-lg" aria-hidden="true" title="Cancel search"></i>
    </button>
    <label class="search-label">
      <p class="sr-only">Search</p>
      <input name="q" type="text" class="search-input" placeholder="Search..." aria-label="Input your search terms" autocomplete="off" />
    </label>
  </form>

  <div class="autocomplete">
    <div class="autocomplete-results">
    </div>
  </div>

  <div class="sidebar-header">

    <div class="sidebar-projectDetails">
      <a href="keepzen.github.io/the-corner-of-elixir" class="sidebar-projectName" translate="no">
the_corner_of_elixir
      </a>
      <strong class="sidebar-projectVersion" translate="no">
        v0.1.0
      </strong>
    </div>
    <ul class="sidebar-listNav">
      <li><a id="extras-list-link" href="#full-list">Pages</a></li>


    </ul>
  </div>

  <div class="gradient"></div>
  <ul id="full-list" class="sidebar-fullList"></ul>
</section>

<section class="content">
  <output role="status" id="toast"></output>
  <div class="content-outer">
    <div id="content" class="content-inner">

<h1>
<button class="settings display-settings">
  <i class="ri-settings-3-line"></i>
  <span class="sr-only">Settings</span>
</button>


    <a href="https://github.com/keepzen/the-corner-of-elixir/blob/main/cn/ch07.pipe.md#L1" title="View Source" class="view-source" rel="help">
      <i class="ri-code-s-slash-line" aria-hidden="true"></i>
      <span class="sr-only">View Source</span>
    </a>

  <span>第七章 管道操作符</span>
</h1>

<h2 id="管道操作符不是组合函数" class="section-heading">
  <a href="#管道操作符不是组合函数" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i>
  <p class="sr-only">管道操作符不是组合函数</p>
  </a>
  管道操作符不是组合函数
</h2>
<p>在函数式编程的社区中, 函数组合非常的重要. 组合函数是一个高阶函数, 它接受多个函数,
返回一个新的函数, 例如 <code class="inline">fun=compose(f,g,k)</code>, 那么 <code class="inline">fun(x,y,z)</code> 就等价于
<code class="inline">f(g(k(x,y,z)))</code>. 为了与思维的习惯一致, 人们还定义了反序的组合函数, 叫做 <code class="inline">pipe</code> 函数.</p><p>在 Elixir 中没有内置的 <code class="inline">compose</code> 或 <code class="inline">pipe</code> 函数, 但是内置了管道操作符 <code class="inline">|&gt;</code>.
我一度认为管道操作符 <code class="inline">|&gt;</code> 就是 Elixir 的 <code class="inline">pipe</code> 函数. 但是这是一个幻觉.
管道操作符 <code class="inline">|&gt;</code> 更像 shell 的管道而不是函数式编程中的 <code class="inline">pipe</code> 函数.</p><p>至少 Elixir 编译器不会为我们做函数组合的优化.</p><p>函数式编程中, 很多语言, 会对函子的 map 操作做优化. 比如:
<code class="inline">[1,2,3].map(f).map(f2)</code> 编译器会优化为 <code class="inline">[1,2,3].map(compse(f,f2))</code>,
以提高程序的执行效率.</p><p>在 Elixir 中, 相应的代码是这样的: <code class="inline">[1,2,3] |&gt; Enum.map(f)|&gt; Enum.map(f2)</code>.
这样的代码, 如果有优化的, 最后应该等价于 <code class="inline">[1,2,3]|&gt; Enum.map(&amp;f2.(f.(&amp;1)))</code>.
但是实际的情况并不是这样的.</p><p>例如下面的代码:</p><pre><code class="makeup elixir" translate="no"><span class="n">fun1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k" data-group-id="3014737324-1">fn</span><span class="w"> </span><span class="n">v</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">v</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">IO</span><span class="o">.</span><span class="n">inspect</span><span class="p" data-group-id="3014737324-2">(</span><span class="ss">label</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;+1&quot;</span><span class="p" data-group-id="3014737324-2">)</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">then</span><span class="p" data-group-id="3014737324-3">(</span><span class="o">&amp;</span><span class="p" data-group-id="3014737324-4">(</span><span class="ni">&amp;1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p" data-group-id="3014737324-4">)</span><span class="p" data-group-id="3014737324-3">)</span><span class="w"> </span><span class="k" data-group-id="3014737324-1">end</span><span class="w">
</span><span class="n">fun2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k" data-group-id="3014737324-5">fn</span><span class="w"> </span><span class="n">v</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">v</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">IO</span><span class="o">.</span><span class="n">inspect</span><span class="p" data-group-id="3014737324-6">(</span><span class="ss">label</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;-1&quot;</span><span class="p" data-group-id="3014737324-6">)</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">then</span><span class="p" data-group-id="3014737324-7">(</span><span class="o">&amp;</span><span class="p" data-group-id="3014737324-8">(</span><span class="ni">&amp;1</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p" data-group-id="3014737324-8">)</span><span class="p" data-group-id="3014737324-7">)</span><span class="w"> </span><span class="k" data-group-id="3014737324-5">end</span><span class="w">
</span><span class="n">range</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="o">..</span><span class="mi">5</span><span class="w">

</span><span class="n">range</span><span class="w">
</span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Enum</span><span class="o">.</span><span class="n">map</span><span class="p" data-group-id="3014737324-9">(</span><span class="n">fun1</span><span class="p" data-group-id="3014737324-9">)</span><span class="w">
</span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Enum</span><span class="o">.</span><span class="n">map</span><span class="p" data-group-id="3014737324-10">(</span><span class="n">fun2</span><span class="p" data-group-id="3014737324-10">)</span><span class="w">
</span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">IO</span><span class="o">.</span><span class="n">inspect</span><span class="p" data-group-id="3014737324-11">(</span><span class="ss">label</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;result of map chain&quot;</span><span class="p" data-group-id="3014737324-11">)</span></code></pre><p>控制台的输出为:</p><pre><code class="makeup elixir" translate="no"><span class="o">+</span><span class="mi">1</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="w">
</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span><span class="w"> </span><span class="mi">2</span><span class="w">
</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span><span class="w"> </span><span class="mi">3</span><span class="w">
</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span><span class="w"> </span><span class="mi">4</span><span class="w">
</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span><span class="w"> </span><span class="mi">5</span><span class="w">
</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span><span class="w"> </span><span class="mi">2</span><span class="w">
</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span><span class="w"> </span><span class="mi">3</span><span class="w">
</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span><span class="w"> </span><span class="mi">4</span><span class="w">
</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span><span class="w"> </span><span class="mi">5</span><span class="w">
</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span><span class="w"> </span><span class="mi">6</span><span class="w">
</span><span class="n">result</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">map</span><span class="w"> </span><span class="ss">chain</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="2834943876-1">[</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="mi">5</span><span class="p" data-group-id="2834943876-1">]</span></code></pre><p>从控制台的输出中, 可以观察到, 所有的 <code class="inline">+1</code> 输出结束后, 才开始 <code class="inline">-1</code> 的输出.
管道操作符 <code class="inline">|&gt;</code> 连接起来的多个 <code class="inline">Enum.map</code> 并没有被合并为一个.
只有对 <code class="inline">fun1</code> 的迭代全部完成后, 对 <code class="inline">fun2</code> 调用才开始执行.
但如果把 <code class="inline">fun2</code> 和 <code class="inline">fun1</code> 组合成一个新的函数, 像下面的代码这样:</p><pre><code class="makeup elixir" translate="no"><span class="n">range</span><span class="w">
</span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Enum</span><span class="o">.</span><span class="n">map</span><span class="p" data-group-id="9095046349-1">(</span><span class="o">&amp;</span><span class="n">fun2</span><span class="o">.</span><span class="p" data-group-id="9095046349-2">(</span><span class="n">fun1</span><span class="o">.</span><span class="p" data-group-id="9095046349-3">(</span><span class="ni">&amp;1</span><span class="p" data-group-id="9095046349-3">)</span><span class="p" data-group-id="9095046349-2">)</span><span class="p" data-group-id="9095046349-1">)</span><span class="w">
</span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">IO</span><span class="o">.</span><span class="n">inspect</span><span class="p" data-group-id="9095046349-4">(</span><span class="ss">label</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;result of compose&quot;</span><span class="p" data-group-id="9095046349-4">)</span></code></pre><p>那么控制台的输出应该是 <code class="inline">+1</code> <code class="inline">-1</code> 交替出现.</p><p>因此可见, Elixir 内置的管道操作符 <code class="inline">|&gt;</code> 不是函数式编程的 <code class="inline">pipe</code> 函数.</p><p>可是手动的组合函数总是比较的麻烦, 写一个函数来帮助我们完成函数的组合也不是难事,
但是 Elixir 社区中, 因为命名函数不是一等公民, 所以函数组合的语法并不常用.
大家最习惯的其实还是使用管道操作符 <code class="inline">|&gt;</code>, 所以如果管道操作符 <code class="inline">|&gt;</code> 能对 <code class="inline">Enum.map</code>
做优化, 那么应该能提升代码的运行效率.</p><p>非常幸运, 管道操作符 <code class="inline">|&gt;</code> 在 Elixir 中并不是特殊表单, 因此可以定义自己的管道操作符
<code class="inline">|&gt;</code>.</p><p>Elixir 源码中定义的管道操作符 <code class="inline">|&gt;</code> 可以作为我们工作的起点.
我们可以在
<a href="https://github.com/elixir-lang/elixir/blob/9a4d10e702f33d2fa47718cde05375b506b4a3d6/lib/elixir/lib/kernel.ex#L4073"><code class="inline">kernel.ex</code></a>
中发现其定义:</p><pre><code class="makeup elixir" translate="no"><span class="kd">defmacro</span><span class="w"> </span><span class="n">left</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">right</span><span class="w"> </span><span class="k" data-group-id="8974598636-1">do</span><span class="w">
  </span><span class="p" data-group-id="8974598636-2">[</span><span class="p" data-group-id="8974598636-3">{</span><span class="n">h</span><span class="p">,</span><span class="w"> </span><span class="bp">_</span><span class="p" data-group-id="8974598636-3">}</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">t</span><span class="p" data-group-id="8974598636-2">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Macro</span><span class="o">.</span><span class="n">unpipe</span><span class="p" data-group-id="8974598636-4">(</span><span class="p" data-group-id="8974598636-5">{</span><span class="ss">:|&gt;</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="8974598636-6">[</span><span class="p" data-group-id="8974598636-6">]</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="8974598636-7">[</span><span class="n">left</span><span class="p">,</span><span class="w"> </span><span class="n">right</span><span class="p" data-group-id="8974598636-7">]</span><span class="p" data-group-id="8974598636-5">}</span><span class="p" data-group-id="8974598636-4">)</span><span class="w">

  </span><span class="n">fun</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k" data-group-id="8974598636-8">fn</span><span class="w"> </span><span class="p" data-group-id="8974598636-9">{</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">pos</span><span class="p" data-group-id="8974598636-9">}</span><span class="p">,</span><span class="w"> </span><span class="n">acc</span><span class="w"> </span><span class="o">-&gt;</span><span class="w">
    </span><span class="nc">Macro</span><span class="o">.</span><span class="n">pipe</span><span class="p" data-group-id="8974598636-10">(</span><span class="n">acc</span><span class="p">,</span><span class="w"> </span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">pos</span><span class="p" data-group-id="8974598636-10">)</span><span class="w">
  </span><span class="k" data-group-id="8974598636-8">end</span><span class="w">

  </span><span class="nc">:lists</span><span class="o">.</span><span class="n">foldl</span><span class="p" data-group-id="8974598636-11">(</span><span class="n">fun</span><span class="p">,</span><span class="w"> </span><span class="n">h</span><span class="p">,</span><span class="w"> </span><span class="n">t</span><span class="p" data-group-id="8974598636-11">)</span><span class="w">
</span><span class="k" data-group-id="8974598636-1">end</span></code></pre><p>不用特别的熟悉 Elixir 的宏, 只需要理解最后的 <a href="https://www.erlang.org/doc/man/lists.html#foldl-3"><code class="inline">:lists.foldl/3</code></a>,
我们就能大概理解管道操作符 <code class="inline">|&gt;</code> 的原理了, 其实与在 Javascript 中定义
<code class="inline">pipe</code> 函数的算法一样.</p><p>上面的代码中, <code class="inline">t</code> 就是管道操作符 <code class="inline">|&gt;</code> 的所有的右操作数 (函数) 组成的列表,
也就是所有待组合的 <strong>函数调用</strong> 的列表.</p><p>我们自己定义的管道操作符 <code class="inline">|&gt;</code> 所作的优化, 本质就是对函数调用列表 <code class="inline">t</code> 合并同类项.
具体来说就是, 识别连续相邻的 <code class="inline">Enum.map(f1)</code>, <code class="inline">Enum.map(f2)</code> ...,<code class="inline">Enum.map(fn)</code>,
并把他们合并成为一个 <code class="inline">Enum.map(composed_fun)</code>.</p><p>首先我们定义一个 <code class="inline">Optimizer</code> 行为, 这个这个行为只有一个函数, 就是优化函数:
<code class="inline">optimize(t,list)</code>.</p><p>所以如此, 是因为, 虽然现在我们只是完成 <a href="https://hexdocs.pm/elixir/Enum.html#map/2"><code class="inline">Enum.map/2</code></a> 相关的实现,
但是对于管道操作符 <code class="inline">|&gt;</code> 的右操作数, 如果将来发现, 除 <a href="https://hexdocs.pm/elixir/Enum.html#map/2"><code class="inline">Enum.map/2</code></a> 组成的链条外,
还有其他的情形可以优化, 那么我们只需要对新情形实现 <code class="inline">Optimizer</code> 行为就好了.</p><p>定义 <code class="inline">Optimizer</code> 行为, 让我们的代码更容易组织.</p><h2 id="优化器协议" class="section-heading">
  <a href="#优化器协议" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i>
  <p class="sr-only">优化器协议</p>
  </a>
  优化器协议
</h2>
<pre><code class="makeup elixir" translate="no"><span class="kd">defmodule</span><span class="w"> </span><span class="nc">Optimizer</span><span class="w"> </span><span class="k" data-group-id="4703702326-1">do</span><span class="w">
  </span><span class="na">@callback</span><span class="w"> </span><span class="n">optimize</span><span class="p" data-group-id="4703702326-2">(</span><span class="n">t</span><span class="w"> </span><span class="o">::</span><span class="w"> </span><span class="n">any</span><span class="p">,</span><span class="w"> </span><span class="n">ast_list</span><span class="w"> </span><span class="o">::</span><span class="w"> </span><span class="nc">List</span><span class="o">.</span><span class="n">t</span><span class="p" data-group-id="4703702326-3">(</span><span class="p" data-group-id="4703702326-3">)</span><span class="p" data-group-id="4703702326-2">)</span><span class="w"> </span><span class="o">::</span><span class="w"> </span><span class="nc">List</span><span class="o">.</span><span class="n">t</span><span class="p" data-group-id="4703702326-4">(</span><span class="p" data-group-id="4703702326-4">)</span><span class="w">

  </span><span class="kd">defmacro</span><span class="w"> </span><span class="nf">__using__</span><span class="p" data-group-id="4703702326-5">(</span><span class="c">_opts</span><span class="p" data-group-id="4703702326-5">)</span><span class="w"> </span><span class="k" data-group-id="4703702326-6">do</span><span class="w">
    </span><span class="k">quote</span><span class="w"> </span><span class="k" data-group-id="4703702326-7">do</span><span class="w">
      </span><span class="kn">import</span><span class="w"> </span><span class="nc">Kernel</span><span class="p">,</span><span class="w"> </span><span class="ss">except</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="4703702326-8">[</span><span class="ss">|&gt;</span><span class="p">:</span><span class="w"> </span><span class="mi">2</span><span class="p" data-group-id="4703702326-8">]</span><span class="w">
      </span><span class="kn">import</span><span class="w"> </span><span class="nc">Optimizer.Pipe</span><span class="p">,</span><span class="w"> </span><span class="ss">only</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="4703702326-9">[</span><span class="ss">|&gt;</span><span class="p">:</span><span class="w"> </span><span class="mi">2</span><span class="p" data-group-id="4703702326-9">]</span><span class="w">
    </span><span class="k" data-group-id="4703702326-7">end</span><span class="w">
  </span><span class="k" data-group-id="4703702326-6">end</span><span class="w">
</span><span class="k" data-group-id="4703702326-1">end</span></code></pre><p>第 2 行我们定义了优化器的接口.
而 <code class="inline">__using__/1</code> 的定义可以看作是优化器对外提供的 API.
优化器的使用者, 只需要 <code class="inline">use Optimizer</code> 就可以了使用优化器了,
不用关心优化器内部的实现.</p><h2 id="对-enum-map-优化" class="section-heading">
  <a href="#对-enum-map-优化" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i>
  <p class="sr-only">对-enum-map-优化</p>
  </a>
  对 Enum.map 优化
</h2>
<p>现在让我们来定义针对 <a href="https://hexdocs.pm/elixir/Enum.html#map/2"><code class="inline">Enum.map/2</code></a> 的优化.
我把有关优化的代码都放在 <code class="inline">optimizer</code> 目录下,
为 <a href="https://hexdocs.pm/elixir/Enum.html#map/2"><code class="inline">Enum.map/2</code></a> 做优化的模块, 命名为 <code class="inline">Optimizer.EnumMap</code>.</p><p>像我们上面分析的那样, <code class="inline">Optimizer.EnumMap</code> 要做的事情, 就是把由管道操作符 <code class="inline">|&gt;</code>,
链接起来的连续的多个 <code class="inline">Enum.map(fun)</code> 表达式合并为一个 <code class="inline">Enum.map(funs)</code>.
这里由 <code class="inline">reduce_map/1</code> 函数完成具体的工作. <code class="inline">reduce_map</code> 函数分两步完成工作:</p><ol><li>对所有函数调用表达式进行分组, 连续的 <code class="inline">Enum.map(fun)</code> 表达式分为一组,
其他的表达式, 单独为一组. 由 <code class="inline">group_function_calls/1</code> 完成.</li><li>把分组后的 <code class="inline">Enum.map(fun)</code> 表达式抽象语法树, 
合并为一个 <code class="inline">Enum.map(composed_fun)</code>. 由 <code class="inline">tranceform_group/1</code>.<pre><code class="makeup elixir" translate="no"><span class="kd">defmodule</span><span class="w"> </span><span class="nc">Corner.Optimizer.EnumMap</span><span class="w"> </span><span class="k" data-group-id="7473852852-1">do</span><span class="w">
  </span><span class="kn">alias</span><span class="w"> </span><span class="nc">Corner.Optimizer</span><span class="w">
  </span><span class="na">@behaviour</span><span class="w"> </span><span class="nc">Optimizer</span><span class="w">

  </span><span class="na">@impl</span><span class="w"> </span><span class="nc">Optimizer</span><span class="w">
  </span><span class="kd">def</span><span class="w"> </span><span class="nf">optimize</span><span class="p" data-group-id="7473852852-2">(</span><span class="bp">__MODULE__</span><span class="p">,</span><span class="w"> </span><span class="n">list</span><span class="p" data-group-id="7473852852-2">)</span><span class="w"> </span><span class="k" data-group-id="7473852852-3">do</span><span class="w">
    </span><span class="n">reduce_map</span><span class="p" data-group-id="7473852852-4">(</span><span class="n">list</span><span class="p" data-group-id="7473852852-4">)</span><span class="w">
  </span><span class="k" data-group-id="7473852852-3">end</span><span class="w">

  </span><span class="kd">defp</span><span class="w"> </span><span class="nf">reduce_map</span><span class="p" data-group-id="7473852852-5">(</span><span class="n">ast_list</span><span class="p" data-group-id="7473852852-5">)</span><span class="w"> </span><span class="k" data-group-id="7473852852-6">do</span><span class="w">
    </span><span class="n">ast_list</span><span class="w">
    </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">group_function_calls</span><span class="p" data-group-id="7473852852-7">(</span><span class="p" data-group-id="7473852852-7">)</span><span class="w">
    </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Enum</span><span class="o">.</span><span class="n">map</span><span class="p" data-group-id="7473852852-8">(</span><span class="o">&amp;</span><span class="n">tranceform_group</span><span class="o">/</span><span class="mi">1</span><span class="p" data-group-id="7473852852-8">)</span><span class="w">
  </span><span class="k" data-group-id="7473852852-6">end</span><span class="w">
  </span><span class="c1">#...</span><span class="w">
</span><span class="k" data-group-id="7473852852-1">end</span></code></pre><code class="inline">group_function_calls</code> 就是对函数调用表达式的抽象语法树列表做迭代.
对于函数调用 <code class="inline">fun_call</code>, 如果它是 <code class="inline">Enum.map(fun)</code> 的抽象语法树,
那么它应该就是被分组的内容, 首先把它使用列表包裹, 以表示这是一个分组,
然后把列表添加到汇聚结果 <code class="inline">acc</code> 的头部.
如果它不是 <code class="inline">Enum.map(fun)</code>, 那么直接加入到 <code class="inline">acc</code> 头部就好了.</li></ol><p>当汇聚结果 <code class="inline">acc</code> 其中由内容了, 待检查的 <code class="inline">fun</code> 符合要求, 
而且汇聚结果的最后一个元素是一个列表话, 那么我们需要继续向列表中添加新的元素.
如果汇聚结果的最后一个元素不是一个列表. 那么需要向汇聚结果中添加新的分组列表.</p><p>当 <code class="inline">fun</code> 不是 <code class="inline">Enum.map(fun)</code> 的时候, 只要把 <code class="inline">fun</code> 添加到汇聚结果中, 就可以了.</p><p>这样操作后, 函数调用的顺序全部颠倒了, 所以使用 <a href="https://hexdocs.pm/elixir/Enum.html#reverse/1"><code class="inline">Enum.reverse/1</code></a>
对函数调用列表完成重排. </p><pre><code class="makeup elixir" translate="no"><span class="kd">defp</span><span class="w"> </span><span class="nf">group_function_calls</span><span class="p" data-group-id="8747037653-1">(</span><span class="n">fun_call_list</span><span class="p" data-group-id="8747037653-1">)</span><span class="w"> </span><span class="k" data-group-id="8747037653-2">do</span><span class="w">
  </span><span class="k">for</span><span class="w"> </span><span class="n">fun_call</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">fun_call_list</span><span class="p">,</span><span class="w"> </span><span class="ss">reduce</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="8747037653-3">[</span><span class="p" data-group-id="8747037653-3">]</span><span class="w"> </span><span class="k" data-group-id="8747037653-4">do</span><span class="w">
    </span><span class="p" data-group-id="8747037653-5">[</span><span class="p" data-group-id="8747037653-5">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">acc</span><span class="w"> </span><span class="o">-&gt;</span><span class="w">
      </span><span class="k">if</span><span class="w"> </span><span class="n">is_map_call</span><span class="p" data-group-id="8747037653-6">(</span><span class="n">fun_call</span><span class="p" data-group-id="8747037653-6">)</span><span class="w"> </span><span class="k" data-group-id="8747037653-7">do</span><span class="w">
        </span><span class="p" data-group-id="8747037653-8">[</span><span class="p" data-group-id="8747037653-9">[</span><span class="n">fun_call</span><span class="p" data-group-id="8747037653-9">]</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">acc</span><span class="p" data-group-id="8747037653-8">]</span><span class="w">
      </span><span class="k" data-group-id="8747037653-7">else</span><span class="w">
        </span><span class="p" data-group-id="8747037653-10">[</span><span class="n">fun_call</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">acc</span><span class="p" data-group-id="8747037653-10">]</span><span class="w">
      </span><span class="k" data-group-id="8747037653-7">end</span><span class="w">
    </span><span class="p" data-group-id="8747037653-11">[</span><span class="n">ele</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">rest</span><span class="p" data-group-id="8747037653-11">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">acc</span><span class="w"> </span><span class="o">-&gt;</span><span class="w">
      </span><span class="n">fun_is_map?</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">is_map_call</span><span class="p" data-group-id="8747037653-12">(</span><span class="n">fun_call</span><span class="p" data-group-id="8747037653-12">)</span><span class="w">
      </span><span class="k">cond</span><span class="w"> </span><span class="k" data-group-id="8747037653-13">do</span><span class="w">
        </span><span class="n">fun_is_map?</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="n">is_list</span><span class="p" data-group-id="8747037653-14">(</span><span class="n">ele</span><span class="p" data-group-id="8747037653-14">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w">
          </span><span class="p" data-group-id="8747037653-15">[</span><span class="p" data-group-id="8747037653-16">[</span><span class="n">fun_call</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">ele</span><span class="p" data-group-id="8747037653-16">]</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">rest</span><span class="p" data-group-id="8747037653-15">]</span><span class="w">
        </span><span class="n">fun_is_map?</span><span class="w"> </span><span class="o">-&gt;</span><span class="w">
          </span><span class="p" data-group-id="8747037653-17">[</span><span class="p" data-group-id="8747037653-18">[</span><span class="n">fun_call</span><span class="p" data-group-id="8747037653-18">]</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">acc</span><span class="p" data-group-id="8747037653-17">]</span><span class="w">
        </span><span class="no">true</span><span class="w"> </span><span class="o">-&gt;</span><span class="w">
          </span><span class="p" data-group-id="8747037653-19">[</span><span class="n">fun_call</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">acc</span><span class="p" data-group-id="8747037653-19">]</span><span class="w">
      </span><span class="k" data-group-id="8747037653-13">end</span><span class="w">
  </span><span class="k" data-group-id="8747037653-4">end</span><span class="w">
  </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Enum</span><span class="o">.</span><span class="n">reverse</span><span class="p" data-group-id="8747037653-20">(</span><span class="p" data-group-id="8747037653-20">)</span><span class="w">
</span><span class="k" data-group-id="8747037653-2">end</span></code></pre><p><code class="inline">is_map_call/1</code> 用来检查抽象语法树是否对应表达式 <code class="inline">Enum.map(fun)</code>.</p><pre><code class="makeup elixir" translate="no"><span class="kd">defp</span><span class="w"> </span><span class="nf">is_map_call</span><span class="p" data-group-id="1309298063-1">(</span><span class="p" data-group-id="1309298063-2">{</span><span class="p" data-group-id="1309298063-3">{</span><span class="p" data-group-id="1309298063-4">{</span><span class="ss">:.</span><span class="p">,</span><span class="w"> </span><span class="bp">_</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="1309298063-5">[</span><span class="p" data-group-id="1309298063-6">{</span><span class="ss">:__aliases__</span><span class="p">,</span><span class="w"> </span><span class="bp">_</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="1309298063-7">[</span><span class="ss">:Enum</span><span class="p" data-group-id="1309298063-7">]</span><span class="p" data-group-id="1309298063-6">}</span><span class="p">,</span><span class="w"> </span><span class="ss">:map</span><span class="p" data-group-id="1309298063-5">]</span><span class="p" data-group-id="1309298063-4">}</span><span class="p">,</span><span class="w"> </span><span class="bp">_</span><span class="p">,</span><span class="w"> </span><span class="bp">_</span><span class="p" data-group-id="1309298063-3">}</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p" data-group-id="1309298063-2">}</span><span class="p" data-group-id="1309298063-1">)</span><span class="p">,</span><span class="w">
  </span><span class="ss">do</span><span class="p">:</span><span class="w"> </span><span class="no">true</span><span class="w">
</span><span class="kd">defp</span><span class="w"> </span><span class="nf">is_map_call</span><span class="p" data-group-id="1309298063-8">(</span><span class="bp">_</span><span class="p" data-group-id="1309298063-8">)</span><span class="p">,</span><span class="w"> </span><span class="ss">do</span><span class="p">:</span><span class="w"> </span><span class="no">false</span></code></pre><p><code class="inline">tranceform_group/1</code> 把分组的 <code class="inline">Enum.map(fun)</code> 合并为一个
<code class="inline">Enum.map(composed_fun)</code>.
这也是分三步完成, 第一步提取 <code class="inline">Enum.map(fun)</code> 表达式中的 <code class="inline">fun</code>.
这由 <code class="inline">get_fun/1</code> 函数完成.
第二个步组合提取函数. 最后一步把组合函数 <code class="inline">composed_fun</code> 转为为
<code class="inline">Enum.map(composed_fun)</code>. </p><p>其他非 <code class="inline">Enum.map(fun)</code> 的函数调用, 不做处理直接返回.</p><pre><code class="makeup elixir" translate="no"><span class="kd">defp</span><span class="w"> </span><span class="nf">tranceform_group</span><span class="p" data-group-id="9859796989-1">(</span><span class="n">map_calls</span><span class="p" data-group-id="9859796989-1">)</span><span class="w"> </span><span class="ow">when</span><span class="w"> </span><span class="n">is_list</span><span class="p" data-group-id="9859796989-2">(</span><span class="n">map_calls</span><span class="p" data-group-id="9859796989-2">)</span><span class="w"> </span><span class="k" data-group-id="9859796989-3">do</span><span class="w">
  </span><span class="n">composed_fun</span><span class="w"> </span><span class="o">=</span><span class="w">
    </span><span class="n">map_calls</span><span class="w">
    </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Enum</span><span class="o">.</span><span class="n">map</span><span class="p" data-group-id="9859796989-4">(</span><span class="o">&amp;</span><span class="n">get_fun</span><span class="o">/</span><span class="mi">1</span><span class="p" data-group-id="9859796989-4">)</span><span class="w">
    </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">compose</span><span class="p" data-group-id="9859796989-5">(</span><span class="p" data-group-id="9859796989-5">)</span><span class="w">

  </span><span class="p" data-group-id="9859796989-6">{</span><span class="p" data-group-id="9859796989-7">{</span><span class="p" data-group-id="9859796989-8">{</span><span class="ss">:.</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="9859796989-9">[</span><span class="p" data-group-id="9859796989-9">]</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="9859796989-10">[</span><span class="p" data-group-id="9859796989-11">{</span><span class="ss">:__aliases__</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="9859796989-12">[</span><span class="p" data-group-id="9859796989-12">]</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="9859796989-13">[</span><span class="ss">:Enum</span><span class="p" data-group-id="9859796989-13">]</span><span class="p" data-group-id="9859796989-11">}</span><span class="p">,</span><span class="w"> </span><span class="ss">:map</span><span class="p" data-group-id="9859796989-10">]</span><span class="p" data-group-id="9859796989-8">}</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="9859796989-14">[</span><span class="p" data-group-id="9859796989-14">]</span><span class="p">,</span><span class="w"> 
   </span><span class="p" data-group-id="9859796989-15">[</span><span class="n">composed_fun</span><span class="p" data-group-id="9859796989-15">]</span><span class="p" data-group-id="9859796989-7">}</span><span class="p">,</span><span class="w"> 
   </span><span class="mi">0</span><span class="p" data-group-id="9859796989-6">}</span><span class="w">
</span><span class="k" data-group-id="9859796989-3">end</span><span class="w">
</span><span class="kd">defp</span><span class="w"> </span><span class="nf">tranceform_group</span><span class="p" data-group-id="9859796989-16">(</span><span class="n">other_ast</span><span class="p" data-group-id="9859796989-16">)</span><span class="p">,</span><span class="w"> </span><span class="ss">do</span><span class="p">:</span><span class="w"> </span><span class="n">other_ast</span></code></pre><p><code class="inline">get_fun/1</code> 函数非常简单, 我们只是通过模式匹配来提取我们需要的就可以了.</p><pre><code class="makeup elixir" translate="no"><span class="kd">defp</span><span class="w"> </span><span class="nf">get_fun</span><span class="p" data-group-id="1359112562-1">(</span><span class="w">
       </span><span class="p" data-group-id="1359112562-2">{</span><span class="p" data-group-id="1359112562-3">{</span><span class="w">
          </span><span class="p" data-group-id="1359112562-4">{</span><span class="ss">:.</span><span class="p">,</span><span class="w"> </span><span class="bp">_</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="1359112562-5">[</span><span class="p" data-group-id="1359112562-6">{</span><span class="ss">:__aliases__</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="1359112562-7">[</span><span class="p" data-group-id="1359112562-7">]</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="1359112562-8">[</span><span class="ss">:Enum</span><span class="p" data-group-id="1359112562-8">]</span><span class="p" data-group-id="1359112562-6">}</span><span class="p">,</span><span class="w"> </span><span class="ss">:map</span><span class="p" data-group-id="1359112562-5">]</span><span class="p" data-group-id="1359112562-4">}</span><span class="p">,</span><span class="w">
          </span><span class="bp">_</span><span class="p">,</span><span class="w">
          </span><span class="p" data-group-id="1359112562-9">[</span><span class="n">fun</span><span class="p" data-group-id="1359112562-9">]</span><span class="w">
        </span><span class="p" data-group-id="1359112562-3">}</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p" data-group-id="1359112562-2">}</span><span class="w">
     </span><span class="p" data-group-id="1359112562-1">)</span><span class="w"> </span><span class="k" data-group-id="1359112562-10">do</span><span class="w">
  </span><span class="n">fun</span><span class="w">
</span><span class="k" data-group-id="1359112562-10">end</span></code></pre><p>最后是组合函数. <code class="inline">compose/1-2</code>.</p><pre><code class="makeup elixir" translate="no"><span class="kd">defp</span><span class="w"> </span><span class="nf">compose</span><span class="p" data-group-id="5324835692-1">(</span><span class="n">list</span><span class="p">,</span><span class="w"> </span><span class="n">acc</span><span class="w"> </span><span class="o">\\</span><span class="w"> </span><span class="no">nil</span><span class="p" data-group-id="5324835692-1">)</span><span class="w">

</span><span class="kd">defp</span><span class="w"> </span><span class="nf">compose</span><span class="p" data-group-id="5324835692-2">(</span><span class="p" data-group-id="5324835692-3">[</span><span class="n">fun</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">funs</span><span class="p" data-group-id="5324835692-3">]</span><span class="p">,</span><span class="w"> </span><span class="no">nil</span><span class="p" data-group-id="5324835692-2">)</span><span class="w"> </span><span class="k" data-group-id="5324835692-4">do</span><span class="w">
  </span><span class="n">acc</span><span class="w"> </span><span class="o">=</span><span class="w">
    </span><span class="k">quote</span><span class="w"> </span><span class="k" data-group-id="5324835692-5">do</span><span class="w">
      </span><span class="k">unquote</span><span class="p" data-group-id="5324835692-6">(</span><span class="n">fun</span><span class="p" data-group-id="5324835692-6">)</span><span class="o">.</span><span class="p" data-group-id="5324835692-7">(</span><span class="p" data-group-id="5324835692-7">)</span><span class="w">
    </span><span class="k" data-group-id="5324835692-5">end</span><span class="w">
  </span><span class="n">compose</span><span class="p" data-group-id="5324835692-8">(</span><span class="n">funs</span><span class="p">,</span><span class="w"> </span><span class="n">acc</span><span class="p" data-group-id="5324835692-8">)</span><span class="w">
</span><span class="k" data-group-id="5324835692-4">end</span><span class="w">

</span><span class="kd">defp</span><span class="w"> </span><span class="nf">compose</span><span class="p" data-group-id="5324835692-9">(</span><span class="p" data-group-id="5324835692-10">[</span><span class="n">fun</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">funs</span><span class="p" data-group-id="5324835692-10">]</span><span class="p">,</span><span class="w"> </span><span class="n">acc</span><span class="p" data-group-id="5324835692-9">)</span><span class="w"> </span><span class="k" data-group-id="5324835692-11">do</span><span class="w">
  </span><span class="n">acc</span><span class="w"> </span><span class="o">=</span><span class="w">
    </span><span class="k">quote</span><span class="w"> </span><span class="k" data-group-id="5324835692-12">do</span><span class="w">
      </span><span class="k">unquote</span><span class="p" data-group-id="5324835692-13">(</span><span class="n">fun</span><span class="p" data-group-id="5324835692-13">)</span><span class="o">.</span><span class="p" data-group-id="5324835692-14">(</span><span class="p" data-group-id="5324835692-14">)</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="k">unquote</span><span class="p" data-group-id="5324835692-15">(</span><span class="n">acc</span><span class="p" data-group-id="5324835692-15">)</span><span class="w">
    </span><span class="k" data-group-id="5324835692-12">end</span><span class="w">
  </span><span class="n">compose</span><span class="p" data-group-id="5324835692-16">(</span><span class="n">funs</span><span class="p">,</span><span class="w"> </span><span class="n">acc</span><span class="p" data-group-id="5324835692-16">)</span><span class="w">
</span><span class="k" data-group-id="5324835692-11">end</span><span class="w">

</span><span class="kd">defp</span><span class="w"> </span><span class="nf">compose</span><span class="p" data-group-id="5324835692-17">(</span><span class="p" data-group-id="5324835692-18">[</span><span class="p" data-group-id="5324835692-18">]</span><span class="p">,</span><span class="w"> </span><span class="n">acc</span><span class="p" data-group-id="5324835692-17">)</span><span class="w"> </span><span class="k" data-group-id="5324835692-19">do</span><span class="w">
  </span><span class="k">quote</span><span class="w"> </span><span class="k" data-group-id="5324835692-20">do</span><span class="w">
    </span><span class="k" data-group-id="5324835692-21">fn</span><span class="w"> </span><span class="n">v</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">v</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="k">unquote</span><span class="p" data-group-id="5324835692-22">(</span><span class="n">acc</span><span class="p" data-group-id="5324835692-22">)</span><span class="w"> </span><span class="k" data-group-id="5324835692-21">end</span><span class="w">
  </span><span class="k" data-group-id="5324835692-20">end</span><span class="w">
</span><span class="k" data-group-id="5324835692-19">end</span></code></pre><p>分组后函数的列表的顺序与它们在管道操作符中出现的顺序已经完成了反转.
对与列表 <code class="inline">[fun_n, ... fun_2, fun_1]</code>. 这里每一个函数都是一元函数.
最终要转化为 <code class="inline">fn v -&gt; v |&gt; fun_1.() |&gt; fun_2.() |&gt; ... |&gt; fun_n.() end</code>.
第一个分句完成, 最后 <code class="inline">fun_n.()</code>, 第二个分句完成
<code class="inline">fun_1.() |&gt; fun_2.() ..|&gt; fun_n.()</code>.
而最后一个数据完成 <code class="inline">fn -&gt; v |&gt; ... end</code> 的操作.</p><p>前面说过, 要自定义管道操作符 <code class="inline">|&gt;</code>, 现在是兑现的时候了.</p><h2 id="管道操作符" class="section-heading">
  <a href="#管道操作符" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i>
  <p class="sr-only">管道操作符</p>
  </a>
  管道操作符
</h2>
<pre><code class="makeup elixir" translate="no"><span class="kd">defmodule</span><span class="w"> </span><span class="nc">Corner.Optimizer.Pipe</span><span class="w"> </span><span class="k" data-group-id="3949270763-1">do</span><span class="w">
  </span><span class="kn">import</span><span class="w"> </span><span class="nc">Kernel</span><span class="p">,</span><span class="w"> </span><span class="ss">except</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="3949270763-2">[</span><span class="ss">|&gt;</span><span class="p">:</span><span class="w"> </span><span class="mi">2</span><span class="p" data-group-id="3949270763-2">]</span><span class="w">
  </span><span class="kn">alias</span><span class="w"> </span><span class="nc">Corner.Optimizer</span><span class="o">.</span><span class="p" data-group-id="3949270763-3">{</span><span class="nc">EnumMap</span><span class="p" data-group-id="3949270763-3">}</span><span class="w">
  </span><span class="na">@optimizer</span><span class="w"> </span><span class="p" data-group-id="3949270763-4">[</span><span class="nc">EnumMap</span><span class="p" data-group-id="3949270763-4">]</span><span class="w">
  </span><span class="kd">defmacro</span><span class="w"> </span><span class="n">left</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">right</span><span class="w"> </span><span class="k" data-group-id="3949270763-5">do</span><span class="w">
    </span><span class="p" data-group-id="3949270763-6">[</span><span class="p" data-group-id="3949270763-7">{</span><span class="n">h</span><span class="p">,</span><span class="w"> </span><span class="bp">_</span><span class="p" data-group-id="3949270763-7">}</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">t</span><span class="p" data-group-id="3949270763-6">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Macro</span><span class="o">.</span><span class="n">unpipe</span><span class="p" data-group-id="3949270763-8">(</span><span class="p" data-group-id="3949270763-9">{</span><span class="ss">:|&gt;</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="3949270763-10">[</span><span class="p" data-group-id="3949270763-10">]</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="3949270763-11">[</span><span class="n">left</span><span class="p">,</span><span class="w"> </span><span class="n">right</span><span class="p" data-group-id="3949270763-11">]</span><span class="p" data-group-id="3949270763-9">}</span><span class="p" data-group-id="3949270763-8">)</span><span class="w">

    </span><span class="n">fun</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k" data-group-id="3949270763-12">fn</span><span class="w"> </span><span class="p" data-group-id="3949270763-13">{</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">pos</span><span class="p" data-group-id="3949270763-13">}</span><span class="p">,</span><span class="w"> </span><span class="n">acc</span><span class="w"> </span><span class="o">-&gt;</span><span class="w">
      </span><span class="nc">Macro</span><span class="o">.</span><span class="n">pipe</span><span class="p" data-group-id="3949270763-14">(</span><span class="n">acc</span><span class="p">,</span><span class="w"> </span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">pos</span><span class="p" data-group-id="3949270763-14">)</span><span class="w">
    </span><span class="k" data-group-id="3949270763-12">end</span><span class="w">

    </span><span class="n">t</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Enum</span><span class="o">.</span><span class="n">reduce</span><span class="p" data-group-id="3949270763-15">(</span><span class="na">@optimizer</span><span class="p">,</span><span class="w"> </span><span class="n">t</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">apply</span><span class="p" data-group-id="3949270763-16">(</span><span class="ni">&amp;1</span><span class="p">,</span><span class="w"> </span><span class="ss">:optimize</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="3949270763-17">[</span><span class="ni">&amp;1</span><span class="p">,</span><span class="w"> </span><span class="ni">&amp;2</span><span class="p" data-group-id="3949270763-17">]</span><span class="p" data-group-id="3949270763-16">)</span><span class="p" data-group-id="3949270763-15">)</span><span class="w">
    </span><span class="nc">:lists</span><span class="o">.</span><span class="n">foldl</span><span class="p" data-group-id="3949270763-18">(</span><span class="n">fun</span><span class="p">,</span><span class="w"> </span><span class="n">h</span><span class="p">,</span><span class="w"> </span><span class="n">t</span><span class="p" data-group-id="3949270763-18">)</span><span class="w">
  </span><span class="k" data-group-id="3949270763-5">end</span><span class="w">
</span><span class="k" data-group-id="3949270763-1">end</span></code></pre><p>当定义了更多的优化器的时候, 只需要修改上面代码的第 3, 4 两行代码, 就可以了.</p><p>上面的代码, 大部分都是照搬 Elixir 的 Kernel 模块中管道操作符 <code class="inline">|&gt;</code> 的定义,
只是增加了第 12 行的内容, 而它做的工作, 依次的调用我们定义的优化器.</p><p>现在来看看, 代码是不能按照我们的预期工作:</p><pre><code class="makeup elixir" translate="no"><span class="kn">use</span><span class="w"> </span><span class="nc">Corner.Optimizer</span><span class="w">
</span><span class="n">add_one</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k" data-group-id="2792750602-1">fn</span><span class="w"> </span><span class="n">v</span><span class="w"> </span><span class="o">-&gt;</span><span class="w">
  </span><span class="nc">IO</span><span class="o">.</span><span class="n">puts</span><span class="p" data-group-id="2792750602-2">(</span><span class="s">&quot;+1&quot;</span><span class="p" data-group-id="2792750602-2">)</span><span class="w">
  </span><span class="n">v</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="w">
</span><span class="k" data-group-id="2792750602-1">end</span><span class="w">

</span><span class="n">sub_one</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k" data-group-id="2792750602-3">fn</span><span class="w"> </span><span class="n">v</span><span class="w"> </span><span class="o">-&gt;</span><span class="w">
  </span><span class="nc">IO</span><span class="o">.</span><span class="n">puts</span><span class="p" data-group-id="2792750602-4">(</span><span class="s">&quot;-1&quot;</span><span class="p" data-group-id="2792750602-4">)</span><span class="w">
  </span><span class="n">v</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="w">
</span><span class="k" data-group-id="2792750602-3">end</span><span class="w">

</span><span class="mi">1</span><span class="o">..</span><span class="mi">5</span><span class="w">
</span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Enum</span><span class="o">.</span><span class="n">map</span><span class="p" data-group-id="2792750602-5">(</span><span class="n">add_one</span><span class="p" data-group-id="2792750602-5">)</span><span class="w">
</span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Enum</span><span class="o">.</span><span class="n">map</span><span class="p" data-group-id="2792750602-6">(</span><span class="n">sub_one</span><span class="p" data-group-id="2792750602-6">)</span><span class="w">
</span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">IO</span><span class="o">.</span><span class="n">inspect</span><span class="p" data-group-id="2792750602-7">(</span><span class="ss">label</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;after optimizer&quot;</span><span class="p" data-group-id="2792750602-7">)</span></code></pre><p>控制台中输出为:</p><pre><code class="makeup elixir" translate="no"><span class="o">+</span><span class="mi">1</span><span class="w">
</span><span class="o">-</span><span class="mi">1</span><span class="w">
</span><span class="o">+</span><span class="mi">1</span><span class="w">
</span><span class="o">-</span><span class="mi">1</span><span class="w">
</span><span class="o">+</span><span class="mi">1</span><span class="w">
</span><span class="o">-</span><span class="mi">1</span><span class="w">
</span><span class="o">+</span><span class="mi">1</span><span class="w">
</span><span class="o">-</span><span class="mi">1</span><span class="w">
</span><span class="o">+</span><span class="mi">1</span><span class="w">
</span><span class="o">-</span><span class="mi">1</span><span class="w">
</span><span class="k">after</span><span class="w"> </span><span class="ss">optimizer</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="5251998293-1">[</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="mi">5</span><span class="p" data-group-id="5251998293-1">]</span></code></pre><h2 id="基准测试" class="section-heading">
  <a href="#基准测试" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i>
  <p class="sr-only">基准测试</p>
  </a>
  基准测试
</h2>
<p>看起来, 功能测试通过了, 但是我们毕竟是做优化的, 我们的代码真的能提升代码的执行效率吗?
这还需要实际测试的.</p><pre><code class="makeup elixir" translate="no"><span class="kd">defmodule</span><span class="w"> </span><span class="nc">OptimizeBenchmarkTest</span><span class="w"> </span><span class="k" data-group-id="6117619246-1">do</span><span class="w">
  </span><span class="kn">use</span><span class="w"> </span><span class="nc">ExUnit.Case</span><span class="p">,</span><span class="w"> </span><span class="ss">async</span><span class="p">:</span><span class="w"> </span><span class="no">true</span><span class="w">
  </span><span class="na">@range</span><span class="w"> </span><span class="mi">1</span><span class="o">..</span><span class="mi">1000</span><span class="w">

  </span><span class="kd">def</span><span class="w"> </span><span class="nf">fun1</span><span class="p" data-group-id="6117619246-2">(</span><span class="n">up</span><span class="w"> </span><span class="o">\\</span><span class="w"> </span><span class="mi">10</span><span class="p" data-group-id="6117619246-2">)</span><span class="w"> </span><span class="k" data-group-id="6117619246-3">do</span><span class="w">
    </span><span class="k">for</span><span class="w"> </span><span class="bp">_</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="mi">1</span><span class="o">..</span><span class="n">up</span><span class="w"> </span><span class="k" data-group-id="6117619246-4">do</span><span class="w">
      </span><span class="na">@range</span><span class="w">
      </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Enum</span><span class="o">.</span><span class="n">map</span><span class="p" data-group-id="6117619246-5">(</span><span class="o">&amp;</span><span class="p" data-group-id="6117619246-6">(</span><span class="ni">&amp;1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p" data-group-id="6117619246-6">)</span><span class="p" data-group-id="6117619246-5">)</span><span class="w">
      </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Enum</span><span class="o">.</span><span class="n">map</span><span class="p" data-group-id="6117619246-7">(</span><span class="o">&amp;</span><span class="p" data-group-id="6117619246-8">(</span><span class="ni">&amp;1</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p" data-group-id="6117619246-8">)</span><span class="p" data-group-id="6117619246-7">)</span><span class="w">
    </span><span class="k" data-group-id="6117619246-4">end</span><span class="w">
  </span><span class="k" data-group-id="6117619246-3">end</span><span class="w">

  </span><span class="kd">def</span><span class="w"> </span><span class="nf">fun2</span><span class="p" data-group-id="6117619246-9">(</span><span class="n">up</span><span class="w"> </span><span class="o">\\</span><span class="w"> </span><span class="mi">10</span><span class="p" data-group-id="6117619246-9">)</span><span class="w"> </span><span class="k" data-group-id="6117619246-10">do</span><span class="w">
    </span><span class="kn">use</span><span class="w"> </span><span class="nc">Corner.Optimizer</span><span class="w">

    </span><span class="k">for</span><span class="w"> </span><span class="bp">_</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="mi">1</span><span class="o">..</span><span class="n">up</span><span class="w"> </span><span class="k" data-group-id="6117619246-11">do</span><span class="w">
      </span><span class="na">@range</span><span class="w">
      </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Enum</span><span class="o">.</span><span class="n">map</span><span class="p" data-group-id="6117619246-12">(</span><span class="o">&amp;</span><span class="p" data-group-id="6117619246-13">(</span><span class="ni">&amp;1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p" data-group-id="6117619246-13">)</span><span class="p" data-group-id="6117619246-12">)</span><span class="w">
      </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Enum</span><span class="o">.</span><span class="n">map</span><span class="p" data-group-id="6117619246-14">(</span><span class="o">&amp;</span><span class="p" data-group-id="6117619246-15">(</span><span class="ni">&amp;1</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p" data-group-id="6117619246-15">)</span><span class="p" data-group-id="6117619246-14">)</span><span class="w">
    </span><span class="k" data-group-id="6117619246-11">end</span><span class="w">
  </span><span class="k" data-group-id="6117619246-10">end</span><span class="w">

  </span><span class="n">test</span><span class="w"> </span><span class="s">&quot;Optimizer of |&gt; for Enum.map&quot;</span><span class="w"> </span><span class="k" data-group-id="6117619246-16">do</span><span class="w">
    </span><span class="n">arg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p" data-group-id="6117619246-17">[</span><span class="mi">10000</span><span class="p" data-group-id="6117619246-17">]</span><span class="w">
    </span><span class="n">task1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Task</span><span class="o">.</span><span class="n">async</span><span class="p" data-group-id="6117619246-18">(</span><span class="k" data-group-id="6117619246-19">fn</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="nc">:timer</span><span class="o">.</span><span class="n">tc</span><span class="p" data-group-id="6117619246-20">(</span><span class="o">&amp;</span><span class="n">fun1</span><span class="o">/</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">arg</span><span class="p" data-group-id="6117619246-20">)</span><span class="w"> </span><span class="k" data-group-id="6117619246-19">end</span><span class="p" data-group-id="6117619246-18">)</span><span class="w">
    </span><span class="n">task2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Task</span><span class="o">.</span><span class="n">async</span><span class="p" data-group-id="6117619246-21">(</span><span class="k" data-group-id="6117619246-22">fn</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="nc">:timer</span><span class="o">.</span><span class="n">tc</span><span class="p" data-group-id="6117619246-23">(</span><span class="o">&amp;</span><span class="n">fun2</span><span class="o">/</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">arg</span><span class="p" data-group-id="6117619246-23">)</span><span class="w"> </span><span class="k" data-group-id="6117619246-22">end</span><span class="p" data-group-id="6117619246-21">)</span><span class="w">

    </span><span class="p" data-group-id="6117619246-24">[</span><span class="p" data-group-id="6117619246-25">{</span><span class="n">t</span><span class="p">,</span><span class="w"> </span><span class="n">v</span><span class="p" data-group-id="6117619246-25">}</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="6117619246-26">{</span><span class="n">t1</span><span class="p">,</span><span class="w"> </span><span class="n">v1</span><span class="p" data-group-id="6117619246-26">}</span><span class="p" data-group-id="6117619246-24">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Task</span><span class="o">.</span><span class="n">await_many</span><span class="p" data-group-id="6117619246-27">(</span><span class="p" data-group-id="6117619246-28">[</span><span class="n">task1</span><span class="p">,</span><span class="w"> </span><span class="n">task2</span><span class="p" data-group-id="6117619246-28">]</span><span class="p">,</span><span class="w"> </span><span class="mi">60_000</span><span class="p" data-group-id="6117619246-27">)</span><span class="w">
    </span><span class="nc">IO</span><span class="o">.</span><span class="n">puts</span><span class="p" data-group-id="6117619246-29">(</span><span class="s">&quot;speed up </span><span class="si" data-group-id="6117619246-30">#{</span><span class="p" data-group-id="6117619246-31">(</span><span class="n">t</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">t1</span><span class="p" data-group-id="6117619246-31">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">t1</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">100</span><span class="si" data-group-id="6117619246-30">}</span><span class="s">%.&quot;</span><span class="p" data-group-id="6117619246-29">)</span><span class="w">
    </span><span class="n">assert</span><span class="w"> </span><span class="n">v</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">v1</span><span class="w">
  </span><span class="k" data-group-id="6117619246-16">end</span><span class="w">
</span><span class="k" data-group-id="6117619246-1">end</span></code></pre><p>最初, 我是使用 LiveBoook 来探索 Elixir 的.
在 LiveBook 中, 运行这个测试的后, 其中有一次, 代码的输出是这样的:</p><blockquote><p>speed up -1.5641347109939043%.</p></blockquote><p>这就尴尬了😒. 优化后的代码不是提速了, 反而变慢了 1.5 个百分点. 可是为什么会这样啊?</p><p>这是因为 LiveBook 代码 Cell 本质上是解释执行的, 就像不能以代码在 IEx
中的运行时间来衡量代码的效率一样, 我们也不能用 LiveBook 的 Cell 
中代码的执行时间来衡量代码的效率.</p><p>这个优化的实现, 其实并不是那么的复杂, 为什么 Elixir 编译器不这样做呢?
这里有两个原因. 第一原因, 就是 Elixir 标准库中有 <a href="https://hexdocs.pm/elixir/Stream.html"><code class="inline">Stream</code></a> 模块,
文档中, 明确提到 <code class="inline">Stream.map</code> 会组合函数的. 
也就是说, Elixir 是以 <code class="inline">Stream.map</code> 来完成函数组合的工作的.</p><p>对于上面的组合代码, 使用 <a href="https://hexdocs.pm/elixir/Stream.html"><code class="inline">Stream</code></a> 替换了 <a href="https://hexdocs.pm/elixir/Enum.html"><code class="inline">Enum</code></a>, 就获得了相同的结果.</p><pre><code class="makeup elixir" translate="no"><span class="mi">1</span><span class="o">..</span><span class="mi">5</span><span class="w">
</span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Stream</span><span class="o">.</span><span class="n">map</span><span class="p" data-group-id="8907482693-1">(</span><span class="n">add_one</span><span class="p" data-group-id="8907482693-1">)</span><span class="w">
</span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Stream</span><span class="o">.</span><span class="n">map</span><span class="p" data-group-id="8907482693-2">(</span><span class="n">sub_one</span><span class="p" data-group-id="8907482693-2">)</span><span class="w">
</span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Enum</span><span class="o">.</span><span class="n">to_list</span><span class="p" data-group-id="8907482693-3">(</span><span class="p" data-group-id="8907482693-3">)</span><span class="w">
</span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">IO</span><span class="o">.</span><span class="n">inspect</span><span class="p" data-group-id="8907482693-4">(</span><span class="ss">label</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;result of map chain&quot;</span><span class="p" data-group-id="8907482693-4">)</span></code></pre><p>所以, 当我看到测试在 LiveBook 效率没有提升, 甚至还下降的时候,
我一度怀疑, 自己是不是解决了一个错误的问题?</p><p>答案是: 不是的. 这个工作依旧是有意义的.</p><p>就像上面展示的那样, 理论上绝对不有应该效率下降的优化后的代码, 测试的时候, 
有时居然会下降 1.5%. 那么 Stream 版本呢? 会比我们的的代码效率更高吗?
总是优与多个 <code class="inline">Enum.map</code> 串联吗?</p><pre><code class="makeup elixir" translate="no"><span class="kd">defmodule</span><span class="w"> </span><span class="nc">BenchmarkStreamTest</span><span class="w"> </span><span class="k" data-group-id="1573493331-1">do</span><span class="w">
  </span><span class="kn">use</span><span class="w"> </span><span class="nc">ExUnit.Case</span><span class="p">,</span><span class="w"> </span><span class="ss">async</span><span class="p">:</span><span class="w"> </span><span class="no">true</span><span class="w">
  </span><span class="na">@range</span><span class="w"> </span><span class="mi">1</span><span class="o">..</span><span class="mi">1000</span><span class="w">

  </span><span class="kd">def</span><span class="w"> </span><span class="nf">fun1</span><span class="p" data-group-id="1573493331-2">(</span><span class="n">up</span><span class="w"> </span><span class="o">\\</span><span class="w"> </span><span class="mi">10</span><span class="p" data-group-id="1573493331-2">)</span><span class="w"> </span><span class="k" data-group-id="1573493331-3">do</span><span class="w">
    </span><span class="k">for</span><span class="w"> </span><span class="bp">_</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="mi">1</span><span class="o">..</span><span class="n">up</span><span class="w"> </span><span class="k" data-group-id="1573493331-4">do</span><span class="w">
      </span><span class="na">@range</span><span class="w">
      </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Enum</span><span class="o">.</span><span class="n">map</span><span class="p" data-group-id="1573493331-5">(</span><span class="o">&amp;</span><span class="p" data-group-id="1573493331-6">(</span><span class="ni">&amp;1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p" data-group-id="1573493331-6">)</span><span class="p" data-group-id="1573493331-5">)</span><span class="w">
      </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Enum</span><span class="o">.</span><span class="n">map</span><span class="p" data-group-id="1573493331-7">(</span><span class="o">&amp;</span><span class="p" data-group-id="1573493331-8">(</span><span class="ni">&amp;1</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p" data-group-id="1573493331-8">)</span><span class="p" data-group-id="1573493331-7">)</span><span class="w">
    </span><span class="k" data-group-id="1573493331-4">end</span><span class="w">
  </span><span class="k" data-group-id="1573493331-3">end</span><span class="w">

  </span><span class="kd">def</span><span class="w"> </span><span class="nf">fun2</span><span class="p" data-group-id="1573493331-9">(</span><span class="n">up</span><span class="w"> </span><span class="o">\\</span><span class="w"> </span><span class="mi">10</span><span class="p" data-group-id="1573493331-9">)</span><span class="w"> </span><span class="k" data-group-id="1573493331-10">do</span><span class="w">
    </span><span class="k">for</span><span class="w"> </span><span class="bp">_</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="mi">1</span><span class="o">..</span><span class="n">up</span><span class="w"> </span><span class="k" data-group-id="1573493331-11">do</span><span class="w">
      </span><span class="na">@range</span><span class="w">
      </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Stream</span><span class="o">.</span><span class="n">map</span><span class="p" data-group-id="1573493331-12">(</span><span class="o">&amp;</span><span class="p" data-group-id="1573493331-13">(</span><span class="ni">&amp;1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p" data-group-id="1573493331-13">)</span><span class="p" data-group-id="1573493331-12">)</span><span class="w">
      </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Stream</span><span class="o">.</span><span class="n">map</span><span class="p" data-group-id="1573493331-14">(</span><span class="o">&amp;</span><span class="p" data-group-id="1573493331-15">(</span><span class="ni">&amp;1</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p" data-group-id="1573493331-15">)</span><span class="p" data-group-id="1573493331-14">)</span><span class="w">
      </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Enum</span><span class="o">.</span><span class="n">to_list</span><span class="p" data-group-id="1573493331-16">(</span><span class="p" data-group-id="1573493331-16">)</span><span class="w">
    </span><span class="k" data-group-id="1573493331-11">end</span><span class="w">
  </span><span class="k" data-group-id="1573493331-10">end</span><span class="w">

  </span><span class="n">test</span><span class="w"> </span><span class="s">&quot;Enum.map vs Stream.map&quot;</span><span class="w"> </span><span class="k" data-group-id="1573493331-17">do</span><span class="w">
    </span><span class="n">arg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p" data-group-id="1573493331-18">[</span><span class="mi">10000</span><span class="p" data-group-id="1573493331-18">]</span><span class="w">
    </span><span class="n">task1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Task</span><span class="o">.</span><span class="n">async</span><span class="p" data-group-id="1573493331-19">(</span><span class="k" data-group-id="1573493331-20">fn</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="nc">:timer</span><span class="o">.</span><span class="n">tc</span><span class="p" data-group-id="1573493331-21">(</span><span class="o">&amp;</span><span class="n">fun1</span><span class="o">/</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">arg</span><span class="p" data-group-id="1573493331-21">)</span><span class="w"> </span><span class="k" data-group-id="1573493331-20">end</span><span class="p" data-group-id="1573493331-19">)</span><span class="w">
    </span><span class="n">task2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Task</span><span class="o">.</span><span class="n">async</span><span class="p" data-group-id="1573493331-22">(</span><span class="k" data-group-id="1573493331-23">fn</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="nc">:timer</span><span class="o">.</span><span class="n">tc</span><span class="p" data-group-id="1573493331-24">(</span><span class="o">&amp;</span><span class="n">fun2</span><span class="o">/</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">arg</span><span class="p" data-group-id="1573493331-24">)</span><span class="w"> </span><span class="k" data-group-id="1573493331-23">end</span><span class="p" data-group-id="1573493331-22">)</span><span class="w">

    </span><span class="p" data-group-id="1573493331-25">[</span><span class="p" data-group-id="1573493331-26">{</span><span class="n">t</span><span class="p">,</span><span class="w"> </span><span class="n">v</span><span class="p" data-group-id="1573493331-26">}</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="1573493331-27">{</span><span class="n">t1</span><span class="p">,</span><span class="w"> </span><span class="n">v1</span><span class="p" data-group-id="1573493331-27">}</span><span class="p" data-group-id="1573493331-25">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Task</span><span class="o">.</span><span class="n">await_many</span><span class="p" data-group-id="1573493331-28">(</span><span class="p" data-group-id="1573493331-29">[</span><span class="n">task1</span><span class="p">,</span><span class="w"> </span><span class="n">task2</span><span class="p" data-group-id="1573493331-29">]</span><span class="p">,</span><span class="w"> </span><span class="mi">60_000</span><span class="p" data-group-id="1573493331-28">)</span><span class="w">
    </span><span class="nc">IO</span><span class="o">.</span><span class="n">puts</span><span class="p" data-group-id="1573493331-30">(</span><span class="s">&quot;speed up </span><span class="si" data-group-id="1573493331-31">#{</span><span class="p" data-group-id="1573493331-32">(</span><span class="n">t</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">t1</span><span class="p" data-group-id="1573493331-32">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">t</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">100</span><span class="si" data-group-id="1573493331-31">}</span><span class="s">%.&quot;</span><span class="p" data-group-id="1573493331-30">)</span><span class="w">
    </span><span class="n">assert</span><span class="w"> </span><span class="n">v</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">v1</span><span class="w">
  </span><span class="k" data-group-id="1573493331-17">end</span><span class="w">
</span><span class="k" data-group-id="1573493331-1">end</span></code></pre><p>这次在 LiveBook 中运行的结果更加糟糕, 和 <code class="inline">Enum.map</code> 相比,
<code class="inline">Stream.map</code> 版本的代码效率下降了 100% 还多.</p><p>1%~2% 的效率差异我们还能解释为代码执行过程中偶然因素带来的,
但 <code class="inline">Stream.map</code> 和 <code class="inline">Enum.map</code> 的巨大差异绝对不能归结为偶然.
<code class="inline">Stream.map</code> 虽然完成了的函数的组合, 但是却并没有提升效率.</p><p>Elixir 的 <code class="inline">Enum.map</code> 不组合函数的第二个原因是, Elixir 不是一个纯的函数编程语言.
传递给 <code class="inline">Enum.map</code> 的函数不保证没有副作用的. 而理论上来说,
只有当传递给 <code class="inline">Enum.map</code> 的函数是纯函数的时候, 才可以组合函数.
但是要在编译时判断一个函数中是否有副作用, 这基本上做不到,
所以 Elixir 标准库中的管道操作符 <code class="inline">|&gt;</code> 并不对 <code class="inline">Enum.map</code> 做函数的组合.</p><p>我们的优化器, 忽略了函数中的副作用而强行对函数做了组合.
把优化器做测试的代码, 保存到文件中, 使用 <a href="https://hexdocs.pm/mix/Mix.Tasks.Test.html"><code class="inline">mix test</code></a> 命令来重新测试, 
这次发现, 使用优化器的代码, 效率有了 30%~40% 的效率提升.</p><p>手动组合功能一样的函数, 其效率和使用这里定义的优化器的一样.
在不增加工作量的情况下, 效率提升 30%~40%, 从这个角度来看, 这个工作还是算有意义吧?</p>
<div class="bottom-actions">
  <div class="bottom-actions-item">

      <a href="ch06-async_programe.html" class="bottom-actions-button" rel="prev">
        <span class="subheader">
          ← Previous Page
        </span>
        <span class="title">
第六章 异步编程
        </span>
      </a>

  </div>
  <div class="bottom-actions-item">

      <a href="ch08-error_handle.html" class="bottom-actions-button" rel="next">
        <span class="subheader">
          Next Page →
        </span>
        <span class="title">
第八章 错误处理
        </span>
      </a>

  </div>
</div>

      <footer class="footer">

        <p>
          Built using
          <a href="https://github.com/elixir-lang/ex_doc" title="ExDoc" target="_blank" rel="help noopener" translate="no">ExDoc</a> (v0.28.4) for the

            <a href="https://elixir-lang.org" title="Elixir" target="_blank" translate="no">Elixir programming language</a>

        </p>
      </footer>
    </div>
  </div>
</section>
</div>


  </body>
</html>
