<!DOCTYPE html>
<html lang="cn-zh">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="generator" content="ExDoc v0.28.4">
    <meta name="project" content="the_corner_of_elixir v0.1.0">

      <meta name="author" content="Keep Zen">

    <title>第十二章 冷知识 — the_corner_of_elixir v0.1.0</title>
    <link rel="stylesheet" href="dist/elixir-b6f1ed5df9b1d42a7309.css" />

    <script src="dist/sidebar_items-4fa6fad7f9.js"></script>

      <script src="docs_config.js"></script>

    <script async src="dist/app-bd1cb213813bf4825aa2.js"></script>

<style>
  a.footnote {
    vertical-align: super;
  }
  a.reversefootnote {
    display: inline-block;
    text-indent: -9999px;
    line-height: 0;
  }
  a.reversefootnote:after {
    content: '↩'; /* or any other text you want */
    text-indent: 0;
    display: block;
    line-height: initial;
  }
</style>

<script>
MathJax = {
tex: {
inlineMath: [['$', '$']]
}
};
</script>
<script id="MathJax-script" async
src="./assets/tex-chtml.js">
</script>

<script src="assets/mermaid.min.js"></script>
<script>
document.addEventListener("DOMContentLoaded", function () {
mermaid.initialize({ startOnLoad: false });
let id = 0;
for (const codeEl of document.querySelectorAll("pre code.mermaid")) {
  const preEl = codeEl.parentElement;
  const graphDefinition = codeEl.textContent;
  const graphEl = document.createElement("div");
  const graphId = "mermaid-graph-" + id++;
  mermaid.render(graphId, graphDefinition, function (svgSource, bindListeners) {
    graphEl.innerHTML = svgSource;
    bindListeners && bindListeners(graphEl);
    preEl.insertAdjacentElement("afterend", graphEl);
    preEl.remove();
  });
}
});
</script>

  </head>
  <body data-type="extras">
    <script>

      try {
        var settings = JSON.parse(localStorage.getItem('ex_doc:settings') || '{}');

        if (settings.theme === 'dark' ||
           ((settings.theme === 'system' || settings.theme == null) &&
             window.matchMedia('(prefers-color-scheme: dark)').matches)
           ) {
          document.body.classList.add('dark')
        }
      } catch (error) { }
    </script>

<div class="main">


<section class="sidebar">
  <button class="sidebar-button sidebar-toggle" aria-label="toggle sidebar">
    <i class="ri-menu-line ri-lg" title="Collapse/expand sidebar"></i>
  </button>

  <form class="sidebar-search" action="search.html">
    <button type="submit" class="search-button" aria-label="Submit Search">
      <i class="ri-search-2-line" aria-hidden="true" title="Submit search"></i>
    </button>
    <button type="button" tabindex="-1" class="search-close-button" aria-label="Cancel Search">
      <i class="ri-close-line ri-lg" aria-hidden="true" title="Cancel search"></i>
    </button>
    <label class="search-label">
      <p class="sr-only">Search</p>
      <input name="q" type="text" class="search-input" placeholder="Search..." aria-label="Input your search terms" autocomplete="off" />
    </label>
  </form>

  <div class="autocomplete">
    <div class="autocomplete-results">
    </div>
  </div>

  <div class="sidebar-header">

    <div class="sidebar-projectDetails">
      <a href="keepzen.github.io/the-corner-of-elixir" class="sidebar-projectName" translate="no">
the_corner_of_elixir
      </a>
      <strong class="sidebar-projectVersion" translate="no">
        v0.1.0
      </strong>
    </div>
    <ul class="sidebar-listNav">
      <li><a id="extras-list-link" href="#full-list">Pages</a></li>


    </ul>
  </div>

  <div class="gradient"></div>
  <ul id="full-list" class="sidebar-fullList"></ul>
</section>

<section class="content">
  <output role="status" id="toast"></output>
  <div class="content-outer">
    <div id="content" class="content-inner">

<h1>
<button class="settings display-settings">
  <i class="ri-settings-3-line"></i>
  <span class="sr-only">Settings</span>
</button>


    <a href="https://github.com/keepzen/the-corner-of-elixir/blob/main/cn/chx.cold_knowledge.md#L1" title="View Source" class="view-source" rel="help">
      <i class="ri-code-s-slash-line" aria-hidden="true"></i>
      <span class="sr-only">View Source</span>
    </a>

  <span>第十二章 冷知识</span>
</h1>

<h2 id="函数参数个数" class="section-heading">
  <a href="#函数参数个数" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i>
  <p class="sr-only">函数参数个数</p>
  </a>
  函数参数个数
</h2>
<p>在阅读 Elixir 文档的
≪<a href="https://hexdocs.pm/elixir/typespecs.html#built-in-types">类型规范•内建的类型</a>≫
小节中, 我发现了一个以前没有注意到的知识: Elixir 中函数参数个数的限制.</p><blockquote><p>arity() 定义为 <code class="inline">0..255</code>.</p></blockquote><p>这是说, 我们的函数参数个数最多 255个吗? 要写一个有 255 个变量的函数,
这还真的是个体力活. 但是作为程序员, 对于这种重复性体力劳动,
当然要用编程的方式来完成了.
Elixir 提供了 <a href="https://hexdocs.pm/elixir/Code.html#compile_string/1"><code class="inline">Code.compile_string/1</code></a> 和 <a href="https://hexdocs.pm/elixir/Code.html#eval_string/1"><code class="inline">Code.eval_string/1</code></a> 函数,
可以把他们看作是 Elixir 语言为我们提供的编译器和解释器的 API.
我们可以使用这两个函数编译或解释执行对应 Elixir 代码.</p><p>通过调整生成的函数参数的个数, 可以找到函数参数个数的上限的设定.</p><pre><code class="makeup elixir" translate="no"><span class="kd">defmodule</span><span class="w"> </span><span class="nc">Explore.Arity</span><span class="w"> </span><span class="k" data-group-id="8216271915-1">do</span><span class="w">
  </span><span class="kd">defp</span><span class="w"> </span><span class="nf">generate_code</span><span class="p" data-group-id="8216271915-2">(</span><span class="n">arity</span><span class="p">,</span><span class="w"> </span><span class="n">name_fun?</span><span class="p" data-group-id="8216271915-2">)</span><span class="w"> </span><span class="k" data-group-id="8216271915-3">do</span><span class="w">
    </span><span class="n">params_list</span><span class="w"> </span><span class="o">=</span><span class="w">
      </span><span class="mi">1</span><span class="o">..</span><span class="n">arity</span><span class="w">
      </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Enum</span><span class="o">.</span><span class="n">map</span><span class="p" data-group-id="8216271915-4">(</span><span class="o">&amp;</span><span class="s">&quot;p</span><span class="si" data-group-id="8216271915-5">#{</span><span class="ni">&amp;1</span><span class="si" data-group-id="8216271915-5">}</span><span class="s">&quot;</span><span class="p" data-group-id="8216271915-4">)</span><span class="w">

    </span><span class="n">params_src</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Enum</span><span class="o">.</span><span class="n">join</span><span class="p" data-group-id="8216271915-6">(</span><span class="n">params_list</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;,&quot;</span><span class="p" data-group-id="8216271915-6">)</span><span class="w">
    </span><span class="n">body_src</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Enum</span><span class="o">.</span><span class="n">join</span><span class="p" data-group-id="8216271915-7">(</span><span class="n">params_list</span><span class="p">,</span><span class="w"> </span><span class="s">&quot; + &quot;</span><span class="p" data-group-id="8216271915-7">)</span><span class="w">

    </span><span class="k">if</span><span class="w"> </span><span class="n">name_fun?</span><span class="w"> </span><span class="k" data-group-id="8216271915-8">do</span><span class="w">
      </span><span class="s">&quot;&quot;&quot;
      defmodule A do
        def test(</span><span class="si" data-group-id="8216271915-9">#{</span><span class="n">params_src</span><span class="si" data-group-id="8216271915-9">}</span><span class="s">) do
          </span><span class="si" data-group-id="8216271915-10">#{</span><span class="n">body_src</span><span class="si" data-group-id="8216271915-10">}</span><span class="s">
        end
      end
      &quot;&quot;&quot;</span><span class="w">
    </span><span class="k" data-group-id="8216271915-8">else</span><span class="w">
      </span><span class="s">&quot;fn </span><span class="si" data-group-id="8216271915-11">#{</span><span class="n">params_src</span><span class="si" data-group-id="8216271915-11">}</span><span class="s"> -&gt; </span><span class="si" data-group-id="8216271915-12">#{</span><span class="n">body_src</span><span class="si" data-group-id="8216271915-12">}</span><span class="s"> end&quot;</span><span class="w">
    </span><span class="k" data-group-id="8216271915-8">end</span><span class="w">
  </span><span class="k" data-group-id="8216271915-3">end</span><span class="w">

  </span><span class="na">@default_opt</span><span class="w"> </span><span class="p" data-group-id="8216271915-13">[</span><span class="ss">fun_named?</span><span class="p">:</span><span class="w"> </span><span class="no">false</span><span class="p">,</span><span class="w"> </span><span class="ss">compiled?</span><span class="p">:</span><span class="w"> </span><span class="no">true</span><span class="p" data-group-id="8216271915-13">]</span><span class="w">
  </span><span class="kd">def</span><span class="w"> </span><span class="nf">check</span><span class="p" data-group-id="8216271915-14">(</span><span class="n">arity</span><span class="p">,</span><span class="w"> </span><span class="n">opt</span><span class="w"> </span><span class="o">\\</span><span class="w"> </span><span class="p" data-group-id="8216271915-15">[</span><span class="p" data-group-id="8216271915-15">]</span><span class="p" data-group-id="8216271915-14">)</span><span class="w"> </span><span class="k" data-group-id="8216271915-16">do</span><span class="w">
    </span><span class="n">opt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Keyword</span><span class="o">.</span><span class="n">merge</span><span class="p" data-group-id="8216271915-17">(</span><span class="na">@default_opt</span><span class="p">,</span><span class="w"> </span><span class="n">opt</span><span class="p" data-group-id="8216271915-17">)</span><span class="w">

    </span><span class="n">src</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">generate_code</span><span class="p" data-group-id="8216271915-18">(</span><span class="n">arity</span><span class="p">,</span><span class="w"> </span><span class="n">opt</span><span class="p" data-group-id="8216271915-19">[</span><span class="ss">:fun_named?</span><span class="p" data-group-id="8216271915-19">]</span><span class="p" data-group-id="8216271915-18">)</span><span class="w">

    </span><span class="k">if</span><span class="w"> </span><span class="n">opt</span><span class="p" data-group-id="8216271915-20">[</span><span class="ss">:compiled?</span><span class="p" data-group-id="8216271915-20">]</span><span class="w"> </span><span class="k" data-group-id="8216271915-21">do</span><span class="w">
      </span><span class="nc">Code</span><span class="o">.</span><span class="n">compile_string</span><span class="p" data-group-id="8216271915-22">(</span><span class="n">src</span><span class="p" data-group-id="8216271915-22">)</span><span class="w">
    </span><span class="k" data-group-id="8216271915-21">else</span><span class="w">
      </span><span class="nc">Code</span><span class="o">.</span><span class="n">eval_string</span><span class="p" data-group-id="8216271915-23">(</span><span class="n">src</span><span class="p" data-group-id="8216271915-23">)</span><span class="w">
    </span><span class="k" data-group-id="8216271915-21">end</span><span class="w">
  </span><span class="k" data-group-id="8216271915-16">rescue</span><span class="w">
    </span><span class="n">v</span><span class="w"> </span><span class="o">-&gt;</span><span class="w">
      </span><span class="n">error_tip</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">opt</span><span class="p" data-group-id="8216271915-24">[</span><span class="ss">:compiled?</span><span class="p" data-group-id="8216271915-24">]</span><span class="p">,</span><span class="w"> </span><span class="ss">do</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;compile error&quot;</span><span class="p">,</span><span class="w"> </span><span class="ss">else</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;praser error&quot;</span><span class="w">
      </span><span class="nc">IO</span><span class="o">.</span><span class="n">inspect</span><span class="p" data-group-id="8216271915-25">(</span><span class="n">v</span><span class="p">,</span><span class="w"> </span><span class="ss">label</span><span class="p">:</span><span class="w"> </span><span class="n">error_tip</span><span class="p" data-group-id="8216271915-25">)</span><span class="w">
      </span><span class="ss">:bad</span><span class="w">
  </span><span class="k" data-group-id="8216271915-16">else</span><span class="w">
    </span><span class="n">v</span><span class="w"> </span><span class="o">-&gt;</span><span class="w">
      </span><span class="nc">IO</span><span class="o">.</span><span class="n">inspect</span><span class="p" data-group-id="8216271915-26">(</span><span class="n">v</span><span class="p">,</span><span class="w"> </span><span class="ss">label</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;check done&quot;</span><span class="p" data-group-id="8216271915-26">)</span><span class="w">
      </span><span class="ss">:ok</span><span class="w">
  </span><span class="k" data-group-id="8216271915-16">end</span><span class="w">
</span><span class="k" data-group-id="8216271915-1">end</span></code></pre><p>让我们用单元测试功能来完成我们探索. 用代码, 能更清楚地表达我的意图.</p><pre><code class="makeup elixir" translate="no"><span class="nc">ExUnit</span><span class="o">.</span><span class="n">start</span><span class="p" data-group-id="4810276967-1">(</span><span class="ss">auto_run</span><span class="p">:</span><span class="w"> </span><span class="no">false</span><span class="p" data-group-id="4810276967-1">)</span><span class="w">

</span><span class="kd">defmodule</span><span class="w"> </span><span class="nc">ArityTest</span><span class="w"> </span><span class="k" data-group-id="4810276967-2">do</span><span class="w">
  </span><span class="kn">use</span><span class="w"> </span><span class="nc">ExUnit.Case</span><span class="p">,</span><span class="w"> </span><span class="ss">async</span><span class="p">:</span><span class="w"> </span><span class="no">true</span><span class="w">
  </span><span class="kn">alias</span><span class="w"> </span><span class="nc">Explore.Arity</span><span class="w">

  </span><span class="n">test</span><span class="w"> </span><span class="s">&quot;the uplimit of arity for anonymous function in complier &quot;</span><span class="w"> </span><span class="k" data-group-id="4810276967-3">do</span><span class="w">
    </span><span class="n">assert</span><span class="w"> </span><span class="nc">Arity</span><span class="o">.</span><span class="n">check</span><span class="p" data-group-id="4810276967-4">(</span><span class="mi">255</span><span class="p" data-group-id="4810276967-4">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="ss">:ok</span><span class="w">
    </span><span class="n">assert</span><span class="w"> </span><span class="nc">Arity</span><span class="o">.</span><span class="n">check</span><span class="p" data-group-id="4810276967-5">(</span><span class="mi">256</span><span class="p" data-group-id="4810276967-5">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="ss">:bad</span><span class="w">
    </span><span class="nc">IO</span><span class="o">.</span><span class="n">puts</span><span class="p" data-group-id="4810276967-6">(</span><span class="s">&quot;&quot;</span><span class="p" data-group-id="4810276967-6">)</span><span class="w">
  </span><span class="k" data-group-id="4810276967-3">end</span><span class="w">

  </span><span class="n">test</span><span class="w"> </span><span class="s">&quot;the uplimit of arity for named function in complier &quot;</span><span class="w"> </span><span class="k" data-group-id="4810276967-7">do</span><span class="w">
    </span><span class="n">assert</span><span class="w"> </span><span class="nc">Arity</span><span class="o">.</span><span class="n">check</span><span class="p" data-group-id="4810276967-8">(</span><span class="mi">255</span><span class="p">,</span><span class="w"> </span><span class="ss">fun_named?</span><span class="p">:</span><span class="w"> </span><span class="no">true</span><span class="p" data-group-id="4810276967-8">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="ss">:ok</span><span class="w">
    </span><span class="n">assert</span><span class="w"> </span><span class="mi">1</span><span class="o">..</span><span class="mi">255</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Enum</span><span class="o">.</span><span class="n">sum</span><span class="p" data-group-id="4810276967-9">(</span><span class="p" data-group-id="4810276967-9">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">apply</span><span class="p" data-group-id="4810276967-10">(</span><span class="nc">A</span><span class="p">,</span><span class="w"> </span><span class="ss">:test</span><span class="p">,</span><span class="w"> </span><span class="nc">Enum</span><span class="o">.</span><span class="n">to_list</span><span class="p" data-group-id="4810276967-11">(</span><span class="mi">1</span><span class="o">..</span><span class="mi">255</span><span class="p" data-group-id="4810276967-11">)</span><span class="p" data-group-id="4810276967-10">)</span><span class="w">

    </span><span class="n">assert</span><span class="w"> </span><span class="nc">Arity</span><span class="o">.</span><span class="n">check</span><span class="p" data-group-id="4810276967-12">(</span><span class="mi">256</span><span class="p">,</span><span class="w"> </span><span class="ss">fun_named?</span><span class="p">:</span><span class="w"> </span><span class="no">true</span><span class="p" data-group-id="4810276967-12">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="ss">:ok</span><span class="w">
    </span><span class="n">assert_raise</span><span class="w"> </span><span class="nc">UndefinedFunctionError</span><span class="p">,</span><span class="w"> </span><span class="k" data-group-id="4810276967-13">fn</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">apply</span><span class="p" data-group-id="4810276967-14">(</span><span class="nc">A</span><span class="p">,</span><span class="w"> </span><span class="ss">:test</span><span class="p">,</span><span class="w"> </span><span class="nc">Enum</span><span class="o">.</span><span class="n">to_list</span><span class="p" data-group-id="4810276967-15">(</span><span class="mi">1</span><span class="o">..</span><span class="mi">256</span><span class="p" data-group-id="4810276967-15">)</span><span class="p" data-group-id="4810276967-14">)</span><span class="w"> </span><span class="k" data-group-id="4810276967-13">end</span><span class="w">
    </span><span class="nc">IO</span><span class="o">.</span><span class="n">puts</span><span class="p" data-group-id="4810276967-16">(</span><span class="s">&quot;&quot;</span><span class="p" data-group-id="4810276967-16">)</span><span class="w">
  </span><span class="k" data-group-id="4810276967-7">end</span><span class="w">

  </span><span class="n">test</span><span class="w"> </span><span class="s">&quot;the uplimit of arity for anonymous function in parser&quot;</span><span class="w"> </span><span class="k" data-group-id="4810276967-17">do</span><span class="w">
    </span><span class="n">assert</span><span class="w"> </span><span class="nc">Arity</span><span class="o">.</span><span class="n">check</span><span class="p" data-group-id="4810276967-18">(</span><span class="mi">20</span><span class="p">,</span><span class="w"> </span><span class="ss">compiled?</span><span class="p">:</span><span class="w"> </span><span class="no">false</span><span class="p" data-group-id="4810276967-18">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="ss">:ok</span><span class="w">
    </span><span class="n">assert</span><span class="w"> </span><span class="nc">Arity</span><span class="o">.</span><span class="n">check</span><span class="p" data-group-id="4810276967-19">(</span><span class="mi">21</span><span class="p">,</span><span class="w"> </span><span class="ss">compiled?</span><span class="p">:</span><span class="w"> </span><span class="no">false</span><span class="p" data-group-id="4810276967-19">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="ss">:bad</span><span class="w">
    </span><span class="nc">IO</span><span class="o">.</span><span class="n">puts</span><span class="p" data-group-id="4810276967-20">(</span><span class="s">&quot;&quot;</span><span class="p" data-group-id="4810276967-20">)</span><span class="w">
  </span><span class="k" data-group-id="4810276967-17">end</span><span class="w">

  </span><span class="n">test</span><span class="w"> </span><span class="s">&quot;the uplimit of arity for named function in parser&quot;</span><span class="w"> </span><span class="k" data-group-id="4810276967-21">do</span><span class="w">
    </span><span class="n">assert</span><span class="w"> </span><span class="nc">Arity</span><span class="o">.</span><span class="n">check</span><span class="p" data-group-id="4810276967-22">(</span><span class="mi">20</span><span class="p">,</span><span class="w"> </span><span class="ss">fun_named?</span><span class="p">:</span><span class="w"> </span><span class="no">true</span><span class="p">,</span><span class="w"> </span><span class="ss">compiled?</span><span class="p">:</span><span class="w"> </span><span class="no">false</span><span class="p" data-group-id="4810276967-22">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="ss">:ok</span><span class="w">
    </span><span class="n">assert</span><span class="w"> </span><span class="n">apply</span><span class="p" data-group-id="4810276967-23">(</span><span class="nc">A</span><span class="p">,</span><span class="w"> </span><span class="ss">:test</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="o">..</span><span class="mi">20</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Enum</span><span class="o">.</span><span class="n">to_list</span><span class="p" data-group-id="4810276967-24">(</span><span class="p" data-group-id="4810276967-24">)</span><span class="p" data-group-id="4810276967-23">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="o">..</span><span class="mi">20</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Enum</span><span class="o">.</span><span class="n">sum</span><span class="p" data-group-id="4810276967-25">(</span><span class="p" data-group-id="4810276967-25">)</span><span class="w">

    </span><span class="n">assert</span><span class="w"> </span><span class="nc">Arity</span><span class="o">.</span><span class="n">check</span><span class="p" data-group-id="4810276967-26">(</span><span class="mi">21</span><span class="p">,</span><span class="w"> </span><span class="ss">fun_named?</span><span class="p">:</span><span class="w"> </span><span class="no">true</span><span class="p">,</span><span class="w"> </span><span class="ss">compiled?</span><span class="p">:</span><span class="w"> </span><span class="no">false</span><span class="p" data-group-id="4810276967-26">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="ss">:ok</span><span class="w">
    </span><span class="n">assert_raise</span><span class="w"> </span><span class="nc">UndefinedFunctionError</span><span class="p">,</span><span class="w"> </span><span class="k" data-group-id="4810276967-27">fn</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="nc">A</span><span class="o">.</span><span class="n">test</span><span class="p" data-group-id="4810276967-28">(</span><span class="nc">Enum</span><span class="o">.</span><span class="n">to_list</span><span class="p" data-group-id="4810276967-29">(</span><span class="mi">1</span><span class="o">..</span><span class="mi">21</span><span class="p" data-group-id="4810276967-29">)</span><span class="p" data-group-id="4810276967-28">)</span><span class="w"> </span><span class="k" data-group-id="4810276967-27">end</span><span class="w">
    </span><span class="nc">IO</span><span class="o">.</span><span class="n">puts</span><span class="p" data-group-id="4810276967-30">(</span><span class="s">&quot;&quot;</span><span class="p" data-group-id="4810276967-30">)</span><span class="w">
  </span><span class="k" data-group-id="4810276967-21">end</span><span class="w">
</span><span class="k" data-group-id="4810276967-2">end</span><span class="w">

</span><span class="nc">ExUnit</span><span class="o">.</span><span class="n">run</span><span class="p" data-group-id="4810276967-31">(</span><span class="p" data-group-id="4810276967-31">)</span></code></pre><p>通过上面的实验, 可以得出以下结论:</p><ul><li>在编译器中<ol><li>对于匿名函数, 参数个数多于 255 个, 编译器报 UndefineFuntionError</li><li>对于命名函数, 参数个数多于 255 个, 编译器并不报错, 但是调用这个函数,
运行时会产生 UndefineFuntionError</li></ol></li><li>在解析器中<ol><li>对于匿名函数, 参数个数多于 20 个, 解释器就会报 UndefinedFunctionError</li><li>对于命名函数, 参数个数多于 20 个, 解释器不会报错, 但是调用这个函数,
运行时会产生 UndefineFunctionError</li></ol></li></ul><h2 id="原子" class="section-heading">
  <a href="#原子" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i>
  <p class="sr-only">原子</p>
  </a>
  原子
</h2>
<ol><li>BEAM 中原子个数上限默认为: 1048577.</li><li>原子的内存长度是固定的. 原子占用系统一个字 (word) 长度的内存.</li><li>原子内容最长可以有 255 个字符.</li></ol><p>现在有提议对原子也做垃圾收集, 也许以后的 BEAM 实现, 原子个数上限就会被解除,
那么对于嵌入式的系统, 用原子来代替比较长的字符串可以达到节省内存的目的.</p><pre><code class="makeup elixir" translate="no"><span class="nc">ExUnit</span><span class="o">.</span><span class="n">start</span><span class="p" data-group-id="2280126339-1">(</span><span class="ss">auto_run</span><span class="p">:</span><span class="w"> </span><span class="no">false</span><span class="p" data-group-id="2280126339-1">)</span><span class="w">

</span><span class="kd">defmodule</span><span class="w"> </span><span class="nc">AtomLimitTest</span><span class="w"> </span><span class="k" data-group-id="2280126339-2">do</span><span class="w">
  </span><span class="kn">use</span><span class="w"> </span><span class="nc">ExUnit.Case</span><span class="p">,</span><span class="w"> </span><span class="ss">async</span><span class="p">:</span><span class="w"> </span><span class="no">true</span><span class="w">

  </span><span class="n">test</span><span class="w"> </span><span class="s">&quot;255 byte long atom is ok&quot;</span><span class="w"> </span><span class="k" data-group-id="2280126339-3">do</span><span class="w">
    </span><span class="n">assert</span><span class="w"> </span><span class="mi">1</span><span class="o">..</span><span class="mi">255</span><span class="w">
           </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Enum</span><span class="o">.</span><span class="n">map</span><span class="p" data-group-id="2280126339-4">(</span><span class="k" data-group-id="2280126339-5">fn</span><span class="w"> </span><span class="bp">_</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="s">&quot;1&quot;</span><span class="w"> </span><span class="k" data-group-id="2280126339-5">end</span><span class="p" data-group-id="2280126339-4">)</span><span class="w">
           </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Enum</span><span class="o">.</span><span class="n">join</span><span class="p" data-group-id="2280126339-6">(</span><span class="s">&quot;&quot;</span><span class="p" data-group-id="2280126339-6">)</span><span class="w">
           </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">String</span><span class="o">.</span><span class="n">to_atom</span><span class="p" data-group-id="2280126339-7">(</span><span class="p" data-group-id="2280126339-7">)</span><span class="w">
  </span><span class="k" data-group-id="2280126339-3">end</span><span class="w">

  </span><span class="n">test</span><span class="w"> </span><span class="s">&quot;256 byte long auto is up the atom limit&quot;</span><span class="w"> </span><span class="k" data-group-id="2280126339-8">do</span><span class="w">
    </span><span class="n">assert_raise</span><span class="w"> </span><span class="nc">SystemLimitError</span><span class="p">,</span><span class="w"> </span><span class="k" data-group-id="2280126339-9">fn</span><span class="w"> </span><span class="o">-&gt;</span><span class="w">
      </span><span class="mi">1</span><span class="o">..</span><span class="mi">256</span><span class="w">
      </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Enum</span><span class="o">.</span><span class="n">map</span><span class="p" data-group-id="2280126339-10">(</span><span class="k" data-group-id="2280126339-11">fn</span><span class="w"> </span><span class="bp">_</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="s">&quot;2&quot;</span><span class="w"> </span><span class="k" data-group-id="2280126339-11">end</span><span class="p" data-group-id="2280126339-10">)</span><span class="w">
      </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Enum</span><span class="o">.</span><span class="n">join</span><span class="p" data-group-id="2280126339-12">(</span><span class="s">&quot;&quot;</span><span class="p" data-group-id="2280126339-12">)</span><span class="w">
      </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">String</span><span class="o">.</span><span class="n">to_atom</span><span class="p" data-group-id="2280126339-13">(</span><span class="p" data-group-id="2280126339-13">)</span><span class="w">
    </span><span class="k" data-group-id="2280126339-9">end</span><span class="w">
  </span><span class="k" data-group-id="2280126339-8">end</span><span class="w">
</span><span class="k" data-group-id="2280126339-2">end</span><span class="w">

</span><span class="nc">ExUnit</span><span class="o">.</span><span class="n">run</span><span class="p" data-group-id="2280126339-14">(</span><span class="p" data-group-id="2280126339-14">)</span></code></pre><p>调用 <code class="inline">:eralng.memory(:atom_used)</code> 可以看出当前我们的系统中, 原子使用的内存.</p><h2 id="变量名的限制" class="section-heading">
  <a href="#变量名的限制" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i>
  <p class="sr-only">变量名的限制</p>
  </a>
  变量名的限制
</h2>
<p>变量名实际上也是原子, 所以变量名接受原子的限制, 也就是说变量名不能长于 255 个字符,
但是实际上, 系统对变量还有一些限制, 在 Elixir 中表示变量的原子有统一的格式:
<code class="inline">_{var_name}@1</code>. 所以, 变量名只能由 255-3 = 252 个字节长度.</p><p>我们可以通过下面的代码来得出这个结论.</p><pre><code class="makeup elixir" translate="no"><span class="n">create_var</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k" data-group-id="7117872685-1">fn</span><span class="w"> </span><span class="n">l</span><span class="w"> </span><span class="o">-&gt;</span><span class="w">
  </span><span class="mi">1</span><span class="o">..</span><span class="n">l</span><span class="w">
  </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Enum</span><span class="o">.</span><span class="n">map</span><span class="p" data-group-id="7117872685-2">(</span><span class="k" data-group-id="7117872685-3">fn</span><span class="w"> </span><span class="c">_a</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="s">&quot;l&quot;</span><span class="w"> </span><span class="k" data-group-id="7117872685-3">end</span><span class="p" data-group-id="7117872685-2">)</span><span class="w">
  </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Enum</span><span class="o">.</span><span class="n">join</span><span class="p" data-group-id="7117872685-4">(</span><span class="s">&quot;&quot;</span><span class="p" data-group-id="7117872685-4">)</span><span class="w">
</span><span class="k" data-group-id="7117872685-1">end</span><span class="w">

</span><span class="n">var</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">create_var</span><span class="o">.</span><span class="p" data-group-id="7117872685-5">(</span><span class="mi">252</span><span class="p" data-group-id="7117872685-5">)</span><span class="w">
</span><span class="n">assign</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;</span><span class="si" data-group-id="7117872685-6">#{</span><span class="n">var</span><span class="si" data-group-id="7117872685-6">}</span><span class="s"> = 1&quot;</span><span class="w">
</span><span class="p" data-group-id="7117872685-7">{</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="bp">_</span><span class="p" data-group-id="7117872685-7">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Code</span><span class="o">.</span><span class="n">eval_string</span><span class="p" data-group-id="7117872685-8">(</span><span class="n">assign</span><span class="p" data-group-id="7117872685-8">)</span><span class="w">
</span><span class="nc">IO</span><span class="o">.</span><span class="n">puts</span><span class="p" data-group-id="7117872685-9">(</span><span class="s">&quot;variable length equal 252 is ok&quot;</span><span class="p" data-group-id="7117872685-9">)</span><span class="w">
</span><span class="n">var</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">create_var</span><span class="o">.</span><span class="p" data-group-id="7117872685-10">(</span><span class="mi">253</span><span class="p" data-group-id="7117872685-10">)</span><span class="w">
</span><span class="n">assign</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;</span><span class="si" data-group-id="7117872685-11">#{</span><span class="n">var</span><span class="si" data-group-id="7117872685-11">}</span><span class="s"> = 1&quot;</span><span class="w">
</span><span class="nc">Code</span><span class="o">.</span><span class="n">eval_string</span><span class="p" data-group-id="7117872685-12">(</span><span class="n">assign</span><span class="p" data-group-id="7117872685-12">)</span></code></pre><h2 id="函数中定义模块" class="section-heading">
  <a href="#函数中定义模块" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i>
  <p class="sr-only">函数中定义模块</p>
  </a>
  函数中定义模块
</h2>
<p>可以在<a href="https://hexdocs.pm/elixir/Kernel.html#def/2"><code class="inline">def/2</code></a> 上下文中定义模块:</p><pre><code class="makeup elixir" translate="no"><span class="kd">defmodule</span><span class="w"> </span><span class="nc">EmbedModuleToFun</span><span class="w"> </span><span class="k" data-group-id="6207165919-1">do</span><span class="w">
  </span><span class="kd">def</span><span class="w"> </span><span class="nf">createFun</span><span class="p" data-group-id="6207165919-2">(</span><span class="p" data-group-id="6207165919-2">)</span><span class="w"> </span><span class="k" data-group-id="6207165919-3">do</span><span class="w">
    </span><span class="kd">defmodule</span><span class="w"> </span><span class="ss">:_</span><span class="w"> </span><span class="k" data-group-id="6207165919-4">do</span><span class="w">
      </span><span class="kd">def</span><span class="w"> </span><span class="nf">hello</span><span class="p" data-group-id="6207165919-5">(</span><span class="p" data-group-id="6207165919-5">)</span><span class="p">,</span><span class="w"> </span><span class="ss">do</span><span class="p">:</span><span class="w"> </span><span class="nc">IO</span><span class="o">.</span><span class="n">puts</span><span class="p" data-group-id="6207165919-6">(</span><span class="s">&quot;I am in </span><span class="si" data-group-id="6207165919-7">#{</span><span class="bp">__MODULE__</span><span class="si" data-group-id="6207165919-7">}</span><span class="s">, hello!&quot;</span><span class="p" data-group-id="6207165919-6">)</span><span class="w">
    </span><span class="k" data-group-id="6207165919-4">end</span><span class="w">
    </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">elem</span><span class="p" data-group-id="6207165919-8">(</span><span class="mi">1</span><span class="p" data-group-id="6207165919-8">)</span><span class="w">
  </span><span class="k" data-group-id="6207165919-3">end</span><span class="w">
</span><span class="k" data-group-id="6207165919-1">end</span><span class="w">

</span><span class="n">m</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">EmbedModuleToFun</span><span class="o">.</span><span class="n">createFun</span><span class="p" data-group-id="6207165919-9">(</span><span class="p" data-group-id="6207165919-9">)</span><span class="w">
</span><span class="n">m</span><span class="o">.</span><span class="n">hello</span><span class="p" data-group-id="6207165919-10">(</span><span class="p" data-group-id="6207165919-10">)</span></code></pre><p>这让我想起来 Java 的匿名类. Java 的早期版本中, 不支持匿名函数类型,
所以在当初要在 Java 中模拟函数式编程, 定义高阶函数的时候就不得不使用接口.
使用这些高级函数的时候, 往往用一个匿名类来实现相应的接口.</p><p>我们这里使用的方法, 和当年 Java 中使用的方法是一样的.</p><p>但是使用这个方法的时候, 还有需要注意的地方.
首先本质上, 这个方法是在运行时动态编译了新模块.
所以每次调用 <code class="inline">createFun()</code> 都会产生新的模块,
这就意味着: 1) 效率下降, 2) 如果需要在多个函数中返回模块,
必须留意为函数返回的模块取不同的名字, 以防止名称冲突.</p><p>我们可以写一个宏来解决这两个问题.</p><pre><code class="makeup elixir" translate="no"><span class="kd">defmodule</span><span class="w"> </span><span class="nc">Nest</span><span class="w"> </span><span class="k" data-group-id="6065173991-1">do</span><span class="w">
  </span><span class="kn">import</span><span class="w"> </span><span class="nc">Kernel</span><span class="p">,</span><span class="w"> </span><span class="ss">except</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="6065173991-2">[</span><span class="ss">def</span><span class="p">:</span><span class="w"> </span><span class="mi">2</span><span class="p" data-group-id="6065173991-2">]</span><span class="w">

  </span><span class="kd">defmacro</span><span class="w"> </span><span class="nf">def</span><span class="p" data-group-id="6065173991-3">(</span><span class="n">call</span><span class="p">,</span><span class="w"> </span><span class="n">exp</span><span class="p" data-group-id="6065173991-3">)</span><span class="w"> </span><span class="k" data-group-id="6065173991-4">do</span><span class="w">
    </span><span class="k">if</span><span class="w"> </span><span class="bp">__CALLER__</span><span class="o">.</span><span class="n">function</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="no">nil</span><span class="w"> </span><span class="k" data-group-id="6065173991-5">do</span><span class="w">
      </span><span class="k">raise</span><span class="w"> </span><span class="s">&quot;Nest.def must cal in def/2&quot;</span><span class="w">
    </span><span class="k" data-group-id="6065173991-5">end</span><span class="w">

    </span><span class="p" data-group-id="6065173991-6">{</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">args</span><span class="p" data-group-id="6065173991-6">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">name_and_args</span><span class="p" data-group-id="6065173991-7">(</span><span class="n">call</span><span class="p" data-group-id="6065173991-7">)</span><span class="w">
    </span><span class="n">str</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;</span><span class="si" data-group-id="6065173991-8">#{</span><span class="bp">__CALLER__</span><span class="o">.</span><span class="n">module</span><span class="si" data-group-id="6065173991-8">}</span><span class="s">.nest_</span><span class="si" data-group-id="6065173991-9">#{</span><span class="n">name</span><span class="si" data-group-id="6065173991-9">}</span><span class="s">_</span><span class="si" data-group-id="6065173991-10">#{</span><span class="n">length</span><span class="p" data-group-id="6065173991-11">(</span><span class="n">args</span><span class="p" data-group-id="6065173991-11">)</span><span class="si" data-group-id="6065173991-10">}</span><span class="s">&quot;</span><span class="w">
    </span><span class="n">module_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">String</span><span class="o">.</span><span class="n">to_atom</span><span class="p" data-group-id="6065173991-12">(</span><span class="n">str</span><span class="p" data-group-id="6065173991-12">)</span><span class="w">
    </span><span class="n">make_module</span><span class="p" data-group-id="6065173991-13">(</span><span class="n">module_name</span><span class="p">,</span><span class="w"> </span><span class="n">call</span><span class="p">,</span><span class="w"> </span><span class="n">exp</span><span class="p" data-group-id="6065173991-13">)</span><span class="w">
  </span><span class="k" data-group-id="6065173991-4">end</span><span class="w">

  </span><span class="kd">defp</span><span class="w"> </span><span class="nf">name_and_args</span><span class="p" data-group-id="6065173991-14">(</span><span class="p" data-group-id="6065173991-15">{</span><span class="ss">:when</span><span class="p">,</span><span class="w"> </span><span class="bp">_</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="6065173991-16">[</span><span class="p" data-group-id="6065173991-17">{</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="bp">_</span><span class="p">,</span><span class="w"> </span><span class="n">args</span><span class="p" data-group-id="6065173991-17">}</span><span class="p">,</span><span class="w"> </span><span class="bp">_</span><span class="p" data-group-id="6065173991-16">]</span><span class="p" data-group-id="6065173991-15">}</span><span class="p" data-group-id="6065173991-14">)</span><span class="p">,</span><span class="w"> </span><span class="ss">do</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="6065173991-18">{</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">args</span><span class="p" data-group-id="6065173991-18">}</span><span class="w">
  </span><span class="kd">defp</span><span class="w"> </span><span class="nf">name_and_args</span><span class="p" data-group-id="6065173991-19">(</span><span class="p" data-group-id="6065173991-20">{</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="bp">_</span><span class="p">,</span><span class="w"> </span><span class="n">args</span><span class="p" data-group-id="6065173991-20">}</span><span class="p" data-group-id="6065173991-19">)</span><span class="p">,</span><span class="w"> </span><span class="ss">do</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="6065173991-21">{</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">args</span><span class="p" data-group-id="6065173991-21">}</span><span class="w">

  </span><span class="kd">defp</span><span class="w"> </span><span class="nf">make_module</span><span class="p" data-group-id="6065173991-22">(</span><span class="n">module_name</span><span class="p">,</span><span class="w"> </span><span class="n">call</span><span class="p">,</span><span class="w"> </span><span class="n">exp</span><span class="p" data-group-id="6065173991-22">)</span><span class="w"> </span><span class="k" data-group-id="6065173991-23">do</span><span class="w">
    </span><span class="k">quote</span><span class="w"> </span><span class="k" data-group-id="6065173991-24">do</span><span class="w">
      </span><span class="k">if</span><span class="w"> </span><span class="nc">:code</span><span class="o">.</span><span class="n">is_loaded</span><span class="p" data-group-id="6065173991-25">(</span><span class="k">unquote</span><span class="p" data-group-id="6065173991-26">(</span><span class="n">module_name</span><span class="p" data-group-id="6065173991-26">)</span><span class="p" data-group-id="6065173991-25">)</span><span class="w"> </span><span class="k" data-group-id="6065173991-27">do</span><span class="w">
        </span><span class="k">unquote</span><span class="p" data-group-id="6065173991-28">(</span><span class="n">module_name</span><span class="p" data-group-id="6065173991-28">)</span><span class="w">
      </span><span class="k" data-group-id="6065173991-27">else</span><span class="w">
        </span><span class="kd">defmodule</span><span class="w"> </span><span class="k">unquote</span><span class="p" data-group-id="6065173991-29">(</span><span class="n">module_name</span><span class="p" data-group-id="6065173991-29">)</span><span class="w"> </span><span class="k" data-group-id="6065173991-30">do</span><span class="w">
          </span><span class="nc">IO</span><span class="o">.</span><span class="n">puts</span><span class="p" data-group-id="6065173991-31">(</span><span class="s">&quot;Compile </span><span class="si" data-group-id="6065173991-32">#{</span><span class="k">unquote</span><span class="p" data-group-id="6065173991-33">(</span><span class="n">module_name</span><span class="p" data-group-id="6065173991-33">)</span><span class="si" data-group-id="6065173991-32">}</span><span class="s">&quot;</span><span class="p" data-group-id="6065173991-31">)</span><span class="w">
          </span><span class="kd">def</span><span class="w"> </span><span class="k">unquote</span><span class="p" data-group-id="6065173991-34">(</span><span class="n">call</span><span class="p" data-group-id="6065173991-34">)</span><span class="p">,</span><span class="w"> </span><span class="k">unquote</span><span class="p" data-group-id="6065173991-35">(</span><span class="n">exp</span><span class="p" data-group-id="6065173991-35">)</span><span class="w">
        </span><span class="k" data-group-id="6065173991-30">end</span><span class="w">
        </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">elem</span><span class="p" data-group-id="6065173991-36">(</span><span class="mi">1</span><span class="p" data-group-id="6065173991-36">)</span><span class="w">
      </span><span class="k" data-group-id="6065173991-27">end</span><span class="w">
    </span><span class="k" data-group-id="6065173991-24">end</span><span class="w">
  </span><span class="k" data-group-id="6065173991-23">end</span><span class="w">
</span><span class="k" data-group-id="6065173991-1">end</span></code></pre><p>当我们在 LiveBook 中运行下面的测试代码的时候, 如果是第一次运行,
那么第 10 行的的输出之前, 控制台中应该先输出, 编译内部模块的提示:
&quot;Compile Elixir.TestNest.nest_hello_2&quot;,
但是第 11 行再次调用 <code class="inline">TestNest.hello()</code> 的时候, 不再输出模块编译的提示了,
这说明的确不是每次调用 <code class="inline">TestNest.hello()</code> 都创建新的模块.</p><pre><code class="makeup elixir" translate="no"><span class="kd">defmodule</span><span class="w"> </span><span class="nc">TestNest</span><span class="w"> </span><span class="k" data-group-id="8092344806-1">do</span><span class="w">
  </span><span class="kn">require</span><span class="w"> </span><span class="nc">Nest</span><span class="w">

  </span><span class="kd">def</span><span class="w"> </span><span class="nf">hello</span><span class="p" data-group-id="8092344806-2">(</span><span class="p" data-group-id="8092344806-2">)</span><span class="w"> </span><span class="k" data-group-id="8092344806-3">do</span><span class="w">
    </span><span class="nc">Nest</span><span class="o">.</span><span class="kd">def</span><span class="p" data-group-id="8092344806-4">(</span><span class="n">hello</span><span class="p" data-group-id="8092344806-5">(</span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p" data-group-id="8092344806-5">)</span><span class="p">,</span><span class="w"> </span><span class="ss">do</span><span class="p">:</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">b</span><span class="p" data-group-id="8092344806-4">)</span><span class="w">
  </span><span class="k" data-group-id="8092344806-3">end</span><span class="w">
</span><span class="k" data-group-id="8092344806-1">end</span><span class="w">

</span><span class="mi">3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">TestNest</span><span class="o">.</span><span class="n">hello</span><span class="p" data-group-id="8092344806-6">(</span><span class="p" data-group-id="8092344806-6">)</span><span class="o">.</span><span class="n">hello</span><span class="p" data-group-id="8092344806-7">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p" data-group-id="8092344806-7">)</span><span class="w">
</span><span class="nc">IO</span><span class="o">.</span><span class="n">puts</span><span class="p" data-group-id="8092344806-8">(</span><span class="s">&quot;-----------&quot;</span><span class="p" data-group-id="8092344806-8">)</span><span class="w">
</span><span class="mi">3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">TestNest</span><span class="o">.</span><span class="n">hello</span><span class="p" data-group-id="8092344806-9">(</span><span class="p" data-group-id="8092344806-9">)</span><span class="o">.</span><span class="n">hello</span><span class="p" data-group-id="8092344806-10">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p" data-group-id="8092344806-10">)</span></code></pre><p>在 LiveBook 中, 一旦上面的代码计算过一次此后, 再次运行的话,
因为内部模块已经被加载到系统中了, 所以控制台中, 只会有第 10 行的输出,
而不能再看到内部模块的编译提示.</p><p>这让我意识到, Erlang 中不是只有进程可以保存状态,
系统内模块的状态结合动态编译, 也可以用来表示状态.
当然了这样做有非常大的效率成本. 但作为理论探索, 不失为一个有趣的话题.</p><h2 id="进程之外的状态保持" class="section-heading">
  <a href="#进程之外的状态保持" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i>
  <p class="sr-only">进程之外的状态保持</p>
  </a>
  进程之外的状态保持
</h2>
<p>在 Erlang 和 Elixir 中, 最常用的保持状态的方法是启用一个服务进程.
但是 Erlang 的运行时系统, 自身是有状态的.
Erlang 允许在运行时, 动态生成代码.
运行时动态生成的代码改变了 Erlang 运行时的模块的状态.</p><p>如果我们把状态信息, 直接保存到模块的元数据中, 在需要改变状态的时候,
重新产生模块, 且以新的状态来设置新产生的模块, 那么外部看来,
这个模块就像一个保有状态的对象一样.</p><pre><code class="makeup elixir" translate="no"><span class="kd">defmodule</span><span class="w"> </span><span class="nc">Corner.State</span><span class="w"> </span><span class="k" data-group-id="4049195546-1">do</span><span class="w">
  </span><span class="kd">def</span><span class="w"> </span><span class="nf">create</span><span class="p" data-group-id="4049195546-2">(</span><span class="n">kv</span><span class="w"> </span><span class="o">\\</span><span class="w"> </span><span class="p" data-group-id="4049195546-3">[</span><span class="p" data-group-id="4049195546-3">]</span><span class="p" data-group-id="4049195546-2">)</span><span class="w"> </span><span class="k" data-group-id="4049195546-4">do</span><span class="w">
    </span><span class="k">if</span><span class="w"> </span><span class="nc">Keyword</span><span class="o">.</span><span class="n">keyword?</span><span class="p" data-group-id="4049195546-5">(</span><span class="n">kv</span><span class="p" data-group-id="4049195546-5">)</span><span class="w"> </span><span class="k" data-group-id="4049195546-6">do</span><span class="w">
      </span><span class="n">now</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">NaiveDateTime</span><span class="o">.</span><span class="n">utc_now</span><span class="p" data-group-id="4049195546-7">(</span><span class="p" data-group-id="4049195546-7">)</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">to_string</span><span class="p" data-group-id="4049195546-8">(</span><span class="p" data-group-id="4049195546-8">)</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">String</span><span class="o">.</span><span class="n">to_atom</span><span class="p" data-group-id="4049195546-9">(</span><span class="p" data-group-id="4049195546-9">)</span><span class="w">
      </span><span class="n">module</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Module</span><span class="o">.</span><span class="n">concat</span><span class="p" data-group-id="4049195546-10">(</span><span class="bp">__MODULE__</span><span class="p">,</span><span class="w"> </span><span class="n">now</span><span class="p" data-group-id="4049195546-10">)</span><span class="w">
      </span><span class="n">make_nest_module</span><span class="p" data-group-id="4049195546-11">(</span><span class="n">kv</span><span class="p">,</span><span class="w"> </span><span class="n">module</span><span class="p" data-group-id="4049195546-11">)</span><span class="w">
    </span><span class="k" data-group-id="4049195546-6">else</span><span class="w">
      </span><span class="k">raise</span><span class="w"> </span><span class="s">&quot;Expect a keyword, but get :</span><span class="si" data-group-id="4049195546-12">#{</span><span class="n">inspect</span><span class="p" data-group-id="4049195546-13">(</span><span class="n">kv</span><span class="p" data-group-id="4049195546-13">)</span><span class="si" data-group-id="4049195546-12">}</span><span class="s">&quot;</span><span class="w">
    </span><span class="k" data-group-id="4049195546-6">end</span><span class="w">
  </span><span class="k" data-group-id="4049195546-4">end</span><span class="w">

  </span><span class="kd">defmacro</span><span class="w"> </span><span class="nf">delete</span><span class="p" data-group-id="4049195546-14">(</span><span class="n">module</span><span class="p" data-group-id="4049195546-14">)</span><span class="w"> </span><span class="k" data-group-id="4049195546-15">do</span><span class="w">
    </span><span class="k">if</span><span class="w"> </span><span class="nc">:code</span><span class="o">.</span><span class="n">delete</span><span class="p" data-group-id="4049195546-16">(</span><span class="n">module</span><span class="p" data-group-id="4049195546-16">)</span><span class="w"> </span><span class="k" data-group-id="4049195546-17">do</span><span class="w">
      </span><span class="k">quote</span><span class="w"> </span><span class="k" data-group-id="4049195546-18">do</span><span class="w">
        </span><span class="n">var!</span><span class="p" data-group-id="4049195546-19">(</span><span class="k">unquote</span><span class="p" data-group-id="4049195546-20">(</span><span class="n">module</span><span class="p" data-group-id="4049195546-20">)</span><span class="p">,</span><span class="w"> </span><span class="bp">__CALLER__</span><span class="p" data-group-id="4049195546-19">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="no">nil</span><span class="w">
        </span><span class="no">true</span><span class="w">
      </span><span class="k" data-group-id="4049195546-18">end</span><span class="w">
    </span><span class="k" data-group-id="4049195546-17">else</span><span class="w">
      </span><span class="no">false</span><span class="w">
    </span><span class="k" data-group-id="4049195546-17">end</span><span class="w">
  </span><span class="k" data-group-id="4049195546-15">end</span><span class="w">

  </span><span class="kd">def</span><span class="w"> </span><span class="nf">set</span><span class="p" data-group-id="4049195546-21">(</span><span class="n">module</span><span class="p">,</span><span class="w"> </span><span class="n">k</span><span class="p">,</span><span class="w"> </span><span class="n">v</span><span class="p" data-group-id="4049195546-21">)</span><span class="w"> </span><span class="k" data-group-id="4049195546-22">do</span><span class="w">
    </span><span class="n">kv</span><span class="w"> </span><span class="o">=</span><span class="w">
      </span><span class="n">module</span><span class="o">.</span><span class="n">module_info</span><span class="p" data-group-id="4049195546-23">(</span><span class="ss">:attributes</span><span class="p" data-group-id="4049195546-23">)</span><span class="w">
      </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Enum</span><span class="o">.</span><span class="n">filter</span><span class="p" data-group-id="4049195546-24">(</span><span class="o">&amp;</span><span class="p" data-group-id="4049195546-25">(</span><span class="n">elem</span><span class="p" data-group-id="4049195546-26">(</span><span class="ni">&amp;1</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p" data-group-id="4049195546-26">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="ss">:vsn</span><span class="p" data-group-id="4049195546-25">)</span><span class="p" data-group-id="4049195546-24">)</span><span class="w">
      </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Enum</span><span class="o">.</span><span class="n">map</span><span class="p" data-group-id="4049195546-27">(</span><span class="k" data-group-id="4049195546-28">fn</span><span class="w"> </span><span class="p" data-group-id="4049195546-29">{</span><span class="n">k</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="4049195546-30">[</span><span class="n">v</span><span class="p" data-group-id="4049195546-30">]</span><span class="p" data-group-id="4049195546-29">}</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p" data-group-id="4049195546-31">{</span><span class="n">k</span><span class="p">,</span><span class="w"> </span><span class="n">v</span><span class="p" data-group-id="4049195546-31">}</span><span class="w"> </span><span class="k" data-group-id="4049195546-28">end</span><span class="p" data-group-id="4049195546-27">)</span><span class="w">
      </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Keyword</span><span class="o">.</span><span class="n">merge</span><span class="p" data-group-id="4049195546-32">(</span><span class="p" data-group-id="4049195546-33">[</span><span class="p" data-group-id="4049195546-34">{</span><span class="n">k</span><span class="p">,</span><span class="w"> </span><span class="n">v</span><span class="p" data-group-id="4049195546-34">}</span><span class="p" data-group-id="4049195546-33">]</span><span class="p" data-group-id="4049195546-32">)</span><span class="w">

    </span><span class="n">make_nest_module</span><span class="p" data-group-id="4049195546-35">(</span><span class="n">kv</span><span class="p">,</span><span class="w"> </span><span class="n">module</span><span class="p" data-group-id="4049195546-35">)</span><span class="w">
  </span><span class="k" data-group-id="4049195546-22">end</span><span class="w">

  </span><span class="kd">defp</span><span class="w"> </span><span class="nf">make_nest_module</span><span class="p" data-group-id="4049195546-36">(</span><span class="n">kv</span><span class="p">,</span><span class="w"> </span><span class="n">module</span><span class="p" data-group-id="4049195546-36">)</span><span class="w"> </span><span class="k" data-group-id="4049195546-37">do</span><span class="w">
    </span><span class="n">blocks</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">make_geter_and_seters</span><span class="p" data-group-id="4049195546-38">(</span><span class="n">module</span><span class="p">,</span><span class="w"> </span><span class="n">kv</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="4049195546-39">[</span><span class="p" data-group-id="4049195546-39">]</span><span class="p" data-group-id="4049195546-38">)</span><span class="w">

    </span><span class="k">quote</span><span class="w"> </span><span class="k" data-group-id="4049195546-40">do</span><span class="w">
      </span><span class="kd">defmodule</span><span class="w"> </span><span class="k">unquote</span><span class="p" data-group-id="4049195546-41">(</span><span class="n">module</span><span class="p" data-group-id="4049195546-41">)</span><span class="w"> </span><span class="k" data-group-id="4049195546-42">do</span><span class="w">
        </span><span class="k">unquote_splicing</span><span class="p" data-group-id="4049195546-43">(</span><span class="n">blocks</span><span class="p" data-group-id="4049195546-43">)</span><span class="w">
        </span><span class="kd">def</span><span class="w"> </span><span class="nf">delete</span><span class="p" data-group-id="4049195546-44">(</span><span class="p" data-group-id="4049195546-44">)</span><span class="p">,</span><span class="w"> </span><span class="ss">do</span><span class="p">:</span><span class="w"> </span><span class="nc">:code</span><span class="o">.</span><span class="n">delete</span><span class="p" data-group-id="4049195546-45">(</span><span class="k">unquote</span><span class="p" data-group-id="4049195546-46">(</span><span class="n">module</span><span class="p" data-group-id="4049195546-46">)</span><span class="p" data-group-id="4049195546-45">)</span><span class="w">
      </span><span class="k" data-group-id="4049195546-42">end</span><span class="w">
    </span><span class="k" data-group-id="4049195546-40">end</span><span class="w">
    </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Code</span><span class="o">.</span><span class="n">eval_quoted</span><span class="p" data-group-id="4049195546-47">(</span><span class="p" data-group-id="4049195546-47">)</span><span class="w">
    </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">elem</span><span class="p" data-group-id="4049195546-48">(</span><span class="mi">0</span><span class="p" data-group-id="4049195546-48">)</span><span class="w">
    </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">elem</span><span class="p" data-group-id="4049195546-49">(</span><span class="mi">1</span><span class="p" data-group-id="4049195546-49">)</span><span class="w">
  </span><span class="k" data-group-id="4049195546-37">end</span><span class="w">

  </span><span class="kd">defp</span><span class="w"> </span><span class="nf">make_geter_and_seters</span><span class="p" data-group-id="4049195546-50">(</span><span class="c">_module</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="4049195546-51">[</span><span class="p" data-group-id="4049195546-51">]</span><span class="p">,</span><span class="w"> </span><span class="n">acc</span><span class="p" data-group-id="4049195546-50">)</span><span class="p">,</span><span class="w"> </span><span class="ss">do</span><span class="p">:</span><span class="w"> </span><span class="n">acc</span><span class="w">

  </span><span class="kd">defp</span><span class="w"> </span><span class="nf">make_geter_and_seters</span><span class="p" data-group-id="4049195546-52">(</span><span class="n">module</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="4049195546-53">[</span><span class="p" data-group-id="4049195546-54">{</span><span class="n">k</span><span class="p">,</span><span class="w"> </span><span class="n">v</span><span class="p" data-group-id="4049195546-54">}</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">rest</span><span class="p" data-group-id="4049195546-53">]</span><span class="p">,</span><span class="w"> </span><span class="n">acc</span><span class="p" data-group-id="4049195546-52">)</span><span class="w"> </span><span class="k" data-group-id="4049195546-55">do</span><span class="w">
    </span><span class="n">attr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">make_attr</span><span class="p" data-group-id="4049195546-56">(</span><span class="n">k</span><span class="p">,</span><span class="w"> </span><span class="n">v</span><span class="p" data-group-id="4049195546-56">)</span><span class="w">
    </span><span class="n">geter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">quote</span><span class="w"> </span><span class="ss">do</span><span class="p">:</span><span class="w"> </span><span class="kd">def</span><span class="p" data-group-id="4049195546-57">(</span><span class="k">unquote</span><span class="p" data-group-id="4049195546-58">(</span><span class="n">k</span><span class="p" data-group-id="4049195546-58">)</span><span class="p" data-group-id="4049195546-59">(</span><span class="p" data-group-id="4049195546-59">)</span><span class="p">,</span><span class="w"> </span><span class="ss">do</span><span class="p">:</span><span class="w"> </span><span class="k">unquote</span><span class="p" data-group-id="4049195546-60">(</span><span class="n">v</span><span class="p" data-group-id="4049195546-60">)</span><span class="p" data-group-id="4049195546-57">)</span><span class="w">

    </span><span class="n">seter</span><span class="w"> </span><span class="o">=</span><span class="w">
      </span><span class="k">quote</span><span class="w"> </span><span class="k" data-group-id="4049195546-61">do</span><span class="w">
        </span><span class="kd">def</span><span class="w"> </span><span class="k">unquote</span><span class="p" data-group-id="4049195546-62">(</span><span class="n">k</span><span class="p" data-group-id="4049195546-62">)</span><span class="p" data-group-id="4049195546-63">(</span><span class="n">v</span><span class="p" data-group-id="4049195546-63">)</span><span class="p">,</span><span class="w">
          </span><span class="ss">do</span><span class="p">:</span><span class="w"> </span><span class="nc">Corner.State</span><span class="o">.</span><span class="n">set</span><span class="p" data-group-id="4049195546-64">(</span><span class="k">unquote</span><span class="p" data-group-id="4049195546-65">(</span><span class="n">module</span><span class="p" data-group-id="4049195546-65">)</span><span class="p">,</span><span class="w"> </span><span class="k">unquote</span><span class="p" data-group-id="4049195546-66">(</span><span class="n">k</span><span class="p" data-group-id="4049195546-66">)</span><span class="p">,</span><span class="w"> </span><span class="n">v</span><span class="p" data-group-id="4049195546-64">)</span><span class="w">
      </span><span class="k" data-group-id="4049195546-61">end</span><span class="w">

    </span><span class="n">make_geter_and_seters</span><span class="p" data-group-id="4049195546-67">(</span><span class="n">module</span><span class="p">,</span><span class="w"> </span><span class="n">rest</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="4049195546-68">[</span><span class="n">attr</span><span class="p">,</span><span class="w"> </span><span class="n">geter</span><span class="p">,</span><span class="w"> </span><span class="n">seter</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">acc</span><span class="p" data-group-id="4049195546-68">]</span><span class="p" data-group-id="4049195546-67">)</span><span class="w">
  </span><span class="k" data-group-id="4049195546-55">end</span><span class="w">

  </span><span class="kd">defp</span><span class="w"> </span><span class="nf">make_attr</span><span class="p" data-group-id="4049195546-69">(</span><span class="n">k</span><span class="p">,</span><span class="w"> </span><span class="n">v</span><span class="p" data-group-id="4049195546-69">)</span><span class="w"> </span><span class="k" data-group-id="4049195546-70">do</span><span class="w">
    </span><span class="p" data-group-id="4049195546-71">[</span><span class="w">
      </span><span class="k">quote</span><span class="w"> </span><span class="k" data-group-id="4049195546-72">do</span><span class="w">
        </span><span class="nc">Module</span><span class="o">.</span><span class="n">register_attribute</span><span class="p" data-group-id="4049195546-73">(</span><span class="bp">__MODULE__</span><span class="p">,</span><span class="w"> </span><span class="k">unquote</span><span class="p" data-group-id="4049195546-74">(</span><span class="n">k</span><span class="p" data-group-id="4049195546-74">)</span><span class="p">,</span><span class="w"> </span><span class="ss">persist</span><span class="p">:</span><span class="w"> </span><span class="no">true</span><span class="p" data-group-id="4049195546-73">)</span><span class="w">
      </span><span class="k" data-group-id="4049195546-72">end</span><span class="p">,</span><span class="w">
      </span><span class="p" data-group-id="4049195546-75">{</span><span class="p">:</span><span class="err">@</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="4049195546-76">[</span><span class="ss">context</span><span class="p">:</span><span class="w"> </span><span class="nc">Elixir</span><span class="p">,</span><span class="w"> </span><span class="ss">import</span><span class="p">:</span><span class="w"> </span><span class="nc">Kernel</span><span class="p" data-group-id="4049195546-76">]</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="4049195546-77">[</span><span class="p" data-group-id="4049195546-78">{</span><span class="n">k</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="4049195546-79">[</span><span class="ss">context</span><span class="p">:</span><span class="w"> </span><span class="nc">Elixir</span><span class="p" data-group-id="4049195546-79">]</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="4049195546-80">[</span><span class="n">v</span><span class="p" data-group-id="4049195546-80">]</span><span class="p" data-group-id="4049195546-78">}</span><span class="p" data-group-id="4049195546-77">]</span><span class="p" data-group-id="4049195546-75">}</span><span class="w">
    </span><span class="p" data-group-id="4049195546-71">]</span><span class="w">
  </span><span class="k" data-group-id="4049195546-70">end</span><span class="w">
</span><span class="k" data-group-id="4049195546-1">end</span></code></pre><p>我们可以使用 <code class="inline">h = Corner.State.create([x: 1])</code> 来创建一个状态.
并使用 <code class="inline">s.x</code> 读取 <code class="inline">x</code> 的值, <code class="inline">s.x(new_value)</code>
更新 <code class="inline">x</code> 的值.</p><pre><code class="makeup elixir" translate="no"><span class="kn">import</span><span class="w"> </span><span class="nc">Corner.State</span><span class="w">
</span><span class="n">s</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">create</span><span class="p" data-group-id="7955146305-1">(</span><span class="ss">x</span><span class="p">:</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="ss">y</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p" data-group-id="7955146305-1">)</span><span class="w">
</span><span class="n">s</span><span class="o">.</span><span class="n">x</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">IO</span><span class="o">.</span><span class="n">inspect</span><span class="p" data-group-id="7955146305-2">(</span><span class="ss">label</span><span class="p">:</span><span class="w"> </span><span class="ss">:x</span><span class="p" data-group-id="7955146305-2">)</span><span class="w">
</span><span class="n">s</span><span class="o">.</span><span class="n">y</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">IO</span><span class="o">.</span><span class="n">inspect</span><span class="p" data-group-id="7955146305-3">(</span><span class="ss">label</span><span class="p">:</span><span class="w"> </span><span class="ss">:y</span><span class="p" data-group-id="7955146305-3">)</span><span class="w">
</span><span class="n">s</span><span class="o">.</span><span class="n">x</span><span class="p" data-group-id="7955146305-4">(</span><span class="mi">0</span><span class="p" data-group-id="7955146305-4">)</span><span class="w">
</span><span class="n">s</span><span class="o">.</span><span class="n">x</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">IO</span><span class="o">.</span><span class="n">inspect</span><span class="p" data-group-id="7955146305-5">(</span><span class="ss">label</span><span class="p">:</span><span class="w"> </span><span class="ss">:x</span><span class="p" data-group-id="7955146305-5">)</span><span class="w">
</span><span class="n">delete</span><span class="p" data-group-id="7955146305-6">(</span><span class="n">s</span><span class="p" data-group-id="7955146305-6">)</span><span class="w">
</span><span class="n">s</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">IO</span><span class="o">.</span><span class="n">inspect</span><span class="p" data-group-id="7955146305-7">(</span><span class="p" data-group-id="7955146305-7">)</span></code></pre><h2 id="超时" class="section-heading">
  <a href="#超时" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i>
  <p class="sr-only">超时</p>
  </a>
  超时
</h2>
<p>Elixir 的 <code class="inline">receive</code> 结构中支持 <code class="inline">after</code> 子句来处理超时问题. <code class="inline">after_sent</code>
也可以在指定的时间后向进程发送消息.</p><p>这些功能背后使用的都是相同的机制, Elixir 中整数是可以无限大的,
但是表示超时的参数却不能这样, 而是有限制的.
在 Elixir 中, 如果是一个正整数, 那么这个正整数,
必须小于等于 32 位可表示的最大无符号整数,
也就是 $2^{33}-1$ (或十六进制表示: 0xFFFF_FFFF).
让我们实验一下:</p><pre><code class="makeup elixir" translate="no"><span class="k">receive</span><span class="w"> </span><span class="k" data-group-id="4266970085-1">do</span><span class="w">
  </span><span class="n">a</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="nc">IO</span><span class="o">.</span><span class="n">inspect</span><span class="p" data-group-id="4266970085-2">(</span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="ss">label</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;a&quot;</span><span class="p" data-group-id="4266970085-2">)</span><span class="w">
</span><span class="k" data-group-id="4266970085-1">after</span><span class="w">
  </span><span class="mh">0xFFFF_FFFF</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="nc">IO</span><span class="o">.</span><span class="n">put</span><span class="p" data-group-id="4266970085-3">(</span><span class="s">&quot;timeout&quot;</span><span class="p" data-group-id="4266970085-3">)</span><span class="w">
</span><span class="k" data-group-id="4266970085-1">end</span></code></pre><h2 id="远程调用和本地调用" class="section-heading">
  <a href="#远程调用和本地调用" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i>
  <p class="sr-only">远程调用和本地调用</p>
  </a>
  远程调用和本地调用
</h2>
<p>在模块外, 调用一个模块的函数, 实际上使用的都是远程调用.
但是在 <a href="https://hexdocs.pm/elixir/Kernel.html#defmodule/2"><code class="inline">defmodule/2</code></a> 的上下文中, 私有函数和公开函数都可以使用本地调用的语法来调用.</p><p>原来我一直以为, 在 <a href="https://hexdocs.pm/elixir/Kernel.html#defmodule/2"><code class="inline">defmodule/2</code></a> 上下文中, 对模块内的函数, 使用远程调用的语法没有意义.
但是这是错误的. 当代码发生热加载的时候, 在 <a href="https://hexdocs.pm/elixir/Kernel.html#defmodule/2"><code class="inline">defmodule/2</code></a> 上下文中,
远程调用和本地调用之间的差别就显示出来了.</p><p>Erlang 中热加载是这样实现的:</p><p>系统会为每个模块保持两个最新的版本. 假设有两个进程P1, P2; P1 运行的是第一个版本的代码,
P2 运行的是第二个版本的代码. 当模块的第 3 个版本被加载到系统后, 第一个版本的代码,
就会从系统中被删除掉, 这是, 如果有进程还在运行第一个版本的代码,
就会因为找不到对应的模块, 而被杀死.</p><p>如果被杀死的 P1 运行在监管树下, 那么监控进程会创建新的进程 P3 代替死亡的 P1,
这时 P3 中运行的是第三个版本的代码. 至此, 和远程函数调用还没有关系.</p><p>这样的热更新, 导致了进程 P1 退出, 所以还是有风险的.</p><p>如果代码更新后, 还在运行的进程可以自动的切换到最新的版本的代码中,
那么热更新的风险就更小了.</p><p>要达到这种效果, 在服务器进程的循环函数中, 最后对自己的递归调用, 就必须使用远程调用的语法.
远程调用语法, 调用的都是模块的最新版本的代码.</p><p>下面让我们用代码来实验一下.</p><p>首先, 定义第一个版本. 在<code class="inline">loop/0</code> 递归调用自己的时候,
使用的是本地函数调用的语法:<code class="inline">loop()</code>.
模块编译完成后, 立刻启东进程 p1 运行这个版本.</p><pre><code class="makeup elixir" translate="no"><span class="kd">defmodule</span><span class="w"> </span><span class="nc">RemoteAndLocalCall</span><span class="w"> </span><span class="k" data-group-id="2503767977-1">do</span><span class="w">
  </span><span class="kd">def</span><span class="w"> </span><span class="nf">loop</span><span class="p" data-group-id="2503767977-2">(</span><span class="p" data-group-id="2503767977-2">)</span><span class="w"> </span><span class="k" data-group-id="2503767977-3">do</span><span class="w">
    </span><span class="k">receive</span><span class="w"> </span><span class="k" data-group-id="2503767977-4">do</span><span class="w">
      </span><span class="ss">:ok</span><span class="w"> </span><span class="o">-&gt;</span><span class="w">
        </span><span class="nc">IO</span><span class="o">.</span><span class="n">puts</span><span class="p" data-group-id="2503767977-5">(</span><span class="s">&quot;</span><span class="si" data-group-id="2503767977-6">#{</span><span class="n">inspect</span><span class="p" data-group-id="2503767977-7">(</span><span class="n">self</span><span class="p" data-group-id="2503767977-8">(</span><span class="p" data-group-id="2503767977-8">)</span><span class="p" data-group-id="2503767977-7">)</span><span class="si" data-group-id="2503767977-6">}</span><span class="s"> version1&quot;</span><span class="p" data-group-id="2503767977-5">)</span><span class="w">
        </span><span class="nc">Process</span><span class="o">.</span><span class="n">send_after</span><span class="p" data-group-id="2503767977-9">(</span><span class="n">self</span><span class="p" data-group-id="2503767977-10">(</span><span class="p" data-group-id="2503767977-10">)</span><span class="p">,</span><span class="w"> </span><span class="ss">:ok</span><span class="p">,</span><span class="w"> </span><span class="mi">100</span><span class="p" data-group-id="2503767977-9">)</span><span class="w">
        </span><span class="n">loop</span><span class="p" data-group-id="2503767977-11">(</span><span class="p" data-group-id="2503767977-11">)</span><span class="w">

      </span><span class="ss">:stop</span><span class="w"> </span><span class="o">-&gt;</span><span class="w">
        </span><span class="nc">IO</span><span class="o">.</span><span class="n">puts</span><span class="p" data-group-id="2503767977-12">(</span><span class="s">&quot;stop version1&quot;</span><span class="p" data-group-id="2503767977-12">)</span><span class="w">
    </span><span class="k" data-group-id="2503767977-4">end</span><span class="w">
  </span><span class="k" data-group-id="2503767977-3">end</span><span class="w">
</span><span class="k" data-group-id="2503767977-1">end</span><span class="w">

</span><span class="n">p1</span><span class="w"> </span><span class="o">=</span><span class="w">
  </span><span class="n">spawn</span><span class="p" data-group-id="2503767977-13">(</span><span class="o">&amp;</span><span class="nc">RemoteAndLocalCall</span><span class="o">.</span><span class="n">loop</span><span class="o">/</span><span class="mi">0</span><span class="p" data-group-id="2503767977-13">)</span><span class="w">
  </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">IO</span><span class="o">.</span><span class="n">inspect</span><span class="p" data-group-id="2503767977-14">(</span><span class="ss">label</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;p1&quot;</span><span class="p" data-group-id="2503767977-14">)</span></code></pre><p>然后我们定义第二个版本, 这里, <code class="inline">loop/0</code> 对自己递归调用的时候,
使用的是远程函数调用的语法: <code class="inline">__MODULE__.loop()</code>.
模块编译后, 我们启动进程 p2 来运行我们的代码. 这时 p1 和 p2 都在等待消息进来.
所以, 通过向他们分别发送一个 <code class="inline">:ok</code> 消息来启动这两个进程的循环.</p><p>这时控制台中会交替的输出 &quot;PID{} version1&quot;, &quot;PID{} version2&quot;.</p><pre><code class="makeup elixir" translate="no"><span class="kd">defmodule</span><span class="w"> </span><span class="nc">RemoteAndLocalCall</span><span class="w"> </span><span class="k" data-group-id="1556511214-1">do</span><span class="w">
  </span><span class="kd">def</span><span class="w"> </span><span class="nf">loop</span><span class="p" data-group-id="1556511214-2">(</span><span class="p" data-group-id="1556511214-2">)</span><span class="w"> </span><span class="k" data-group-id="1556511214-3">do</span><span class="w">
    </span><span class="k">receive</span><span class="w"> </span><span class="k" data-group-id="1556511214-4">do</span><span class="w">
      </span><span class="ss">:ok</span><span class="w"> </span><span class="o">-&gt;</span><span class="w">
        </span><span class="nc">IO</span><span class="o">.</span><span class="n">puts</span><span class="p" data-group-id="1556511214-5">(</span><span class="s">&quot;</span><span class="si" data-group-id="1556511214-6">#{</span><span class="n">inspect</span><span class="p" data-group-id="1556511214-7">(</span><span class="n">self</span><span class="p" data-group-id="1556511214-8">(</span><span class="p" data-group-id="1556511214-8">)</span><span class="p" data-group-id="1556511214-7">)</span><span class="si" data-group-id="1556511214-6">}</span><span class="s"> version2&quot;</span><span class="p" data-group-id="1556511214-5">)</span><span class="w">
        </span><span class="nc">Process</span><span class="o">.</span><span class="n">send_after</span><span class="p" data-group-id="1556511214-9">(</span><span class="n">self</span><span class="p" data-group-id="1556511214-10">(</span><span class="p" data-group-id="1556511214-10">)</span><span class="p">,</span><span class="w"> </span><span class="ss">:ok</span><span class="p">,</span><span class="w"> </span><span class="mi">100</span><span class="p" data-group-id="1556511214-9">)</span><span class="w">
        </span><span class="bp">__MODULE__</span><span class="o">.</span><span class="n">loop</span><span class="p" data-group-id="1556511214-11">(</span><span class="p" data-group-id="1556511214-11">)</span><span class="w">

      </span><span class="ss">:stop</span><span class="w"> </span><span class="o">-&gt;</span><span class="w">
        </span><span class="nc">IO</span><span class="o">.</span><span class="n">puts</span><span class="p" data-group-id="1556511214-12">(</span><span class="s">&quot;stop version2&quot;</span><span class="p" data-group-id="1556511214-12">)</span><span class="w">
    </span><span class="k" data-group-id="1556511214-4">end</span><span class="w">
  </span><span class="k" data-group-id="1556511214-3">end</span><span class="w">
</span><span class="k" data-group-id="1556511214-1">end</span><span class="w">

</span><span class="n">p2</span><span class="w"> </span><span class="o">=</span><span class="w">
  </span><span class="n">spawn</span><span class="p" data-group-id="1556511214-13">(</span><span class="o">&amp;</span><span class="nc">RemoteAndLocalCall</span><span class="o">.</span><span class="n">loop</span><span class="o">/</span><span class="mi">0</span><span class="p" data-group-id="1556511214-13">)</span><span class="w">
  </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">IO</span><span class="o">.</span><span class="n">inspect</span><span class="p" data-group-id="1556511214-14">(</span><span class="ss">label</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;p2&quot;</span><span class="p" data-group-id="1556511214-14">)</span><span class="w">

</span><span class="nc">Process</span><span class="o">.</span><span class="n">alive?</span><span class="p" data-group-id="1556511214-15">(</span><span class="n">p1</span><span class="p" data-group-id="1556511214-15">)</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">IO</span><span class="o">.</span><span class="n">inspect</span><span class="p" data-group-id="1556511214-16">(</span><span class="ss">label</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;Is v1 alive?&quot;</span><span class="p" data-group-id="1556511214-16">)</span><span class="w">

</span><span class="k">for</span><span class="w"> </span><span class="n">p</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="p" data-group-id="1556511214-17">[</span><span class="n">p1</span><span class="p">,</span><span class="w"> </span><span class="n">p2</span><span class="p" data-group-id="1556511214-17">]</span><span class="w"> </span><span class="k" data-group-id="1556511214-18">do</span><span class="w">
  </span><span class="n">send</span><span class="p" data-group-id="1556511214-19">(</span><span class="n">p</span><span class="p">,</span><span class="w"> </span><span class="ss">:ok</span><span class="p" data-group-id="1556511214-19">)</span><span class="w">
</span><span class="k" data-group-id="1556511214-18">end</span></code></pre><p>最后, 定义第三个版本, 模块编译通过后会发现:</p><ol><li>进程 p1 死亡了.</li><li>进程 p2 还活着, 但是其中运行的代码更新了.
控制台输出变成了 <code class="inline">PID{} version3</code>.</li></ol><pre><code class="makeup elixir" translate="no"><span class="kd">defmodule</span><span class="w"> </span><span class="nc">RemoteAndLocalCall</span><span class="w"> </span><span class="k" data-group-id="6630666257-1">do</span><span class="w">
  </span><span class="kd">def</span><span class="w"> </span><span class="nf">loop</span><span class="p" data-group-id="6630666257-2">(</span><span class="p" data-group-id="6630666257-2">)</span><span class="w"> </span><span class="k" data-group-id="6630666257-3">do</span><span class="w">
    </span><span class="k">receive</span><span class="w"> </span><span class="k" data-group-id="6630666257-4">do</span><span class="w">
      </span><span class="ss">:ok</span><span class="w"> </span><span class="o">-&gt;</span><span class="w">
        </span><span class="nc">IO</span><span class="o">.</span><span class="n">puts</span><span class="p" data-group-id="6630666257-5">(</span><span class="s">&quot;</span><span class="si" data-group-id="6630666257-6">#{</span><span class="n">inspect</span><span class="p" data-group-id="6630666257-7">(</span><span class="n">self</span><span class="p" data-group-id="6630666257-7">)</span><span class="si" data-group-id="6630666257-6">}</span><span class="s"> version3&quot;</span><span class="p" data-group-id="6630666257-5">)</span><span class="w">
        </span><span class="nc">Process</span><span class="o">.</span><span class="n">send_after</span><span class="p" data-group-id="6630666257-8">(</span><span class="n">self</span><span class="p">,</span><span class="w"> </span><span class="ss">:ok</span><span class="p">,</span><span class="w"> </span><span class="mi">100</span><span class="p" data-group-id="6630666257-8">)</span><span class="w">
        </span><span class="bp">__MODULE__</span><span class="o">.</span><span class="n">loop</span><span class="p" data-group-id="6630666257-9">(</span><span class="p" data-group-id="6630666257-9">)</span><span class="w">

      </span><span class="ss">:stop</span><span class="w"> </span><span class="o">-&gt;</span><span class="w">
        </span><span class="nc">IO</span><span class="o">.</span><span class="n">puts</span><span class="p" data-group-id="6630666257-10">(</span><span class="s">&quot;stop version3&quot;</span><span class="p" data-group-id="6630666257-10">)</span><span class="w">
    </span><span class="k" data-group-id="6630666257-4">end</span><span class="w">
  </span><span class="k" data-group-id="6630666257-3">end</span><span class="w">
</span><span class="k" data-group-id="6630666257-1">end</span><span class="w">

</span><span class="nc">Process</span><span class="o">.</span><span class="n">alive?</span><span class="p" data-group-id="6630666257-11">(</span><span class="n">p1</span><span class="p" data-group-id="6630666257-11">)</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">IO</span><span class="o">.</span><span class="n">inspect</span><span class="p" data-group-id="6630666257-12">(</span><span class="ss">label</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;Is v1 live?&quot;</span><span class="p" data-group-id="6630666257-12">)</span><span class="w">
</span><span class="nc">Process</span><span class="o">.</span><span class="n">alive?</span><span class="p" data-group-id="6630666257-13">(</span><span class="n">p2</span><span class="p" data-group-id="6630666257-13">)</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">IO</span><span class="o">.</span><span class="n">inspect</span><span class="p" data-group-id="6630666257-14">(</span><span class="ss">label</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;Is v2 live?&quot;</span><span class="p" data-group-id="6630666257-14">)</span><span class="w">
</span><span class="nc">IO</span><span class="o">.</span><span class="n">inspect</span><span class="p" data-group-id="6630666257-15">(</span><span class="n">p2</span><span class="p">,</span><span class="w"> </span><span class="ss">label</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;P2&quot;</span><span class="p" data-group-id="6630666257-15">)</span></code></pre><p>最后运行下面的代码, 退出进程 p2.</p><pre><code class="makeup elixir" translate="no"><span class="n">send</span><span class="p" data-group-id="3260144282-1">(</span><span class="n">p2</span><span class="p">,</span><span class="w"> </span><span class="ss">:stop</span><span class="p" data-group-id="3260144282-1">)</span></code></pre>
<div class="bottom-actions">
  <div class="bottom-actions-item">

      <a href="ch12-process.html" class="bottom-actions-button" rel="prev">
        <span class="subheader">
          ← Previous Page
        </span>
        <span class="title">
第十二章 进程
        </span>
      </a>

  </div>
  <div class="bottom-actions-item">

  </div>
</div>

      <footer class="footer">

        <p>
          Built using
          <a href="https://github.com/elixir-lang/ex_doc" title="ExDoc" target="_blank" rel="help noopener" translate="no">ExDoc</a> (v0.28.4) for the

            <a href="https://elixir-lang.org" title="Elixir" target="_blank" translate="no">Elixir programming language</a>

        </p>
      </footer>
    </div>
  </div>
</section>
</div>


  </body>
</html>
