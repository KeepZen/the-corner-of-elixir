<!DOCTYPE HTML>
<html lang="zh-cn" class="sidebar-visible no-js light">

<head>
    <!-- Book generated using mdBook -->
    <meta charset="UTF-8">
    <title>åè®®ä¸è¡Œä¸º - è§’è½é‡Œçš„é•¿ç”Ÿä¸è€è¯</title>


    <!-- Custom HTML head -->
    
    <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
    <meta name="description" content="">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="theme-color" content="#ffffff" />

    <link rel="icon" href="favicon.svg">
    <link rel="stylesheet" href="css/variables.css">
    <link rel="stylesheet" href="css/general.css">
    <link rel="stylesheet" href="css/chrome.css">
    <link rel="stylesheet" href="css/print.css" media="print">

    <!-- Fonts -->
    <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
    <link rel="stylesheet" href="fonts/fonts.css">

    <!-- Highlight.js Stylesheets -->
    <link rel="stylesheet" href="highlight.css">
    <link rel="stylesheet" href="tomorrow-night.css">
    <link rel="stylesheet" href="ayu-highlight.css">

    <!-- Custom theme stylesheets -->

    <!-- MathJax -->
    <script>
        MathJax = {
            tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
            }
        };
    </script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js">
    </script>
</head>

<body>
    <!-- Provide site root to javascript -->
    <script type="text/javascript">
        var path_to_root = "";
        var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
    </script>

    <!-- Work around some values being stored in localStorage wrapped in quotes -->
    <script type="text/javascript">
        try {
            var theme = localStorage.getItem('mdbook-theme');
            var sidebar = localStorage.getItem('mdbook-sidebar');

            if (theme.startsWith('"') && theme.endsWith('"')) {
                localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
            }

            if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
            }
        } catch (e) { }
    </script>

    <!-- Set the theme before any content is loaded, prevents flash -->
    <script type="text/javascript">
        var theme;
        try { theme = localStorage.getItem('mdbook-theme'); } catch (e) { }
        if (theme === null || theme === undefined) { theme = default_theme; }
        var html = document.querySelector('html');
        html.classList.remove('no-js')
        html.classList.remove('light')
        html.classList.add(theme);
        html.classList.add('js');
    </script>

    <!-- Hide / unhide sidebar before it is displayed -->
    <script type="text/javascript">
        var html = document.querySelector('html');
        var sidebar = 'hidden';
        if (document.body.clientWidth >= 1080) {
            try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch (e) { }
            sidebar = sidebar || 'visible';
        }
        html.classList.remove('sidebar-visible');
        html.classList.add("sidebar-" + sidebar);
    </script>

    <nav id="sidebar" class="sidebar" aria-label="Table of contents">
        <div class="sidebar-scrollbox">
            <ol class="chapter"><li class="chapter-item expanded "><a href="index.html"><strong aria-hidden="true">1.</strong> ç›®å½•</a></li><li class="chapter-item expanded "><a href="ch01.intruction.html"><strong aria-hidden="true">2.</strong> å‰è¨€</a></li><li class="chapter-item expanded "><a href="ch02.plus_and_minus.html"><strong aria-hidden="true">3.</strong> åŠ å’Œå‡</a></li><li class="chapter-item expanded "><a href="ch03.pattern_match.html"><strong aria-hidden="true">4.</strong> æ¨¡å¼åŒ¹é…</a></li><li class="chapter-item expanded "><a href="ch04.parenthese.html"><strong aria-hidden="true">5.</strong> æ‹¬å·</a></li><li class="chapter-item expanded "><a href="ch05.new_constructor.html"><strong aria-hidden="true">6.</strong> å®šåˆ¶æ–°ç»“æ„</a></li><li class="chapter-item expanded "><a href="ch06.async_programe.html"><strong aria-hidden="true">7.</strong> å¼‚æ­¥ç¼–ç¨‹</a></li><li class="chapter-item expanded "><a href="ch07.pipe.html"><strong aria-hidden="true">8.</strong> ç®¡é“æ“ä½œç¬¦</a></li><li class="chapter-item expanded "><a href="ch08.error_handle.html"><strong aria-hidden="true">9.</strong> é”™è¯¯å¤„ç†</a></li><li class="chapter-item expanded "><a href="ch09.module.html"><strong aria-hidden="true">10.</strong> æ¨¡å—</a></li><li class="chapter-item expanded "><a href="ch10.protocol_and_behaviour.html" class="active"><strong aria-hidden="true">11.</strong> åè®®ä¸è¡Œä¸º</a></li><li class="chapter-item expanded "><a href="ch11.macro.html"><strong aria-hidden="true">12.</strong> å¦‚ä½•ç†è§£å®</a></li><li class="chapter-item expanded "><a href="ch12.process.html"><strong aria-hidden="true">13.</strong> è¿›ç¨‹</a></li><li class="chapter-item expanded "><a href="chx.cold_knowledge.html"><strong aria-hidden="true">14.</strong> é™„å½• å†·çŸ¥è¯†</a></li></ol>
        </div>
        <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
    </nav>

    <div id="page-wrapper" class="page-wrapper">

        <div class="page">
                        <div id="menu-bar-hover-placeholder"></div>
            <div id="menu-bar" class="menu-bar sticky bordered">
                <div class="left-buttons">
                    <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents"
                        aria-label="Toggle Table of Contents" aria-controls="sidebar">
                        <i class="fa fa-bars"></i>
                    </button>
                    <button id="theme-toggle" class="icon-button" type="button" title="Change theme"
                        aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                        <i class="fa fa-paint-brush"></i>
                    </button>
                    <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                        <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                        <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                        <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                        <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                        <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button>
                        </li>
                    </ul>
                    <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)"
                        aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S"
                        aria-controls="searchbar">
                        <i class="fa fa-search"></i>
                    </button>
                </div>

                <h1 class="menu-title">è§’è½é‡Œçš„é•¿ç”Ÿä¸è€è¯</h1>

                <div class="right-buttons">
                    <a href="print.html" title="Print this book" aria-label="Print this book">
                        <i id="print-button" class="fa fa-print"></i>
                    </a>

                </div>
            </div>

            <div id="search-wrapper" class="hidden">
                <form id="searchbar-outer" class="searchbar-outer">
                    <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..."
                        aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                </form>
                <div id="searchresults-outer" class="searchresults-outer hidden">
                    <div id="searchresults-header" class="searchresults-header"></div>
                    <ul id="searchresults">
                    </ul>
                </div>
            </div>

            <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
            <script type="text/javascript">
                document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                Array.from(document.querySelectorAll('#sidebar a')).forEach(function (link) {
                    link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                });
            </script>

            <div id="content" class="content">
                <main>
                    <h1 id="ç¬¬åç« -åè®®ä¸è¡Œä¸º"><a class="header" href="#ç¬¬åç« -åè®®ä¸è¡Œä¸º">ç¬¬åç«  åè®®ä¸è¡Œä¸º</a></h1>
<h2 id="å¦‚ä½•é€‰æ‹©"><a class="header" href="#å¦‚ä½•é€‰æ‹©">å¦‚ä½•é€‰æ‹©</a></h2>
<p>å°±åƒ <code>case</code> å’Œ <code>cond</code> ä¸€åº¦è®©æˆ‘æ„Ÿè§‰é€‰æ‹©å›°éš¾ä¸€æ ·,
é¢å¯¹åè®®å’Œè¡Œä¸º, æˆ‘å¾€å¾€ä¹Ÿéš¾ä»¥åšå‡ºæŠ‰æ‹©.</p>
<p>ä½†æ˜¯è¿™ç§å›°éš¾å’Œè¯­è¨€æ— å…³, å› ä¸ºå®ƒä¸æ˜¯è¯­ä¹‰æ–¹é¢çš„çš„é—®é¢˜, è€Œæ˜¯ç³»ç»Ÿè®¾è®¡çŸ¥è¯†ä¸è¶³å¸¦æ¥çš„.</p>
<p>å¯ä»¥è¿™æ ·ç†è§£, åè®®å°±æ˜¯ OOP ç¼–ç¨‹ä¸­çš„æ¥å£ (Java) æˆ–è€…çº¯æŠ½è±¡ç±»(C++);
è€Œè¡Œä¸ºå°±æ˜¯ä¸€èˆ¬çš„æŠ½è±¡ç±». è‡³å°‘åè®®å’Œè¡Œä¸ºè§£å†³çš„é—®é¢˜ä¸ OOP
ä¸­æ¥å£ä¸æŠ½è±¡ç±»è§£å†³çš„é—®é¢˜æ˜¯ä¸€æ ·çš„.</p>
<p>æ¥å£å’Œåè®®å¯ä»¥çœ‹ä½œä¸€ä¸ªç³»ç»Ÿçš„ API æ¥å£, ä½¿ç”¨è€…åªéœ€è¦å…³å¿ƒç³»ç»Ÿæä¾›äº†é‚£äº›åŠŸèƒ½,
è€Œä¸ç”¨å…³å¿ƒè¿™äº›åŠŸèƒ½æ˜¯å¦‚ä½•å®ç°çš„.</p>
<p>æŠ½è±¡ç±»æˆ–è¡Œä¸ºå¯ä»¥çœ‹ä½œæ˜¯å¯ä¾› DIY çš„äº§å“. åŸºç¡€çš„åŠŸèƒ½, è¡Œä¸º(<code>Behavior</code>)
å·²ç»ä¸ºæˆ‘ä»¬å®šä¹‰å¥½äº†, ç³»ç»Ÿå„ä¸ªéƒ¨åˆ†äº¤äº’çš„è§„åˆ™ä¹Ÿå·²ç»å®Œæˆäº†,
ä½†æ˜¯å…·ä½“çš„ä¸šåŠ¡éœ€æ±‚éƒ¨åˆ†, éœ€è¦ç”¨æˆ·è‡ªå·± DIY.</p>
<p>å¦‚æœä»£ç æœ€ä¸»è¦çš„ç›®çš„, æ˜¯ç®€åŒ–ç³»ç»Ÿçš„è°ƒç”¨, é‚£ä¹ˆåº”è¯¥ä½¿ç”¨åè®®åŠå…¶å®ç°.
å¦‚æœä»£ç æä¾›çš„æœåŠ¡, éœ€è¦æ”¯æŒå®šåˆ¶åŒ–çš„å¼€å‘, é‚£ä¹ˆå°±åº”è¯¥ä½¿ç”¨åè®®.</p>
<h2 id="åè®®åˆ°åº•æ˜¯ä»€ä¹ˆ"><a class="header" href="#åè®®åˆ°åº•æ˜¯ä»€ä¹ˆ">åè®®åˆ°åº•æ˜¯ä»€ä¹ˆ</a></h2>
<p>é¦–å…ˆåœ¨åº•å±‚, åè®®å’Œåè®®çš„å®ç°åˆ°åº•æ˜¯ä»€ä¹ˆ?</p>
<p>Erlang ä¸­æ ¹æœ¬æ²¡æœ‰åè®®è¿™æ ·çš„è¯­æ³•æ¦‚å¿µ. Elixir è¿è¡Œåœ¨ Erlang çš„è™šæ‹Ÿæœºä¸­,
æ‰€ä»¥ Elixir æ˜¯ç”¨äº† Erlang ä¸­çš„æ¦‚å¿µä¸ºæˆ‘ä»¬æŠ½è±¡å‡ºäº†åè®®è¿™ä¸€æ–°æ¦‚å¿µ.</p>
<p>å’Œåè®®å…³ç³»æœ€å¯†åˆ‡çš„æ¦‚å¿µå°±æ˜¯è¡Œä¸º, å°±åƒä¸Šä¸€èŠ‚æè¿°çš„é‚£æ ·, è¿™ä¸¤ä¸ªæ¦‚å¿µå¯†åˆ‡åˆ°æˆ‘ä¸çŸ¥é“å¦‚ä½•é€‰æ‹©.
ç°åœ¨åˆçŸ¥é“, åè®®æ˜¯é«˜çº§çš„æ¦‚å¿µ, é‚£ä¹ˆå¯ä»¥è‚¯å®š, åè®®çš„æ¦‚å¿µä¸€å®šæ„å»ºåœ¨è¡Œä¸ºçš„åŸºç¡€ä¸Š.</p>
<p>è¡Œä¸ºæ˜¯æ¨¡å—çš„å±æ€§, æ˜¯æ¨¡å—å‘å‡ºçš„å£°æ˜: å®ç°äº†æŸä¸ªæ¨¡å—ä¸­æ‰€æœ‰çš„ <code>@callback</code> å±æ€§.</p>
<p>è€Œä¸€ä¸ªç†æƒ³çš„åè®®æ¨¡å—, é™¤äº†å®ç°çš„åŠ¨æ€è°ƒåº¦çš„ç›¸å…³å‡½æ•°å¤–, æ²¡æœ‰å…¶ä»–å‡½æ•°.
é‚£ä¹ˆåè®®è¿™ä¸ªæ¦‚å¿µæœ¬è´¨ä¸Š, å°±æ˜¯ Elixir å¸®åŠ©æˆ‘ä»¬æ›´ç®€å•çš„å®Œæˆå¯¹è¡Œä¸ºçš„åŠ¨æ€è°ƒåº¦.</p>
<h2 id="åè®®ä¸æ¨¡å—"><a class="header" href="#åè®®ä¸æ¨¡å—">åè®®ä¸æ¨¡å—</a></h2>
<p>åœ¨å‰é¢çš„æ¨¡å—çš„ç« èŠ‚ä¸­, æˆ‘ä»¬å·²ç»çŸ¥é“äº† <code>defprotocol</code> å’Œ <code>defimpl</code> å®çš„è°ƒç”¨,
å’Œ <code>defmodule/2</code> çš„è°ƒç”¨ä¸€æ ·, åœ¨ç¼–è¯‘åä¼šäº§ç”Ÿç¼–è¯‘æ¨¡å—, åæ˜ åˆ°æ–‡ä»¶ç³»ç»Ÿä¸­å°±æ˜¯ <code>.beam</code> æ–‡ä»¶.
æˆ‘ä»¬è¿˜çŸ¥é“, <code>defmodule/2</code> æ˜¯æ”¯æŒåµŒå¥—å®šä¹‰çš„, é‚£ä¹ˆè¿™å°±æ„å‘³ç€, <code>defprotocol</code> å’Œ
<code>defimpl</code> é™¤äº†å®šä¹‰åœ¨é¡¶å±‚çš„ä½œç”¨åŸŸå¤–, è¿˜å¯ä»¥åµŒå¥—åœ¨ <code>defmodule/2</code> çš„ä¸Šä¸‹æ–‡ä¸­.</p>
<p>ç°åœ¨è®©æˆ‘ä»¬å®šä¹‰ä¸€ä¸ª <code>Corner.Addable</code> åè®®.</p>
<pre><code class="language-elixir">defmodule Corner do
  defprotocol Addable do
    def add(a, b)
  end

  defimpl Addable, for: [Integer, Float] do
    def add(a, b), do: a + b
  end
end
</code></pre>
<p>é¦–å…ˆ, ç”¨ <code>elixirc</code> æ¥ç¼–è¯‘è¿™æ®µä»£ç , å¾—åˆ° 4 ä¸ª <code>.beam</code> æ–‡ä»¶,
åˆ†åˆ«æ˜¯: <code>Elixir.Corner.beam</code>,<code>Elixir.Coner.Addable.beam</code>,
<code>Elixir.Coner.Addable.Integer</code> å’Œ <code>Elixir.Corner.Addable.Float</code>.</p>
<p>ä¹Ÿå°±æ˜¯è¯´, å¦‚æœåœ¨æ¨¡å—å†…ä½¿ç”¨ <code>defprotocol</code>, é‚£ä¹ˆå®ƒçš„å˜åŒ–ç±»ä¼¼äº <code>defmodule/2</code>,
æœ€åäº§ç”Ÿçš„æ¨¡å—åä¼šæ·»åŠ å¤–éƒ¨æ¨¡å—å‰ç¼€. è€Œåè®®çš„å®ç°ä»£ç ,
å®é™…ä¸Šæ˜¯å®šä¹‰åœ¨ <code>Protocol.Type</code> è¿™æ ·çš„æ¨¡å—ä¸­çš„, è€Œä¸å†æ·»åŠ å¤–éƒ¨æ¨¡å—çš„å‰ç¼€.</p>
<p>ä¾‹å¦‚ä¸‹é¢çš„ä»£ç ç¬¬ 5 ~ 10 è¡Œ,
æˆ‘ä»¬åœ¨ <code>TimeSpan</code> æ¨¡å—çš„å®šä¹‰çš„ä¸Šä¸‹æ–‡ä¸­, ä¸º <code>TimeSpan</code> ç±»å‹å®ç° <code>Coner.Addable</code> åè®®.
è¿™æ–°çš„å®ç°, æ˜¯ä½äºæ¨¡å— <s>Corner.TimeSpan.</s>Corner.Addable.Corner.TimeSpan ä¸­,
è¿™é‡Œæ²¡æœ‰æ·»åŠ å¤–éƒ¨æ¨¡å—çš„å‰ç¼€ <strong>Corner.TimeSpan</strong>.</p>
<p>ä¹Ÿå°±æ˜¯è¯´, <code>defimpl Protocol, for: Type</code> æ— è®ºåœ¨å“ªé‡Œ, éƒ½ä¸€æ ·å±•å¼€ä¸º <code>Protocol.Type</code>,
è€Œä¸ä¼šå› ä¸ºåµŒå¥—åœ¨å…¶ä»–æ¨¡å—ç»“æ„ä¸­, è€Œæ·»åŠ æ–°çš„å‰ç¼€.</p>
<pre><code class="language-elixir">defmodule Corner.TimeSpan do
  defstruct hour: 0, min: 0, second: 0
  alias Corner.{Addable, TimeSpan}

  defimpl Addable, for: __MODULE__ do
    def add(a, b) do
      %{hour: h1, min: m1, second: s1} = a
      %{hour: h2, min: m2, second: s2} = b
      # %__MODULE__{hour: h1 + h2, min: m1 + m2, second: s1 + s2}
      %TimeSpan{hour: h1 + h2, min: m1 + m2, second: s1 + s2}
    end

    IO.inspect(__MODULE__, label: &quot;__MODULE__&quot;)
  end
end
</code></pre>
<p>åœ¨è¿™ç§æ¨¡å—åµŒå¥—çš„ä»£ç ä¸­, è¦ç‰¹åˆ«ç•™æ„ä¸Šä¸‹æ–‡. è¯·æ³¨æ„ä¸Šé¢çš„ä»£ç ç‰‡æ®µä¸­çš„ <code>__MODULE__</code>,
åœ¨ä¸åŒçš„ä¸Šä¸‹æ–‡ä¸­, å…¶å±•å¼€ç»“æœæ˜¯ä¸ä¸€æ ·çš„.
ç¬¬ 5 è¡Œçš„ <code>__MODULE__</code> å±•å¼€ä¸º <code>Corner.TimeSpan</code> åœ¨æ„æ–™ä¹‹ä¸­.
ä½†æ˜¯ç¬¬ 12 è¡Œçš„ <code>__MODULE__</code> å±•å¼€æ˜¯ä»€ä¹ˆå‘¢? æˆ–è€…è¯´,
ç¬¬ 8 è¡Œçš„æœ€ç»ˆçš„è¯­ä¹‰å’Œç¬¬ 9 è¡Œä¸€æ ·å—? é€šè¿‡æ§åˆ¶å°çš„è¾“å‡º,
æˆ‘ä»¬çŸ¥é“æ˜¯ç¬¬ 13 è¡Œçš„ <code>__MODULE__</code> å±•å¼€ä¸º <code>Corner.Addable.Corner.TimeSpan</code>.
å› æ­¤ä¸éš¾æ¨æµ‹, æ³¨é‡Šæ‰çš„ç¬¬ 9 è¡Œ, å…¶è¯­ä¹‰ä¸ç¬¬ 10 è¡Œçš„æ˜¯ä¸åŒçš„.
è™½ç„¶ä¸Šé¢çš„è®¨è®ºå·²ç»çŸ¥é“ <code>defimpl</code> æ˜¯è¦å®šä¹‰ä¸€ä¸ªæ–°çš„æ¨¡å—,
ä½†æ˜¯æˆ‘ç¬¬ä¸€æ¬¡ç¼–ç çš„æ—¶å€™, è¿˜æ˜¯çŠ¯äº†ç¬¬ 9 è¡Œè¿™æ ·çš„é”™.</p>
<p>å› ä¸º <code>defprotocol</code> å’Œ <code>defimpl</code> å®é™…ä¸Šæ˜¯è¦åˆ›å»ºæ¨¡å—,
é™¤äº† <code>defprotocol</code> å¯¹æ ¸å¿ƒæ¨¡å—çš„å°‘æ•°å‡ ä¸ªå®åšäº†é™åˆ¶å¤–<sup class="footnote-reference"><a href="#protocol">1</a></sup>,
å¤§éƒ¨åˆ†çš„åŠŸèƒ½å¹¶æ²¡æœ‰é™åˆ¶, æ‰€ä»¥å°±åƒæˆ‘ä»¬å¯ä»¥åœ¨ <code>defmodule/2</code> çš„ä¸Šä¸‹æ–‡ä¸­æ‰§è¡Œ
<code>def*</code> ä»¥å¤–çš„å…¶ä»–è¡¨è¾¾å¼é‚£æ ·, åœ¨ <code>defprotocol</code> å’Œ <code>defimpl</code> ä¸Šä¸‹æ–‡ä¸­ä¹Ÿå¯ä»¥è¿™æ ·åš.</p>
<div class="footnote-definition" id="protocol"><sup class="footnote-definition-label">1</sup>
<p>è§ Elixir åè®®æ¨¡å—æºç çš„ ç¬¬<a href="https://github.com/elixir-lang/elixir/blob/7e4fbe657dbf9c3e19e3d2bd6c17cc6d724b4710/lib/elixir/lib/protocol.ex#L684">690~703</a> è¡Œ.</p>
</div>
<p>ç°åœ¨æˆ‘ä»¬çŸ¥é“äº†, <code>defimpl</code> å¯ä»¥åµŒå¥—åˆ° <code>defmodule/2</code> ä¸­, é‚£ä¹ˆ <code>defimpl</code>
å†…éƒ¨å¯ä»¥åµŒå¥— <code>defimpl</code> è°ƒç”¨å—?
æˆ–è€…å†æ¨å¹¿ä¸€ä¸‹: <code>defimpl</code> éƒ½å¯ä»¥åœ¨ä»€ä¹ˆæ ·çš„ä¸Šä¸‹æ–‡ä¸­è°ƒç”¨å‘¢?</p>
<p>ä»¥å‰çš„ç« èŠ‚ä¸­, æˆ‘ä»¬è§åˆ°çš„ <code>defimpl</code> è°ƒç”¨çš„ä¸Šä¸‹æ–‡æœ‰:</p>
<ul>
<li>é¡¶å±‚ä½œç”¨åŸŸ</li>
<li><code>defmodule/2</code> ä½œç”¨åŸŸ</li>
</ul>
<p>å‰©ä¸‹çš„ä½œç”¨è¿˜æœ‰å¦‚ä¸‹å‡ ä¸ª:</p>
<ul>
<li><code>defprotoc</code></li>
<li><code>defimpl</code></li>
<li><code>def</code>, <code>defp</code>, <code>defmacro</code> <code>defmacop</code></li>
</ul>
<p>é¦–å…ˆ, ä¸å¯ä»¥ç›´æ¥åœ¨ <code>defprotoc</code> çš„ä¸Šä¸‹æ–‡ä¸­, ä½¿ç”¨ <code>defimpl</code> ä¸ºæ­£åœ¨å®šä¹‰çš„åè®®æä¾›å®ç°.</p>
<pre><code class="language-elixir">defprotocol Addable2 do
  def add(a, b)

  defimpl Addable2, for: Integer do
    def add(a, b) do
      a + b
    end
  end
end
</code></pre>
<p>ç¼–è¯‘è¿™æ®µä»£ç , å¾—åˆ°äº†ç¼–è¯‘é”™è¯¯.
é”™è¯¯æ˜¯ <code>defimpl</code> å¼•å‘çš„, é”™è¯¯çš„åŸå› æ˜¯ä¸èƒ½åŠ è½½æ¨¡å— <code>Addable2</code>.
è¿™è¯´æ˜, è°ƒç”¨ <code>defimpl</code> çš„æ—¶å€™, ä¼šåŠ è½½ <code>:for</code> é€‰é¡¹æŒ‡å®šçš„æ¨¡å—.
ç°åœ¨è¿˜æ²¡æœ‰å®Œæˆ <code>Addable2</code> æ¨¡å—çš„å®šä¹‰, æ‰€ä»¥åŠ è½½è¿™ä¸ªæ¨¡å—è‡ªç„¶æ˜¯å¤±è´¥çš„.</p>
<p>ä½†æ˜¯æˆ‘ä»¬å¯ä»¥åœ¨åè®®å®šä¹‰çš„ä¸Šä¸‹æ–‡ä¸­, ä¸ºå…¶ä»–åè®®æä¾›å®ç°å—? ç­”æ¡ˆæ˜¯å¯ä»¥çš„.</p>
<pre><code class="language-elixir">defprotocol Corner.Addable2 do
  # def add1(a)
  defimpl Corner.Addable, for: String do
    Kernel.def(add(a, b), do: a &lt;&gt; b)
  end

  Kernel.def say_hello() do
    IO.puts(&quot;Hello&quot;)
  end
end

Corner.Addable2.say_hello()
</code></pre>
<p>ä½†æ˜¯è¦æ³¨æ„ç¬¬ 4 è¡Œ, è¿™é‡Œä½¿ç”¨ <code>Kernel.def</code> è¿œç¨‹æ–¹æ³•è°ƒç”¨çš„è¯­æ³•æ¥è°ƒç”¨ <code>def/2</code>,
å› ä¸ºåœ¨ <code>defprotocol</code> ä¸Šä¸‹æ–‡ä¸­, ç‰¹æ„æ’é™¤äº†æ ¸å¿ƒæ¨¡å— <code>def/2</code> çš„å¯¼å…¥.</p>
<p>åœ¨å®éªŒä¸Šé¢çš„ä»£ç ç‰‡æ®µå‰, æˆ‘ä»¥ä¸º <code>defprotocol</code> ä¸Šä¸‹æ–‡ä¸­, å¿…é¡»æœ‰ <code>def/1</code> è¯­å¥,
ä½†æ˜¯ç°åœ¨æ˜ç™½, ä¸æ˜¯çš„. èµ·åˆè¿˜ä»¥ä¸º, <code>defprotocl</code> ä¸Šä¸‹æ–‡ä¸­, ä¸å¯ä»¥å®šä¹‰è‡ªå·±çš„å‡½æ•°,
ç°åœ¨å‘ç°, å¯ä»¥ä½¿ç”¨è¿œç¨‹æ–¹æ³•è°ƒç”¨çš„è¯­æ³•, ç”¨ <code>Kernel.def/2</code> æ¥å®šä¹‰è‡ªå·±çš„å‡½æ•°;
å°±åƒä¸Šé¢çš„ä»£ç ç¬¬ 7~9 è¡Œä¸­é‚£æ ·.</p>
<p>æœ€åå¼ºè°ƒä¸€ä¸‹: è™½ç„¶å¯ä»¥åƒä¸Šé¢çš„ä»£ç ç‰‡æ®µé‚£æ ·, ç”¨ <code>defprotocol</code> æ¥å®šä¹‰æ¨¡å—,
ä½†æ˜¯ç»å¯¹ä¸æ¨èè¿™æ ·åš.</p>
<p><strong>ç»“è®º</strong>: åœ¨ <code>defprotcoc</code> å®šä¹‰çš„ä¸Šä¸‹æ–‡ä¸­, ä¸èƒ½ä¸ºæ­£åœ¨å®šä¹‰çš„åè®®çš„æä¾›å®ç°.
æˆ–è€…è¯´, å®è°ƒç”¨ <code>defimpl Protocol,...</code>, ä¸­çš„ <code>Protocol</code> å¯¹åº”çš„æ¨¡å—å¿…é¡»æ˜¯é—­åˆçš„.</p>
<p>é‚£ä¹ˆ <code>defimpl</code> å¯ä»¥åµŒå¥—è‡ªå·±å—?</p>
<pre><code class="language-elixir">defimpl Corner.Addable, for: Tuple do
  def add(a, b) do
    Tuple.append(a, b)
  end

  defimpl Corner.Addable, for: BitString do
    def add(a, b) do
      a &lt;&gt; b
    end
  end
end
</code></pre>
<p><strong><code>defimpl</code> ä¸­å¯ä»¥åµŒå…¥ <code>defimpl</code>; <code>defimpl</code> åœ¨ <code>defimpl</code> è°ƒç”¨çš„ä¸Šä¸‹æ–‡ä¸­,
ä¸åœ¨é¡¶å±‚çš„ä½œç”¨åŸŸä¸Šä¸‹æ–‡ä¸­, æ²¡æœ‰åŒºåˆ«</strong>.</p>
<p>è¿™è¿˜çœŸçš„å‡ºä¹æˆ‘çš„æ„æ–™. ä½†æ˜¯è¿™æ ·åš, é™¤äº†è®©ä»£ç å˜å¾—ä¸‘é™‹å¤–, ä¸€ç‚¹å…¶ä»–ç”¨å¤„ä¹Ÿæ²¡æœ‰.</p>
<p><code>def</code> å’Œ <code>defp</code> æ˜¯ç”¨æ¥åœ¨æ¨¡å—ä¸­å®šä¹‰å‡½æ•°çš„. å‡½æ•°ä¸å¯ä»¥åµŒå¥—å®šä¹‰,
æ‰€ä»¥æˆ‘é¢„è®¡, åœ¨ <code>def</code> ä¸Šä¸‹æ–‡ä¸­, æ˜¯ä¸å¯ä»¥è°ƒç”¨ <code>defimpl</code> çš„.
ä½†æ˜¯è¿˜æ˜¯è®©æˆ‘ä»¬å®éªŒä¸€ä¸‹å§.</p>
<pre><code class="language-elixir">defmodule EmbedImplToFun do
  def fun() do
    defimpl Addable, for: Tuple do
      def add(a, b) do
        Tuple.concat(a, b)
      end
    end
  end
end
</code></pre>
<p>åˆè¶…å‡ºäº†é¢„æœŸäº†, å±…ç„¶å¯ä»¥!</p>
<p>é‚£ä¹ˆå¯ä»¥é¢„æœŸ, åœ¨ <code>def</code> ä¸­ä¹Ÿæ˜¯å¯ä»¥è°ƒç”¨ <code>defmodule/2</code>.</p>
<p>Elixir ä¸­ä¸å…è®¸å‘½åå‡½æ•°åµŒå¥—, ä½†æ˜¯çŸ¥é“äº†ä¸Šé¢çš„çŸ¥è¯†,
æˆ‘ä»¬å°±å¯ä»¥è®©å‡½æ•°è¿”å›æ¨¡å—, ç„¶ååœ¨æ¨¡å—ä¸­å®šä¹‰å‘½åå‡½æ•°,
ä»¥è¿™ç§è¿‚å›çš„æ–¹å¼æ¥å®ç°å‡½æ•°çš„åµŒå¥—.</p>
<p>è¯¦ç»†è®¨è®ºè§<a href="./ch12.cold_knowledge.html">å†·çŸ¥è¯†ç« èŠ‚</a>.</p>
<h2 id="åè®®å¯¹å‡½æ•°çš„é™åˆ¶ä¸è¾…åŠ©"><a class="header" href="#åè®®å¯¹å‡½æ•°çš„é™åˆ¶ä¸è¾…åŠ©">åè®®å¯¹å‡½æ•°çš„é™åˆ¶ä¸è¾…åŠ©</a></h2>
<p>è®©æˆ‘ä»¬å†å›åˆ°å¯¹åè®®çš„è®¨è®ºä¸Šæ¥.</p>
<p>åè®®çœ‹èµ·æ¥è¶³å¤Ÿçš„ç®€å•. ä¼¼ä¹ <code>defprotocol</code> åªæ˜¯ä½œäº†é™åˆ¶çš„ <code>defmodule/2</code>: å…¶ä¸Šä¸‹æ–‡ä¸­,
åªèƒ½ä½¿ç”¨ <code>def/1</code> å®.</p>
<p>ä½†æ˜¯å®é™…ä¸Šä¸æ˜¯è¿™ä¹ˆç®€å•çš„.</p>
<p>é¦–å…ˆåè®®å¯¹å…¶ä¸­çš„å®šä¹‰å‡½æ•°æ˜¯æœ‰é™åˆ¶çš„: åè®®ä¸­çš„å‡½æ•°, ä¸å¯ä»¥ä¸ºé›¶å…ƒå‡½æ•°.
æ‰€ä»¥åœ¨ <code>defprotocol</code> ä¸Šä¸‹æ–‡ä¸­ä½¿ç”¨çš„ <code>def/1</code> æ˜¯é‡æ–°å®šä¹‰çš„, è€Œä¸æ˜¯å¯¼å…¥çš„
<code>Kernel.def/1</code>. å½“æˆ‘ä»¬åœ¨åè®®ä¸­å®šä¹‰é›¶å…ƒå‡½æ•°çš„æ—¶å€™, ä¼šå¼•å‘ç¼–è¯‘é”™è¯¯.</p>
<pre><code class="language-elixir">defprotocol ZeroArityFun do
  def sayHi()
end
</code></pre>
<p>ä¸Šé¢æˆ‘ä»¬å±•ç¤ºäº†, <code>defprotocol</code> å¯¹ <code>def/1</code> çš„é™åˆ¶;
æ¥ä¸‹æ¥, æˆ‘ä»¬ä¼šçœ‹åˆ°åè®®å¯¹å‡½æ•°ä¹Ÿæœ‰è¾…åŠ©:
åè®®ä¼šå¯¹å…¶ä¸­å®šä¹‰çš„å‡½æ•°çš„ç¬¬ä¸€ä¸ªå‚æ•°åšç±»å‹æ£€æŸ¥.</p>
<pre><code class="language-elixir">defprotocol Corner.Protocol do
  def sub_one(a)
  def add_one(a)
end

alias Corner.Protocol

defimpl Protocol, for: Integer do
  def sub_one(a) do
    IO.puts(&quot;sub_one(i)&quot;)
    a - 1
  end

  def add_one(a) do
    a + 1
  end
end

defimpl Protocol, for: Float do
  def sub_one(a) do
    IO.puts(&quot;sub_one(f)&quot;)
    a - 1
  end

  def add_one(a), do: a + 1
end

defimpl Protocol, for: BitString do
  def sub_one(&lt;&lt;_::utf8, rest::binary&gt;&gt;) do
    rest
  end

  def add_one(a), do: a &lt;&gt; &quot;one&quot;
end

Protocol.sub_one(1)
Protocol.sub_one(1.0)
Protocol.sub_one(&quot;Hello&quot;)
Protocol.add_one(1) |&gt; IO.inspect(label: &quot;add_one(1)&quot;)
Protocol.add_one(1.0) |&gt; IO.inspect(label: &quot;add_one(1.0)&quot;)
Protocol.add_one(&quot;One + &quot;) |&gt; IO.inspect(label: &quot;add_one(\&quot;One + \&quot;)&quot;)
</code></pre>
<p>å®é™…ä¸Š, åè®®å¯¹å‡½æ•°çš„è¾…åŠ©, åªæ˜¯å®ç°å¯¹æ¨¡å—çš„åŠ¨æ€è°ƒåº¦çš„è‡ªç„¶ç»“æœ;
è€Œå¯¹å‡½æ•°çš„é™åˆ¶, åˆ™æ˜¯å®ç°åŠ¨æ€è°ƒåº¦çš„å¿…ç„¶è¦æ±‚.</p>
<p>åè®®å®é™…å¸®åŠ©æˆ‘ä»¬æ¶ˆå¼­æ¨¡å—å, æ¥å®ç°å‡½æ•°çš„åŠ¨æ€è°ƒåº¦.
ä½†æ˜¯ Elixir åŠ¨æ€è°ƒåº¦åªèƒ½é€šè¿‡æ¨¡å¼åŒ¹é…æ¥å®Œæˆ.
å‡½æ•°è°ƒç”¨çš„åŒ¹é…åŒ…æ‹¬ä¸€ä¸‹å†…å®¹çš„åŒ¹é…:</p>
<ol>
<li>æ¨¡å—å</li>
<li>å‡½æ•°å</li>
<li>å‚æ•°æ¨¡å¼, guard å­å¥</li>
</ol>
<ul>
<li>åè®®è¦åŠ¨æ€è°ƒåº¦, å°±æ˜¯è¦æ¶ˆé™¤æ¨¡å—ä¹‹é—´çš„å·®å¼‚çš„, æ‰€ä»¥åœ¨è¿™é‡Œ, æ¨¡å—ä¸èƒ½ä½œä¸ºåŠ¨æ€è°ƒåº¦çš„ä¾æ®äº†.</li>
<li>åè®®çš„å®ç°ä¸­, å‡½æ•°åéƒ½æ˜¯ä¸€æ ·çš„, æ‰€ä»¥å®ƒè‡ªç„¶ä¹Ÿä¸èƒ½ç”¨ä½œåŠ¨æ€è°ƒåº¦çš„ä¾æ®.</li>
<li>é›¶å…ƒå‡½æ•°, å› ä¸ºæ²¡æœ‰å‚æ•°, æ‰€ä»¥æœ€åå¯ä»¥ç”¨æ¥åŒºåˆ†ä¸åŒå‡½æ•°çš„å› å­, ä¹Ÿä¸å†æœ‰ç”¨.</li>
</ul>
<p>è¿™å°±æ˜¯åè®®ä¸Šä¸‹æ–‡ä¸­è¦æ±‚ <code>def/1</code> å®šä¹‰çš„å‡½æ•°, å¿…é¡»è‡³å°‘å«æœ‰ä¸€ä¸ªå‚æ•°çš„åŸå› .</p>
<p>ä¸Šé¢æˆ‘ä»¬çœ‹åˆ°äº†, åè®®çš„ç¡®åšåˆ°äº†å¯¹åè®®å®ç°æ¨¡å—çš„åŠ¨æ€è°ƒåº¦. ä½†æ˜¯å®ƒæ˜¯å¦‚ä½•åšåˆ°çš„å‘¢?</p>
<h2 id="åè®®åŠ¨æ€è°ƒåº¦"><a class="header" href="#åè®®åŠ¨æ€è°ƒåº¦">åè®®åŠ¨æ€è°ƒåº¦</a></h2>
<p>Elixir åè®®æ¨¡å—æ–‡æ¡£çš„<a href="https://hexdocs.pm/elixir/Protocol.html#module-reflection">åå°„ç« èŠ‚</a>,
å‘Šè¯‰æˆ‘ä»¬: æ¯ä¸ªåè®®æ¨¡å—, éƒ½ä¼šåŒ…å«äº†ä»¥ä¸‹ä¸‰ä¸ªç”¨æ¥å®Œæˆ, åè®®åŠå…¶å®ç°æ¨¡å—çš„åå°„æ“ä½œçš„å‡½æ•°:</p>
<ol>
<li><code>__protocol__/1</code> è¿”å›è¿™ä¸ªåè®®æ¨¡å—çš„ç›¸å…³çš„å…ƒä¿¡æ¯.</li>
<li><code>impl_for/1</code> è¿”å›ç»™å®šæ•°æ®çš„å¤„ç†æ¨¡å—, æˆ–è€…è¿”å› <code>nil</code>.</li>
<li><code>impl_for!/1</code> å’Œä¸Šé¢çš„å‡½æ•°ç±»ä¼¼, ä½†æ˜¯å¦‚æœæ²¡æœ‰æ‰¾åˆ°å¯¹åº”çš„å®ç°çš„è¯, ä¼šå¼•å‘å¼‚å¸¸.</li>
</ol>
<p>æ‰€ä»¥é€šè¿‡ <code>impl_for</code> æˆ– <code>impl_for!</code> å¯ä»¥å®Œæˆå¯¹å®ç°æ¨¡å—çš„åŠ¨æ€è°ƒç”¨.
æ¯”å¦‚æˆ‘ä»¬ä¸Šé¢å®šä¹‰çš„ <code>Corner.Addable</code> åè®®,
<code>defprotocol</code> å¯¹åº”çš„æ¨¡å—ä¸­, <code>add/2</code> å‡½æ•°å°±å¯ä»¥éå¸¸ç®€å•çš„è¿™æ ·æ¥å®ç°<sup class="footnote-reference"><a href="#generater">2</a></sup>:</p>
<pre><code class="language-elixir">defmodule Corner.Addable do
  #...
  def add(a,b) do
    m = impl_for!(a)
    m.add(a,b)
  end
end
</code></pre>
<div class="footnote-definition" id="generater"><sup class="footnote-definition-label">2</sup>
<p>è¿™æ˜¯æˆ‘çš„çŒœæµ‹, æ‰€ä»¥ <code>defpotocol</code> çœŸæ­£äº§ç”Ÿçš„ä»£ç å’Œè¿™é‡Œçš„ä»£ç è‚¯å®šä¸ä¸€æ ·.</p>
</div>
<p>ä½†æ˜¯ <code>impl_for</code> å’Œ <code>impl_for!</code> åˆæ˜¯å¦‚ä½•å®Œæˆå®ƒä»¬çš„å·¥ä½œçš„å‘¢?</p>
<p>å‰é¢æˆ‘ä»¬å·²ç»çŸ¥é“, åè®®çš„å®ç°æ¨¡å—çš„æ¨¡å—åéƒ½æ˜¯ä»¥åè®®æ¨¡å—çš„æ¨¡å—åä¸ºå‰ç¼€çš„.
è¦å®Œæˆ <code>impl_for</code> å’Œ <code>impl_for!</code> å¯ä»¥åˆ†æˆä¸¤æ­¥èµ°:</p>
<ol>
<li>åœ¨è¿è¡Œæ—¶è·å–æ‰€æœ‰çš„æ¨¡å—, å¹¶ä¾æ®æ¨¡å—åç­›é€‰å‡ºä»¥åè®®åä¸ºå‰ç¼€çš„æ¨¡å—.
ä½†æ˜¯è¿™æ ·æ‰¾å‡ºçš„æ¨¡å—ä¸èƒ½ä¿è¯å°±ä¸€å®šæ˜¯åè®®çš„å®ç°.</li>
<li>æ¢æµ‹è¿™äº›æ‰¾åˆ°çš„æ¨¡å—çš„å…ƒä¿¡æ¯, æ¥ç¡®è®¤æ¨¡å—æ˜¯å¦çš„ç¡®æ˜¯åè®®çš„å®ç°.</li>
</ol>
<p>é‚£ä¹ˆç¬¬ä¸€ä¸ªå…³é”®å°±æ˜¯å¦‚ä½•åœ¨è¿è¡Œæ—¶è·å–ç³»ç»Ÿä¸­çš„æ¨¡å—å‘¢?
Erlang çš„æ ‡å‡†åº“çš„ <code>:code</code> æ¨¡å—æä¾›äº†è¿™æ ·ä¸¤ä¸ªå‡½æ•°:</p>
<ol>
<li><code>all_available/0</code></li>
<li><code>all_loaded/0</code></li>
</ol>
<p>é¡¾åæ€ä¹‰, è¿™ä¸¤ä¸ªå‡½æ•°: ç¬¬ä¸€ä¸ªç”¨æ¥è·å–æ‰€æœ‰çš„å¯ä»¥åŠ è½½åˆ°ç³»ç»Ÿä¸­çš„æ¨¡å—;
ç¬¬äºŒä¸ªç”¨æ¥è·å–æ‰€æœ‰åŠ è½½åˆ°ç³»ç»Ÿä¸­çš„æ¨¡å—.</p>
<p>çŸ¥é“äº†è¿™äº›çŸ¥è¯†, ç¬¬ä¸€æ­¥å°±ä¸éš¾å®Œæˆäº†.</p>
<p>æ¥ä¸‹æ¥æˆ‘ä»¬æ¢ç´¢ä¸€ä¸‹, <code>defprotocl</code> å’Œ <code>defimpl</code> å¦‚ä½•é…åˆ,
ä»¥ä¾¿å¯ä»¥é€šè¿‡æ¨¡å—çš„å…ƒä¿¡æ¯æ¥ç¡®è®¤æŸä¸ªæ¨¡å—æ˜¯åè®®çš„å®ç°çš„.
åè®®çš„å®ç°æ¨¡å—, æœ‰ä¸€ä¸ª <code>:__protocol__</code> å±æ€§, å…¶å€¼ä¸º:
<code>[protocol: Protocol, for: Type]</code>.
æˆ‘ä»¬å¯ä»¥é€šè¿‡ <code>ProtoclImpl.__info__(:attributes)</code> æˆ–
<code>Module.module_info(:attributes)</code>æ¥è·æ¨¡å—çš„æ‰€æœ‰çš„å±æ€§.
è¿™ä¸¤ä¸ªå‡½æ•°è¿”å›çš„éƒ½æ˜¯å…³é”®å­—åˆ—è¡¨, å› æ­¤æˆ‘ä»¬å¯ä»¥é€šè¿‡ Access è¡Œä¸ºæ¥è·å– <code>:__protocol__</code>
å¯¹åº”çš„å€¼. ä¸‹é¢çš„ä»£ç , è·å–äº† <code>Corner.Addable.Integer</code> æ¨¡å—çš„
<code>:__protocol__</code> å±æ€§çš„å€¼:</p>
<pre><code class="language-elixir">Corner.Addable.Integer.module_info(:attributes)[:__protocol__]
</code></pre>
<p>æ‰€ä»¥ç¬¬äºŒæ­¥ä¹Ÿå°±éå¸¸æ¸…æ¥šäº†.</p>
<ol>
<li>æ ¹æ®æ•°æ®, åˆ¤æ–­å¯¹åº”çš„æ¨¡å—. æˆ‘æƒ³ç›¸åº”çš„ä»£ç , å¤§æ¦‚æ˜¯è¿™æ ·çš„:
<pre><code class="language-elixir">def data_to_module(d) do
  cond do
    is_tuple(d) -&gt; Tuple
    is_atom(d) -&gt; Atom
    is_list(d) -&gt; List
    is_bitstring(d) -&gt; BitString
    is_integer(d) -&gt; Integer
    is_float(d) -&gt; Float
    is_function(d) -&gt; Function
    is_pid(d) -&gt; PID
    is_map(d) -&gt; Map
    is_port(d) -&gt; Port
    is_reference(d) -&gt; Reference
    is_struct(d) -&gt; :struct
    _ -&gt; Any
  end
end
</code></pre>
</li>
<li>æ ¹æ®åè®®å®ç°çš„ <code>:__protoco__</code> å±æ€§å€¼, æ¥æ‰¾åˆ°åˆé€‚çš„å¤„ç†æ¨¡å—, ä»£ç å¤§æ¦‚æ˜¯è¿™æ ·:
<pre><code class="language-elixir">def filter([protocol: pro, for: mod ], d) do
  t = data_to_module(d)
  if t == :struct and %mod{} = d do
    true
  else
    mod == t
  end
end
</code></pre>
</li>
</ol>
<p>é‚£ä¹ˆ <code>imp_for</code> å’Œ <code>impl_for!</code> å¤§æ¦‚å°±æ˜¯è¿™æ ·çš„:</p>
<pre><code class="language-elixir">def impl_for(d) do
  :code.all_loaded()
  |&gt; Enum.map(&amp;elem(&amp;1,0))
  |&gt; Enum.filer(&amp;by_module_name_prfix(&amp;1,__MODULE__))
  |&gt; Enum.find(nil, &amp;filter(&amp;1.module_info(:attributes)[:__impl__], d))
end
def impl_for!(d) do
  t = impl_for(d)
  if t, do: t, else: raise Protocol.UndefinedError, d
end
</code></pre>
<h2 id="elixir-çš„å®ç°"><a class="header" href="#elixir-çš„å®ç°">Elixir çš„å®ç°</a></h2>
<p>åœ¨æˆ‘è‡ªå·±æ„æ€ä»¥ä¸Šçš„å®ç°å, æˆ‘å‘ç°, æˆ‘èƒ½çœ‹æ‡‚ Elixir çš„ <code>impl_for</code> çš„å®ç°äº†.
å…¶æºç åœ¨äº<a href="https://github.com/elixir-lang/elixir/blob/v1.13.1/lib/elixir/lib/protocol.ex#L817">protocol.ex çš„ç¬¬ 817 ~ 877è¡Œ</a>.</p>
<p>å¦‚æœæŠŠå…¶ä¸­çš„å®å±•å¼€çš„è¯, ä»£ç æ˜¯è¿™æ ·çš„:</p>
<pre><code class="language-elixir">defmacrop any_impl_for()do
  if @fallback_to_any do
    quote do: unquote(__MODULE__.Any).__impl__(:target)
  else
    nil
  end
end

@spec impl_for(term) :: atom | nil
def impl_for(data)

# What is this _v_ ?
def impl_for(%struct{}) do
  struct_impl_for(struct)
end

def impl_for(data) when is_integer(data) do
  # Note this one.....................v
  target = Module.concat(__MODULE__, Integer)
  try do
      target.__impl__(:target)
  rescue
    UndefinedFunctionError -&gt; any_impl_for
  end
end
def impl_for(data) when is_float(data) do
  # Note this one.....................v
  target = Module.concat(__MODULE__, Float)
  try do
    target.__impl__(:target)
  rescue
    UndefinedFunctionError -&gt; any_impl_for
  end
end

...

def impl_for(_) do
  any_impl_for
end
defp struct_impl_for(struct) do
  target = Module.concat(__MODULE__, struct)
  try do
    target.__impl__(:target)
  rescue
    UndefinedFunctionError -&gt; any_impl_for
  end
end
</code></pre>
<p>è¿™æ ·çš„å®ç°, ç¡®å®é«˜æ˜. å®çš„ä»£ç å…± 60 è¡Œ; æ¯ä¸ªåŸºç¡€ç±»å‹, å±•å¼€å 8 è¡Œä»£ç ,
å…¨éƒ¨åŸºç¡€ç±»å‹çš„ <code>impl_for</code> å­å¥å°±æœ‰: $8\times 11 = 88$ è¡Œ.
æˆ‘è¿™é‡Œçš„ä»£ç æ‰€ä»¥çŸ­, æ˜¯å› ä¸ºæˆ‘åªå¯¹ Integer å’Œ Float åšäº†å±•å¼€,
å…¶ä»– 9 ä¸ªåŸºæœ¬ç±»å‹çš„è´¦å·, éƒ½ç”¨ <code>...</code> ä»£æ›¿çš„ç¼˜æ•….</p>
<p>é€šè¿‡æŸ¥çœ‹ Elixir çš„æºç , è¿˜å¯ä»¥çŸ¥é“, æ¯ä¸ªåè®®çš„å®ç°æ¨¡å—ä¸­éƒ½æœ‰ä¸€ä¸ª
<code>__impl__(:target)</code> å‡½æ•°. è¿™æ˜¯ <code>defimpl</code> ä¸ <code>defprotocol</code>
æ‰“çš„é…åˆ, ä¸ºçš„æ˜¯æ¶ˆé™¤å‘½åå†²çª.</p>
<p>Elixir çš„å®ç°, æ—¶é—´å¤æ‚åº¦ä¸º O(0), è€Œæˆ‘çš„å®ç°, å®é™…å¤æ‚å¤šä¸º O(1). ğŸ˜³</p>
<p>åœ¨ä¸Šé¢çš„ä»£ç ç‰‡æ®µçš„ç¬¬ 11 è¡Œ, æœ‰ä¸€ä¸ªä¸å¸¸è§çš„è¯­æ³•.
å¯¹ä¸€ä¸ªç»“æ„å¯¹è±¡ <code>struct_obj</code> æ¥è¯´, <code>%s{} = struct_obj</code>,
é‚£ä¹ˆå˜é‡ <code>s</code> ä¸­ç»‘å®šçš„å†…å®¹å°±æ˜¯ <code>struct_obj</code> ç»“æ„æ‰€åœ¨æ¨¡å—çš„åå­—.</p>
<pre><code class="language-elixir">defmodule Corner.Point do
  defstruct x: 0, y: 0
end

alias Corner.Point, as: P
obj = %P{}
%module{} = obj
module == Corner.Point # true
</code></pre>

                </main>

                <nav class="nav-wrapper" aria-label="Page navigation">
                    <!-- Mobile navigation buttons -->
                    <a rel="prev" href="ch09.module.html" class="mobile-nav-chapters previous"
                        title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next" href="ch11.macro.html" class="mobile-nav-chapters next"
                        title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>

                    <div style="clear: both"></div>
                </nav>
            </div>
        </div>

        <nav class="nav-wide-wrapper" aria-label="Page navigation">
            <a rel="prev" href="ch09.module.html" class="nav-chapters previous" title="Previous chapter"
                aria-label="Previous chapter" aria-keyshortcuts="Left">
                <i class="fa fa-angle-left"></i>
            </a>

            <a rel="next" href="ch11.macro.html" class="nav-chapters next" title="Next chapter"
                aria-label="Next chapter" aria-keyshortcuts="Right">
                <i class="fa fa-angle-right"></i>
            </a>
        </nav>

    </div>




    <script type="text/javascript">
        window.playground_copyable = true;
    </script>


    <script src="elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
    <script src="mark.min.js" type="text/javascript" charset="utf-8"></script>
    <script src="searcher.js" type="text/javascript" charset="utf-8"></script>

    <script src="clipboard.min.js" type="text/javascript" charset="utf-8"></script>
    <script src="highlight.js" type="text/javascript" charset="utf-8"></script>
    <script src="book.js" type="text/javascript" charset="utf-8"></script>

    <!-- Custom JS scripts -->
    <script type="text/javascript" src="theme/mermaid.min.js"></script>
    <script type="text/javascript" src="theme/mermaid-init.js"></script>


</body>

</html>