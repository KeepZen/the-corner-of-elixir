<!DOCTYPE html>
<html lang="encn-zh">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="generator" content="ExDoc v0.28.4">
    <meta name="project" content="The Corner of Elixir v4.0.0">

      <meta name="author" content="Keep Zen">

    <title>第十二章 进程 — The Corner of Elixir v4.0.0</title>
    <link rel="stylesheet" href="dist/elixir-b6f1ed5df9b1d42a7309.css" />

    <script src="dist/sidebar_items-1785d4c7ff.js"></script>

      <script src="docs_config.js"></script>

    <script async src="dist/app-bd1cb213813bf4825aa2.js"></script>

<style>
  a.footnote {
    vertical-align: super;
  }
  a.reversefootnote {
    display: inline-block;
    text-indent: -9999px;
    line-height: 0;
  }
  a.reversefootnote:after {
    content: '↩'; /* or any other text you want */
    text-indent: 0;
    display: block;
    line-height: initial;
  }
</style>

<script>
MathJax = {
tex: {
inlineMath: [['$', '$']]
}
};
</script>
<script id="MathJax-script" async
src="./assets/tex-chtml.js">
</script>

<script src="assets/mermaid.min.js"></script>
<script>
document.addEventListener("DOMContentLoaded", function () {
mermaid.initialize({ startOnLoad: false });
let id = 0;
for (const codeEl of document.querySelectorAll("pre code.mermaid")) {
  const preEl = codeEl.parentElement;
  const graphDefinition = codeEl.textContent;
  const graphEl = document.createElement("div");
  const graphId = "mermaid-graph-" + id++;
  mermaid.render(graphId, graphDefinition, function (svgSource, bindListeners) {
    graphEl.innerHTML = svgSource;
    bindListeners && bindListeners(graphEl);
    preEl.insertAdjacentElement("afterend", graphEl);
    preEl.remove();
  });
}
});
</script>

  </head>
  <body data-type="extras">
    <script>

      try {
        var settings = JSON.parse(localStorage.getItem('ex_doc:settings') || '{}');

        if (settings.theme === 'dark' ||
           ((settings.theme === 'system' || settings.theme == null) &&
             window.matchMedia('(prefers-color-scheme: dark)').matches)
           ) {
          document.body.classList.add('dark')
        }
      } catch (error) { }
    </script>

<div class="main">


<section class="sidebar">
  <button class="sidebar-button sidebar-toggle" aria-label="toggle sidebar">
    <i class="ri-menu-line ri-lg" title="Collapse/expand sidebar"></i>
  </button>

  <form class="sidebar-search" action="search.html">
    <button type="submit" class="search-button" aria-label="Submit Search">
      <i class="ri-search-2-line" aria-hidden="true" title="Submit search"></i>
    </button>
    <button type="button" tabindex="-1" class="search-close-button" aria-label="Cancel Search">
      <i class="ri-close-line ri-lg" aria-hidden="true" title="Cancel search"></i>
    </button>
    <label class="search-label">
      <p class="sr-only">Search</p>
      <input name="q" type="text" class="search-input" placeholder="Search..." aria-label="Input your search terms" autocomplete="off" />
    </label>
  </form>

  <div class="autocomplete">
    <div class="autocomplete-results">
    </div>
  </div>

  <div class="sidebar-header">

    <div class="sidebar-projectDetails">
      <a href="https://keepzen.github.io/the-corner-of-elixir" class="sidebar-projectName" translate="no">
The Corner of Elixir
      </a>
      <strong class="sidebar-projectVersion" translate="no">
        v4.0.0
      </strong>
    </div>
    <ul class="sidebar-listNav">
      <li><a id="extras-list-link" href="#full-list">Pages</a></li>


    </ul>
  </div>

  <div class="gradient"></div>
  <ul id="full-list" class="sidebar-fullList"></ul>
</section>

<section class="content">
  <output role="status" id="toast"></output>
  <div class="content-outer">
    <div id="content" class="content-inner">

<h1>
<button class="settings display-settings">
  <i class="ri-settings-3-line"></i>
  <span class="sr-only">Settings</span>
</button>


    <a href="https://github.com/keepzen/the-corner-of-elixir/blob/main/cn/ch12.process.md#L1" title="View Source" class="view-source" rel="help">
      <i class="ri-code-s-slash-line" aria-hidden="true"></i>
      <span class="sr-only">View Source</span>
    </a>

  <span>第十二章 进程</span>
</h1>

<h2 id="otp-平台的进程" class="section-heading">
  <a href="#otp-平台的进程" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i>
  <p class="sr-only">otp-平台的进程</p>
  </a>
  OTP 平台的进程
</h2>
<p>OTP 平台中, 进程与操作系统的进程不是同一个东西, 它们有许多相同的地方,
比如都是资源的调度单位, 但是 OTP 平台的进程是轻量级的, 比常规编程语言中的线程还轻量.
OTP 平台的天然的并发性与服务的自愈等特性, 都是建立在进程上的.</p><p>学习 Elixir, 基本语法之外, 更重要的就是对 OTP 平台的学习. 而要理解 OTP,
我们需要首先对 OTP 平台的进程模型有基本的认知.</p><p>在 OTP 平台, 进程是执行流和资源的分配单位. 每个进程都有自己的执行流, 
自己独立的调用栈和堆内存. 一个进程就是一个函数的执行环境. 当这个函数执行结束的时候,
进程的寿命也就结束了.</p><p>为了让进程可以持续的提供服务, 就必须使用递归调用, 在进程函数完成工作结束之前, 调用自己.</p><p>递归调用使得进程可以完成服务的工作, 但是这只是第一步,
一个无限循环如果不能从外部接受数据, 并给出回应的话, 除了消耗计算机的电力,
不见得有什么作用. OTP 平台提供了 <code class="inline">send(pid,message)</code> 函数向 <code class="inline">pid</code> 代表的进程发送信息;
<a href="https://hexdocs.pm/elixir/Kernel.SpecialForms.html#receive/1"><code class="inline">receive/1</code></a> 函数,  在进程内部接受数据.</p><p>这样在循环中, 通过 <a href="https://hexdocs.pm/elixir/Kernel.SpecialForms.html#receive/1"><code class="inline">receive/1</code></a> 接受外部的请求, 处理后通过 <code class="inline">send(pid,message)</code>
回应请求, 一个进程就可以向外部提供服务支持.</p><p>如果进程启动了, 但是并没有理会其他程序发送的消息, 该如何处理这些消息呢?
OTP 平台为每个进程提供了消息队列, 接收到消息后,
首先就是放到消息队列中, 程序执行的过程中, 遇到了 <a href="https://hexdocs.pm/elixir/Kernel.SpecialForms.html#receive/1"><code class="inline">receive/1</code></a> 语句,
就会对消息队列中的消息迭代 <a href="https://hexdocs.pm/elixir/Kernel.SpecialForms.html#receive/1"><code class="inline">receive/1</code></a> 方法, 如果消息匹配 <a href="https://hexdocs.pm/elixir/Kernel.SpecialForms.html#receive/1"><code class="inline">receive/1</code></a> 中模式,
那么这个消息就被消费掉了, 如果消息不匹配, 那么这个消息依旧保留在队列中.</p><p>当进程执行结束了, 如果进程中还有消息没有被处理,
这些消息会随着进程的结束而一起被系统归为垃圾.</p><p>启动一个进程的是核心模块的 <code class="inline">Kernel.spawn(fun)</code> 或 <code class="inline">Kernel.spawn(module,fun,args)</code>.</p><p><a href="https://hexdocs.pm/elixir/Kernel.SpecialForms.html#receive/1"><code class="inline">receive/1</code></a> 每次每次都只处理邮箱中的一个消息, 如果没有可以处理的消息,
而且 <code class="inline">recieve/1</code> 中没有 <code class="inline">after</code> 子句的话, <a href="https://hexdocs.pm/elixir/Kernel.SpecialForms.html#receive/1"><code class="inline">receive/1</code></a> 会阻塞进程, 等待匹配的消息到来.</p><p>如果有 <code class="inline">after</code> 子句, 超过指定的时间后, 没有消息进入邮箱的话, <a href="https://hexdocs.pm/elixir/Kernel.SpecialForms.html#receive/1"><code class="inline">receive/1</code></a> 会跳转到 <code class="inline">after</code>
子句, 执行后面的处理逻辑.</p><pre><code class="makeup elixir" translate="no"><span class="n">server_receive</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k" data-group-id="9156742429-1">fn</span><span class="w"> </span><span class="n">this</span><span class="w"> </span><span class="o">-&gt;</span><span class="w">
  </span><span class="p" data-group-id="9156742429-2">{</span><span class="ss">:messages</span><span class="p">,</span><span class="w"> </span><span class="n">messages</span><span class="p" data-group-id="9156742429-2">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Process</span><span class="o">.</span><span class="n">info</span><span class="p" data-group-id="9156742429-3">(</span><span class="n">self</span><span class="p" data-group-id="9156742429-4">(</span><span class="p" data-group-id="9156742429-4">)</span><span class="p">,</span><span class="w"> </span><span class="ss">:messages</span><span class="p" data-group-id="9156742429-3">)</span><span class="w">

  </span><span class="nc">IO</span><span class="o">.</span><span class="n">inspect</span><span class="p" data-group-id="9156742429-5">(</span><span class="n">messages</span><span class="p">,</span><span class="w"> </span><span class="ss">label</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;server message box have fellow messages&quot;</span><span class="p" data-group-id="9156742429-5">)</span><span class="w">

  </span><span class="k">receive</span><span class="w"> </span><span class="k" data-group-id="9156742429-6">do</span><span class="w">
    </span><span class="p" data-group-id="9156742429-7">{</span><span class="ss">:add</span><span class="p">,</span><span class="w"> </span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">,</span><span class="w"> </span><span class="n">client</span><span class="p" data-group-id="9156742429-7">}</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">send</span><span class="p" data-group-id="9156742429-8">(</span><span class="n">client</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="9156742429-9">{</span><span class="ss">:add</span><span class="p">,</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">b</span><span class="p" data-group-id="9156742429-9">}</span><span class="p" data-group-id="9156742429-8">)</span><span class="w">
    </span><span class="p" data-group-id="9156742429-10">{</span><span class="ss">:sub</span><span class="p">,</span><span class="w"> </span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">,</span><span class="w"> </span><span class="n">client</span><span class="p" data-group-id="9156742429-10">}</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">send</span><span class="p" data-group-id="9156742429-11">(</span><span class="n">client</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="9156742429-12">{</span><span class="ss">:sub</span><span class="p">,</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">b</span><span class="p" data-group-id="9156742429-12">}</span><span class="p" data-group-id="9156742429-11">)</span><span class="w">
    </span><span class="p" data-group-id="9156742429-13">{</span><span class="ss">:times</span><span class="p">,</span><span class="w"> </span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">,</span><span class="w"> </span><span class="n">client</span><span class="p" data-group-id="9156742429-13">}</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">send</span><span class="p" data-group-id="9156742429-14">(</span><span class="n">client</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="9156742429-15">{</span><span class="ss">:times</span><span class="p">,</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">b</span><span class="p" data-group-id="9156742429-15">}</span><span class="p" data-group-id="9156742429-14">)</span><span class="w">
    </span><span class="p" data-group-id="9156742429-16">{</span><span class="ss">:divs</span><span class="p">,</span><span class="w"> </span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">,</span><span class="w"> </span><span class="n">client</span><span class="p" data-group-id="9156742429-16">}</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">send</span><span class="p" data-group-id="9156742429-17">(</span><span class="n">client</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="9156742429-18">{</span><span class="ss">:div</span><span class="p">,</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">b</span><span class="p" data-group-id="9156742429-18">}</span><span class="p" data-group-id="9156742429-17">)</span><span class="w">
  </span><span class="k" data-group-id="9156742429-6">end</span><span class="w">

  </span><span class="n">this</span><span class="o">.</span><span class="p" data-group-id="9156742429-19">(</span><span class="n">this</span><span class="p" data-group-id="9156742429-19">)</span><span class="w">
</span><span class="k" data-group-id="9156742429-1">end</span><span class="w">

</span><span class="n">server_fun</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k" data-group-id="9156742429-20">fn</span><span class="w"> </span><span class="o">-&gt;</span><span class="w">
  </span><span class="nc">Process</span><span class="o">.</span><span class="n">sleep</span><span class="p" data-group-id="9156742429-21">(</span><span class="mi">100</span><span class="p" data-group-id="9156742429-21">)</span><span class="w">
  </span><span class="n">server_receive</span><span class="o">.</span><span class="p" data-group-id="9156742429-22">(</span><span class="n">server_receive</span><span class="p" data-group-id="9156742429-22">)</span><span class="w">
</span><span class="k" data-group-id="9156742429-20">end</span><span class="w">

</span><span class="n">server</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">spawn</span><span class="p" data-group-id="9156742429-23">(</span><span class="n">server_fun</span><span class="p" data-group-id="9156742429-23">)</span><span class="w">
</span><span class="n">client</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">self</span><span class="p" data-group-id="9156742429-24">(</span><span class="p" data-group-id="9156742429-24">)</span><span class="w">
</span><span class="n">send</span><span class="p" data-group-id="9156742429-25">(</span><span class="n">server</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="9156742429-26">{</span><span class="ss">:hello</span><span class="p">,</span><span class="w"> </span><span class="n">client</span><span class="p" data-group-id="9156742429-26">}</span><span class="p" data-group-id="9156742429-25">)</span><span class="w">
</span><span class="n">send</span><span class="p" data-group-id="9156742429-27">(</span><span class="n">server</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="9156742429-28">{</span><span class="ss">:add</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">client</span><span class="p" data-group-id="9156742429-28">}</span><span class="p" data-group-id="9156742429-27">)</span><span class="w">
</span><span class="n">send</span><span class="p" data-group-id="9156742429-29">(</span><span class="n">server</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="9156742429-30">{</span><span class="ss">:sub</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">client</span><span class="p" data-group-id="9156742429-30">}</span><span class="p" data-group-id="9156742429-29">)</span><span class="w">
</span><span class="n">send</span><span class="p" data-group-id="9156742429-31">(</span><span class="n">server</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="9156742429-32">{</span><span class="ss">:times</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="n">client</span><span class="p" data-group-id="9156742429-32">}</span><span class="p" data-group-id="9156742429-31">)</span><span class="w">
</span><span class="n">send</span><span class="p" data-group-id="9156742429-33">(</span><span class="n">server</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="9156742429-34">{</span><span class="ss">:divs</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="n">client</span><span class="p" data-group-id="9156742429-34">}</span><span class="p" data-group-id="9156742429-33">)</span></code></pre><p>在上面的代码中, <code class="inline">server_fun</code> 在另外一个进程中运行, 进程一启动, 立刻休眠了 100 ms,
这样可以显示出消息队列的变化. 控制台的输出中, 我们可以看到消息队列, 从五个慢慢减少为一个.
匹配消息按照入队的顺序被依次的处理, 不匹配 <code class="inline">receive</code> 模式的消息则留在队列中.</p><pre><code class="makeup elixir" translate="no"><span class="n">server</span><span class="w"> </span><span class="n">message</span><span class="w"> </span><span class="n">box</span><span class="w"> </span><span class="n">have</span><span class="w"> </span><span class="n">fellow</span><span class="w"> </span><span class="ss">messages</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="2198931433-1">[</span><span class="w">
  </span><span class="p" data-group-id="2198931433-2">{</span><span class="ss">:hello</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="2198931433-3">#</span><span class="nc" data-group-id="2198931433-3">PID</span><span class="p" data-group-id="2198931433-3">&lt;</span><span class="mi">0</span><span class="o">.</span><span class="mi">417</span><span class="o">.</span><span class="mi">0</span><span class="p" data-group-id="2198931433-3">&gt;</span><span class="p" data-group-id="2198931433-2">}</span><span class="p">,</span><span class="w">
  </span><span class="p" data-group-id="2198931433-4">{</span><span class="ss">:add</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="2198931433-5">#</span><span class="nc" data-group-id="2198931433-5">PID</span><span class="p" data-group-id="2198931433-5">&lt;</span><span class="mi">0</span><span class="o">.</span><span class="mi">417</span><span class="o">.</span><span class="mi">0</span><span class="p" data-group-id="2198931433-5">&gt;</span><span class="p" data-group-id="2198931433-4">}</span><span class="p">,</span><span class="w">
  </span><span class="p" data-group-id="2198931433-6">{</span><span class="ss">:sub</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="2198931433-7">#</span><span class="nc" data-group-id="2198931433-7">PID</span><span class="p" data-group-id="2198931433-7">&lt;</span><span class="mi">0</span><span class="o">.</span><span class="mi">417</span><span class="o">.</span><span class="mi">0</span><span class="p" data-group-id="2198931433-7">&gt;</span><span class="p" data-group-id="2198931433-6">}</span><span class="p">,</span><span class="w">
  </span><span class="p" data-group-id="2198931433-8">{</span><span class="ss">:times</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="2198931433-9">#</span><span class="nc" data-group-id="2198931433-9">PID</span><span class="p" data-group-id="2198931433-9">&lt;</span><span class="mi">0</span><span class="o">.</span><span class="mi">417</span><span class="o">.</span><span class="mi">0</span><span class="p" data-group-id="2198931433-9">&gt;</span><span class="p" data-group-id="2198931433-8">}</span><span class="p">,</span><span class="w">
  </span><span class="p" data-group-id="2198931433-10">{</span><span class="ss">:divs</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="2198931433-11">#</span><span class="nc" data-group-id="2198931433-11">PID</span><span class="p" data-group-id="2198931433-11">&lt;</span><span class="mi">0</span><span class="o">.</span><span class="mi">417</span><span class="o">.</span><span class="mi">0</span><span class="p" data-group-id="2198931433-11">&gt;</span><span class="p" data-group-id="2198931433-10">}</span><span class="w">
</span><span class="p" data-group-id="2198931433-1">]</span><span class="w">
</span><span class="n">server</span><span class="w"> </span><span class="n">message</span><span class="w"> </span><span class="n">box</span><span class="w"> </span><span class="n">have</span><span class="w"> </span><span class="n">fellow</span><span class="w"> </span><span class="ss">messages</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="2198931433-12">[</span><span class="w">
  </span><span class="p" data-group-id="2198931433-13">{</span><span class="ss">:hello</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="2198931433-14">#</span><span class="nc" data-group-id="2198931433-14">PID</span><span class="p" data-group-id="2198931433-14">&lt;</span><span class="mi">0</span><span class="o">.</span><span class="mi">417</span><span class="o">.</span><span class="mi">0</span><span class="p" data-group-id="2198931433-14">&gt;</span><span class="p" data-group-id="2198931433-13">}</span><span class="p">,</span><span class="w">
  </span><span class="p" data-group-id="2198931433-15">{</span><span class="ss">:sub</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="2198931433-16">#</span><span class="nc" data-group-id="2198931433-16">PID</span><span class="p" data-group-id="2198931433-16">&lt;</span><span class="mi">0</span><span class="o">.</span><span class="mi">417</span><span class="o">.</span><span class="mi">0</span><span class="p" data-group-id="2198931433-16">&gt;</span><span class="p" data-group-id="2198931433-15">}</span><span class="p">,</span><span class="w">
  </span><span class="p" data-group-id="2198931433-17">{</span><span class="ss">:times</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="2198931433-18">#</span><span class="nc" data-group-id="2198931433-18">PID</span><span class="p" data-group-id="2198931433-18">&lt;</span><span class="mi">0</span><span class="o">.</span><span class="mi">417</span><span class="o">.</span><span class="mi">0</span><span class="p" data-group-id="2198931433-18">&gt;</span><span class="p" data-group-id="2198931433-17">}</span><span class="p">,</span><span class="w">
  </span><span class="p" data-group-id="2198931433-19">{</span><span class="ss">:divs</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="2198931433-20">#</span><span class="nc" data-group-id="2198931433-20">PID</span><span class="p" data-group-id="2198931433-20">&lt;</span><span class="mi">0</span><span class="o">.</span><span class="mi">417</span><span class="o">.</span><span class="mi">0</span><span class="p" data-group-id="2198931433-20">&gt;</span><span class="p" data-group-id="2198931433-19">}</span><span class="w">
</span><span class="p" data-group-id="2198931433-12">]</span><span class="w">
</span><span class="n">server</span><span class="w"> </span><span class="n">message</span><span class="w"> </span><span class="n">box</span><span class="w"> </span><span class="n">have</span><span class="w"> </span><span class="n">fellow</span><span class="w"> </span><span class="ss">messages</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="2198931433-21">[</span><span class="w">
  </span><span class="p" data-group-id="2198931433-22">{</span><span class="ss">:hello</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="2198931433-23">#</span><span class="nc" data-group-id="2198931433-23">PID</span><span class="p" data-group-id="2198931433-23">&lt;</span><span class="mi">0</span><span class="o">.</span><span class="mi">417</span><span class="o">.</span><span class="mi">0</span><span class="p" data-group-id="2198931433-23">&gt;</span><span class="p" data-group-id="2198931433-22">}</span><span class="p">,</span><span class="w">
  </span><span class="p" data-group-id="2198931433-24">{</span><span class="ss">:times</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="2198931433-25">#</span><span class="nc" data-group-id="2198931433-25">PID</span><span class="p" data-group-id="2198931433-25">&lt;</span><span class="mi">0</span><span class="o">.</span><span class="mi">417</span><span class="o">.</span><span class="mi">0</span><span class="p" data-group-id="2198931433-25">&gt;</span><span class="p" data-group-id="2198931433-24">}</span><span class="p">,</span><span class="w">
  </span><span class="p" data-group-id="2198931433-26">{</span><span class="ss">:divs</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="2198931433-27">#</span><span class="nc" data-group-id="2198931433-27">PID</span><span class="p" data-group-id="2198931433-27">&lt;</span><span class="mi">0</span><span class="o">.</span><span class="mi">417</span><span class="o">.</span><span class="mi">0</span><span class="p" data-group-id="2198931433-27">&gt;</span><span class="p" data-group-id="2198931433-26">}</span><span class="w">
</span><span class="p" data-group-id="2198931433-21">]</span><span class="w">
</span><span class="n">server</span><span class="w"> </span><span class="n">message</span><span class="w"> </span><span class="n">box</span><span class="w"> </span><span class="n">have</span><span class="w"> </span><span class="n">fellow</span><span class="w"> </span><span class="ss">messages</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="2198931433-28">[</span><span class="p" data-group-id="2198931433-29">{</span><span class="ss">:hello</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="2198931433-30">#</span><span class="nc" data-group-id="2198931433-30">PID</span><span class="p" data-group-id="2198931433-30">&lt;</span><span class="mi">0</span><span class="o">.</span><span class="mi">417</span><span class="o">.</span><span class="mi">0</span><span class="p" data-group-id="2198931433-30">&gt;</span><span class="p" data-group-id="2198931433-29">}</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="2198931433-31">{</span><span class="ss">:divs</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="2198931433-32">#</span><span class="nc" data-group-id="2198931433-32">PID</span><span class="p" data-group-id="2198931433-32">&lt;</span><span class="mi">0</span><span class="o">.</span><span class="mi">417</span><span class="o">.</span><span class="mi">0</span><span class="p" data-group-id="2198931433-32">&gt;</span><span class="p" data-group-id="2198931433-31">}</span><span class="p" data-group-id="2198931433-28">]</span><span class="w">
</span><span class="n">server</span><span class="w"> </span><span class="n">message</span><span class="w"> </span><span class="n">box</span><span class="w"> </span><span class="n">have</span><span class="w"> </span><span class="n">fellow</span><span class="w"> </span><span class="ss">messages</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="2198931433-33">[</span><span class="ss">hello</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="2198931433-34">#</span><span class="nc" data-group-id="2198931433-34">PID</span><span class="p" data-group-id="2198931433-34">&lt;</span><span class="mi">0</span><span class="o">.</span><span class="mi">417</span><span class="o">.</span><span class="mi">0</span><span class="p" data-group-id="2198931433-34">&gt;</span><span class="p" data-group-id="2198931433-33">]</span><span class="w">
</span></code></pre><p>接下来, 让通过 <a href="https://hexdocs.pm/iex/IEx.Helpers.html#flush/0"><code class="inline">IEx.Helpers.flush/0</code></a> 来查看当前进程接收到的消息.
<code class="inline">server_receive</code> 函数只能回应四则运算对应的请求, 所以, <code class="inline">{:hello, pid}</code> 一直都留在邮箱中.
通过 <code class="inline">Process.alive?(pid)</code>, 可以检查一个进程是否还活着.</p><pre><code class="makeup elixir" translate="no"><span class="nc">IEx.Helpers</span><span class="o">.</span><span class="n">flush</span><span class="p" data-group-id="8645617850-1">(</span><span class="p" data-group-id="8645617850-1">)</span><span class="w">

</span><span class="nc">Process</span><span class="o">.</span><span class="n">alive?</span><span class="p" data-group-id="8645617850-2">(</span><span class="n">server</span><span class="p" data-group-id="8645617850-2">)</span><span class="w">
</span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">IO</span><span class="o">.</span><span class="n">inspect</span><span class="p" data-group-id="8645617850-3">(</span><span class="ss">label</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;Is server live? Answere&quot;</span><span class="p" data-group-id="8645617850-3">)</span></code></pre><pre><code class="makeup elixir" translate="no"><span class="p" data-group-id="9993291144-1">{</span><span class="ss">:add</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p" data-group-id="9993291144-1">}</span><span class="w">
</span><span class="p" data-group-id="9993291144-2">{</span><span class="ss">:sub</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p" data-group-id="9993291144-2">}</span><span class="w">
</span><span class="p" data-group-id="9993291144-3">{</span><span class="ss">:times</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p" data-group-id="9993291144-3">}</span><span class="w">
</span><span class="p" data-group-id="9993291144-4">{</span><span class="ss">:div</span><span class="p">,</span><span class="w"> </span><span class="mf">4.0</span><span class="p" data-group-id="9993291144-4">}</span><span class="w">
</span><span class="nc">Is</span><span class="w"> </span><span class="n">server</span><span class="w"> </span><span class="n">live?</span><span class="w"> </span><span class="ss">Answere</span><span class="p">:</span><span class="w"> </span><span class="no">true</span></code></pre><p>上面的代码输出显示服务进程依旧活着, 那么我们可以继续的向其发送请求.
现在向服务进程发送两个消息.</p><pre><code class="makeup elixir" translate="no"><span class="n">send</span><span class="p" data-group-id="5698518836-1">(</span><span class="n">server</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="5698518836-2">{</span><span class="ss">:add</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="n">client</span><span class="p" data-group-id="5698518836-2">}</span><span class="p" data-group-id="5698518836-1">)</span><span class="w">
</span><span class="n">send</span><span class="p" data-group-id="5698518836-3">(</span><span class="n">server</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="5698518836-4">{</span><span class="ss">:sub</span><span class="p">,</span><span class="w"> </span><span class="mi">5</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="n">client</span><span class="p" data-group-id="5698518836-4">}</span><span class="p" data-group-id="5698518836-3">)</span></code></pre><p>控制台输出为:</p><pre><code class="makeup elixir" translate="no"><span class="n">server</span><span class="w"> </span><span class="n">message</span><span class="w"> </span><span class="n">box</span><span class="w"> </span><span class="n">have</span><span class="w"> </span><span class="n">fellow</span><span class="w"> </span><span class="ss">messages</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="9433525877-1">[</span><span class="p" data-group-id="9433525877-2">{</span><span class="ss">:hello</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="9433525877-3">#</span><span class="nc" data-group-id="9433525877-3">PID</span><span class="p" data-group-id="9433525877-3">&lt;</span><span class="mi">0</span><span class="o">.</span><span class="mi">417</span><span class="o">.</span><span class="mi">0</span><span class="p" data-group-id="9433525877-3">&gt;</span><span class="p" data-group-id="9433525877-2">}</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="9433525877-4">{</span><span class="ss">:sub</span><span class="p">,</span><span class="w"> </span><span class="mi">5</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="9433525877-5">#</span><span class="nc" data-group-id="9433525877-5">PID</span><span class="p" data-group-id="9433525877-5">&lt;</span><span class="mi">0</span><span class="o">.</span><span class="mi">417</span><span class="o">.</span><span class="mi">0</span><span class="p" data-group-id="9433525877-5">&gt;</span><span class="p" data-group-id="9433525877-4">}</span><span class="p" data-group-id="9433525877-1">]</span><span class="w">
</span><span class="n">server</span><span class="w"> </span><span class="n">message</span><span class="w"> </span><span class="n">box</span><span class="w"> </span><span class="n">have</span><span class="w"> </span><span class="n">fellow</span><span class="w"> </span><span class="ss">messages</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="9433525877-6">[</span><span class="ss">hello</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="9433525877-7">#</span><span class="nc" data-group-id="9433525877-7">PID</span><span class="p" data-group-id="9433525877-7">&lt;</span><span class="mi">0</span><span class="o">.</span><span class="mi">417</span><span class="o">.</span><span class="mi">0</span><span class="p" data-group-id="9433525877-7">&gt;</span><span class="p" data-group-id="9433525877-6">]</span></code></pre><p>进程运行遇到 <code class="inline">receive</code> 语句后, 如果没有消息可以匹配 <code class="inline">receive</code> 语句中的模式,
那么进程就会暂停. 等向服务器进程发送 <code class="inline">{:add,3,4, client}</code> 和 <code class="inline">{:sub,5,4,client}</code> 之后,
服务进程立刻匹配了第一个消息; 处理结束后, 进入下一次循环, 输出了第一行.
第二个循环处理 <code class="inline">:sub</code> 消息后, 开始下一个循环, 输出了第二行.</p><p>至此, 我们已经知道了如何启动一个服务, 如何处理和回应请求.
但是如何停止这个递归调用的服务进程呢?
这里有几种方法, 最常规的就是明确的用函数命令进程退出: <code class="inline">Process.exit(pid,reason)</code>.
如果服务程序运行的过程出错了, 自然也是要退出的.</p><p>在我们上面的代码中, 执行的四则运算, 四则运算是可能引发错误的. 因此,
通过向服务进程发送不能作四则运算的请求数据, 可以引发服务进程异常退出. 例如像下面这样:</p><pre><code class="makeup elixir" translate="no"><span class="n">send</span><span class="p" data-group-id="2080112014-1">(</span><span class="n">server</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="2080112014-2">{</span><span class="ss">:add</span><span class="p">,</span><span class="w"> </span><span class="ss">:atom</span><span class="p">,</span><span class="w"> </span><span class="ss">:atom2</span><span class="p">,</span><span class="w"> </span><span class="n">client</span><span class="p" data-group-id="2080112014-2">}</span><span class="p" data-group-id="2080112014-1">)</span><span class="w">

</span><span class="nc">Process</span><span class="o">.</span><span class="n">alive?</span><span class="p" data-group-id="2080112014-3">(</span><span class="n">server</span><span class="p" data-group-id="2080112014-3">)</span><span class="w">
</span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">IO</span><span class="o">.</span><span class="n">inspect</span><span class="p" data-group-id="2080112014-4">(</span><span class="ss">label</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;Is server alive? The answer is&quot;</span><span class="p" data-group-id="2080112014-4">)</span></code></pre><p>上面的代码说明, 直接把发送消息的接口暴露给客户端, 是非常危险的.
永远不要信任客户的输入. Elixir 中通常的做法是, 客户端的接口, 通过代理函数来完成.
在代理函数中完成对客户输入的检查.</p><p>上面的例子, 我们自己定义了一个服务.
我们上面的代码中, 除了我们已经指出的, 把与服务器交互的接口直接暴露给客户端,
容易引发服务进程的奔溃外, 还有一个问题, 服务进程直到死亡, 也没有把 <code class="inline">{:hello, pid}</code>
消费掉. 如果我们的进程没有退出, 这个消息将会一直存在于内存空间中, 而且不会被垃圾收集.
如果程序中存在大量这样的垃圾, 最后系统会因为内存不足, 而影响系统.</p><p>对于服务程序来说, 一方面, 都需要写 <code class="inline">server_fun</code> 这样重复性的框架代码, 另一方面,
每个人写的框架代码多少都会有些不同, 这样对代码的其他阅读者来说, 需要比较多的心智负担.
更加糟糕的是, 如果框架代码没有经过仔细的测试, 像我们上面的例子中那样,
还可能会有这样那样的 bug 存在.</p><p>OTP 平台在进程的基础上, 做了进一步的抽象, 使我们可以更统一, 规范的写服务相关的代码.
Elixir 在 OTP 的基础上, 通过 <a href="https://hexdocs.pm/elixir/GenServer.html"><code class="inline">GenServer</code></a> 模块, 提供了通用的服务模块的 API.</p><p>接下来, 我们学习 <a href="https://hexdocs.pm/elixir/GenServer.html"><code class="inline">GenServer</code></a> 的用法.</p><h2 id="genserver-api" class="section-heading">
  <a href="#genserver-api" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i>
  <p class="sr-only">genserver-api</p>
  </a>
  GenServer API
</h2>
<p><a href="https://hexdocs.pm/elixir/GenServer.html"><code class="inline">GenServer</code></a> 是一个行为. 它定义了, 8 个回调函数, 9 个和服务交互的辅助函数.</p><h3 id="回调回调函数" class="section-heading">
  <a href="#回调回调函数" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i>
  <p class="sr-only">回调回调函数</p>
  </a>
  回调回调函数
</h3>
<p>8 个回调函数, 可以分成以下 4 组:</p><ol><li><p>进程初始化: <code class="inline">init(args)</code></p></li><li><p>请求处理函数</p><ol><li><code class="inline">handle_info(request,state)</code></li><li><code class="inline">handle_call(request,from,state)</code></li><li><code class="inline">handle_cast(request,state)</code></li><li><code class="inline">handle_continue(continue,state)</code></li></ol></li><li><p>进程结束时资源清理钩子以及代码热更新钩子</p><ol><li><code class="inline">terminate(reason,state)</code></li><li><code class="inline">code_change(old_env,state,extra)</code></li></ol></li><li><p>状态展示定制函数: <code class="inline">format_status(reason, pdict_and_state)</code></p></li></ol><h3 id="辅助函数" class="section-heading">
  <a href="#辅助函数" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i>
  <p class="sr-only">辅助函数</p>
  </a>
  辅助函数
</h3>
<p>9 个 辅助函数, 可以分成以下几组:</p><ol><li><p>发送请求的辅助函数:</p><ol><li><code class="inline">GenServer.call</code></li><li><code class="inline">GenServer.mutil_call</code></li><li><code class="inline">GenServer.cast</code></li><li><code class="inline">GenServer.abcast</code></li></ol><p>这四个是对 <code class="inline">Kernel.send/2-3</code> 的抽象, 以适应向服务发送请求的通用功能.</p></li><li><p>启动和结束服务器的函数:</p><ol><li><code class="inline">GenServer.start</code></li><li><code class="inline">GenServer.stat_link</code></li><li><code class="inline">GenServer.stop</code></li></ol><p><code class="inline">GenServer.start</code> 是对 <code class="inline">spawn</code> 的进一步的封装; <code class="inline">GenServer.start_link</code>
是对 <code class="inline">spawn_link</code> 的封装; 而 <code class="inline">GenServer.stop</code> 是对 <code class="inline">Process.exit</code> 的抽象.</p></li><li><p>发送回应的辅助函数: <code class="inline">GenServer.reply</code> 是在 <code class="inline">send</code> 的基础上,
为发送回应消息而作的封装.</p></li><li><p>查询服务的函数: <a href="https://hexdocs.pm/elixir/GenServer.html#whereis/1"><code class="inline">GenServer.whereis/1</code></a> 对应的则是 <a href="https://hexdocs.pm/elixir/Process.html#whereis/1"><code class="inline">Process.whereis/1</code></a>.</p></li></ol><h3 id="服务进程与状态机" class="section-heading">
  <a href="#服务进程与状态机" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i>
  <p class="sr-only">服务进程与状态机</p>
  </a>
  服务进程与状态机
</h3>
<p>每个 Elixir 服务进程, 可以看作是一个状态机. 状态机是由外部的输入来改变状态的抽象机器.
把 <a href="https://hexdocs.pm/elixir/GenServer.html"><code class="inline">GenServer</code></a> 看作一个状态机, 用状态图来表示如下:</p><pre><code class="mermaid">stateDiagram-v2
start_link/1~2 --&gt; init/1
start/1 --&gt; init/1
init/1 --&gt; [*]: `#58;ignore` 或 `{#58;stop, reaseon}`
init/1 --&gt; hibernate: 返回 `{#58;ok,state,#58;bibernate}`
init/1 --&gt; timeout: `{#58;ok,state,timeout}`
timeout --&gt; Loop: `#58;timeout`
Loop --&gt; hibernate: 回调函数的返回中包含原子 `#58;hibernate` 且消息队列为空
hibernate --&gt; Loop: 收到消息
init/1 --&gt; Loop: 返回 `{#58;ok,state[,{#58;continue,continue}]}`
Loop --&gt; Loop
Loop --&gt; terminate/2
terminate/2 --&gt; [*]</code></pre><p><code class="inline">GenServer.start</code> 和 <code class="inline">GenServer.start_link</code> 会启动进程.
它们首先会调用 <code class="inline">init/1</code> 回调函数.</p><p>根据 <code class="inline">init/1</code> 返回类型, 进程可能会进入四个状态: 1) 终止状态; 2) 冬眠状态;</p><ol start="2"><li>循环状态; 4) 超时.</li></ol><p>冬眠状态指的是: 服务的消息队列为空, 服务进程停止执行循环, 开始完成垃圾收集工作.
等新消息被接受后, 服务再次开始循环.</p><p>超时状态是指: 当回调函数设置了超时参数后, 在给定的时间内, 消息队列一直都是空的,
这时进程会向自己发送 <code class="inline">:timeout</code> 消息, 会触发 回调函数 <code class="inline">hanlde_info</code>.</p><h4><code class="inline">init/1</code> 状态跳转表</h4><table><thead><tr><th style="text-align: left;"><code class="inline">init/1</code> 返回值</th><th style="text-align: left;">被触发函数, 或程序状态</th></tr></thead><tbody><tr><td style="text-align: left;">返回 <code class="inline">{:ok, state}</code></td><td style="text-align: left;">循环</td></tr><tr><td style="text-align: left;">返回 <code class="inline">{:ok, state, timeout}</code>,且 进程 timeout 毫秒内没有收到消息</td><td style="text-align: left;">进入 timeout 状态, 触发 <code class="inline">handle_info</code></td></tr><tr><td style="text-align: left;">返回 <code class="inline">{:ok,state,{:continue, contine}}</code></td><td style="text-align: left;">触发 <code class="inline">hanlde_continue</code></td></tr><tr><td style="text-align: left;">返回 <code class="inline">{:ok,state,:hibernate}</code></td><td style="text-align: left;">进程冬眠状态</td></tr><tr><td style="text-align: left;">返回 <code class="inline">{:stop, reason}</code></td><td style="text-align: left;">进程终止</td></tr><tr><td style="text-align: left;">返回 <code class="inline">:ignore</code></td><td style="text-align: left;">进程终止</td></tr></tbody></table><h4>触发 <code class="inline">terminate/2</code> 的行为</h4><p><code class="inline">terminate/2</code> 用来完成进程所占资源的清理工作, 它会被如下行为触发:</p><ol><li><p>当前进程设置了 <code class="inline">:trap_exit</code>(<code class="inline">Process.flag(:trap_exit, ture)</code>,
而父进程发送了退出消息 (<code class="inline">Process.exit(pid,reason)</code>).</p></li><li><p><code class="inline">GenServer.stop(server,reason)</code></p></li><li><p>回调函数 <code class="inline">hanlde_*</code> 返回 第一个元素为 <code class="inline">:stop</code> 的元组</p><table><thead><tr><th style="text-align: left;">回调</th><th style="text-align: left;">返回值</th></tr></thead><tbody><tr><td style="text-align: left;"><code class="inline">handle_call/3</code></td><td style="text-align: left;"><code class="inline">{:stop, reason, reply, new_state}</code>, <code class="inline">{:stop, reason, new_state}</code></td></tr><tr><td style="text-align: left;"><code class="inline">handle_cast/2</code></td><td style="text-align: left;"><code class="inline">{:stop, reason :: term, new_state}</code></td></tr><tr><td style="text-align: left;"><code class="inline">handle_info/2</code></td><td style="text-align: left;"><code class="inline">{:stop, reason :: term, new_state}</code></td></tr><tr><td style="text-align: left;"><code class="inline">handle_continue/2</code></td><td style="text-align: left;"><code class="inline">{:stop, reason :: term(), new_state}</code></td></tr></tbody></table></li><li><p>回调函数引发异常 (<a href="https://hexdocs.pm/elixir/Kernel.html#raise/2"><code class="inline">raise/2</code></a>), 或者退出 (<a href="https://hexdocs.pm/elixir/Kernel.html#exit/1"><code class="inline">exit/1</code></a>)</p></li><li><p>回调函数返回的非法的值</p></li></ol><p>需要注意的是 <code class="inline">init/1</code> 并不会触发 <code class="inline">terminate/2</code>.</p><h4>Loop 节点</h4><pre><code class="mermaid">stateDiagram-v2
Loop
Loop --&gt; info: send/send_after
Loop --&gt; cast: GenServer.cast/abcast
Loop --&gt; call: GenServer.call/muti_call
Loop --&gt; continue: init/1 返回 `{#58;ok, state, #58;continue}`
Loop --&gt; [*]

call --&gt; continue
call --&gt; Loop
call --&gt; [*]

info --&gt; continue
info --&gt; Loop
info --&gt; [*]

continue --&gt; continue
continue --&gt; Loop
continue --&gt; [*]


cast --&gt; continue
cast --&gt; Loop
cast --&gt; [*]</code></pre><p>循环节点是我们的主节点. 用来处理接受到的消息和改变系统的状态.
循环状态中有四个子状态, <code class="inline">cast</code>, <code class="inline">call</code>, <code class="inline">info</code> 和 <code class="inline">continue</code>.
对应四种 回调函数 <code class="inline">handle_*</code>.</p><h4><code class="inline">handle_call/3</code> 状态变化</h4><p><code class="inline">GenServer.call/2-3</code> 或 <a href="https://hexdocs.pm/elixir/GenServer.html#multi_call/4"><code class="inline">GenServer.multi_call/4</code></a> 调用会触发 <code class="inline">handle_call/3</code>.
根据 <code class="inline">handle_call/3</code> 的返回值不同, 服务的状态变化表如下:</p><table><thead><tr><th style="text-align: left;"><code class="inline">handle_call/3</code> 返回值</th><th style="text-align: left;">服务状态</th></tr></thead><tbody><tr><td style="text-align: left;"><code class="inline">{:reply, reply, new_state}</code></td><td style="text-align: left;">以 <code class="inline">reply</code> 回应请求, 服务的 state 改变, 继续循环.</td></tr><tr><td style="text-align: left;"><code class="inline">{:reply, reply, new_state, timeout}</code></td><td style="text-align: left;">以 <code class="inline">reply</code> 回应请求, 服务的 state 改变, 如果 <code class="inline">timeout</code> 毫秒没有没有消息进来, 进程进入 timeout 状态.</td></tr><tr><td style="text-align: left;"><code class="inline">{:reply, reply, new_state, :hibernate}</code></td><td style="text-align: left;">以 <code class="inline">reply</code> 回应请求, 服务的 state 改变, 如果消息队列空了, 进程进入冬眠状态</td></tr><tr><td style="text-align: left;"><code class="inline">{:reply, reply, new_state, {:continue, term}}</code></td><td style="text-align: left;">以 <code class="inline">reply</code> 回应请求, 服务的 state 改变, 处理下一个消息前, 继续执行 <code class="inline">handle_continue</code> 回调</td></tr><tr><td style="text-align: left;"><code class="inline">{:stop, reason, reply, new_state}</code></td><td style="text-align: left;">以 <code class="inline">reply</code> 回应请求, 进程的 state 改变, 服务进入 terminate 状态, <code class="inline">terminate/2</code> 被触发</td></tr><tr><td style="text-align: left;"><code class="inline">{:stop, reason, new_state}</code></td><td style="text-align: left;">进程 state 改变, 服务进入 <code class="inline">terminate/2</code> 被触发.</td></tr></tbody></table><h4><code class="inline">handle_cast/2</code> 状态变化</h4><p><a href="https://hexdocs.pm/elixir/GenServer.html#cast/2"><code class="inline">GenServer.cast/2</code></a> 或 <a href="https://hexdocs.pm/elixir/GenServer.html#abcast/2"><code class="inline">GenServer.abcast/2</code></a> 会触发 <code class="inline">handle_cast/2</code> 回调函数.</p><p>根据 <code class="inline">handle_cast/2</code> 返回值的不同, 进程的状态变化如下表:</p><table><thead><tr><th style="text-align: left;"><code class="inline">hanlde_cast/2</code> 的返回值</th><th style="text-align: left;">服务状态</th></tr></thead><tbody><tr><td style="text-align: left;"><code class="inline">{:noreply, new_state}</code></td><td style="text-align: left;">进程的 state 改变, 进入循环, 等待处理下一个消息.</td></tr><tr><td style="text-align: left;"><code class="inline">{:noreply, new_state, timeout}</code></td><td style="text-align: left;">进程的 state 改变, 如果 timeout 毫秒内, 消息对立依旧为空, 进程进入冬眠模式</td></tr><tr><td style="text-align: left;"><code class="inline">{:noreply, new_state,:hibernate}</code></td><td style="text-align: left;">进程的 state 改变, 如果消息对立为空, 进程进入冬眠状态</td></tr><tr><td style="text-align: left;"><code class="inline">{:noreply, new_state,{:continue, term}}</code></td><td style="text-align: left;">进程的 state 改变, 在处理其他消息之前, 继续执行 <code class="inline">handle_continue</code></td></tr><tr><td style="text-align: left;"><code class="inline">{:stop, reason :: term, new_state}</code></td><td style="text-align: left;">进程的 state 改变, 服务进入 terminate 状态, <code class="inline">terminate/2</code> 会被触发</td></tr></tbody></table><h4><code class="inline">handle_info/2</code> 状态</h4><p><code class="inline">GenServer.cast</code>, <code class="inline">GenServer.abcast</code>, <code class="inline">GenServer.call</code>, 和 <code class="inline">GenServer.muti_call</code>
之外的方法发送给进程的消息, 都会触发 <code class="inline">handle_info</code> 回调函数.</p><p>具体来说, 以下方法的调用都会触发相应的服务的 <code class="inline">handle_info/2</code> 回调函数:</p><ul><li><a href="https://hexdocs.pm/elixir/Kernel.html#send/2"><code class="inline">Kernel.send/2</code></a></li><li><a href="https://hexdocs.pm/elixir/Process.html#send/3"><code class="inline">Process.send/3</code></a></li><li><a href="https://hexdocs.pm/elixir/Process.html#send_after/3"><code class="inline">Process.send_after/3</code></a></li></ul><p>当服务处于 timeout 状态时, 会向进程自己发送 <code class="inline">:timeout</code> 消息.</p><p>根据 <code class="inline">handle_info/2</code> 返回值的不同, 服务的状态变化有下表表示.</p><table><thead><tr><th style="text-align: left;"><code class="inline">handle_info/2</code> 的返回值</th><th style="text-align: left;">服务状态</th></tr></thead><tbody><tr><td style="text-align: left;"><code class="inline">{:noreply, new_state}</code></td><td style="text-align: left;">进程 state 改变</td></tr><tr><td style="text-align: left;"><code class="inline">{:noreply, new_state, timeout}</code></td><td style="text-align: left;">进程 state 改变, 如果 timeout 毫秒内, 服务的消息队列中依旧为空, 服务进入 timeout 状态</td></tr><tr><td style="text-align: left;"><code class="inline">{:noreply, new_state, :hibernate}</code></td><td style="text-align: left;">进程 state 改变, 如果服务的消息队列为空, 进程进入冬眠状态.</td></tr><tr><td style="text-align: left;"><code class="inline">{:noreply, new_state, {:continue, term}}</code></td><td style="text-align: left;">进程 state 改变, 在处理其他消息之前, 继续执行 <code class="inline">handle_continue</code> 回调函数</td></tr><tr><td style="text-align: left;"><code class="inline">{:stop, reason :: term(), new_state}</code></td><td style="text-align: left;">进程 state 改变, 进程进入终止状态, <code class="inline">terminate/2</code> 会被调用</td></tr></tbody></table><h4><code class="inline">handle_continue/2</code></h4><p>回调函数的返回值中含有 <code class="inline">:continue</code> 原子的时候, 会触发 <code class="inline">hanlde_continue/2</code> 回调.
<code class="inline">handle_continue/2</code> 总是在 <code class="inline">handle_*</code> 调用之后立即被调用的,
而不是在下一个的循环中被调用. 触发 <code class="inline">handle_continue/2</code>
的其他回调函数的返回情况如下:</p><table><thead><tr><th style="text-align: left;">回调函数</th><th style="text-align: left;">返回值</th></tr></thead><tbody><tr><td style="text-align: left;"><code class="inline">handle_call/3</code></td><td style="text-align: left;"><code class="inline">{:reply, reply, new_state, {:continue, term}}</code></td></tr><tr><td style="text-align: left;"><code class="inline">handle_cast/2</code></td><td style="text-align: left;"><code class="inline">{:noreply, new_state,{:continue, term}}</code></td></tr><tr><td style="text-align: left;"><code class="inline">hanlde_info/2</code></td><td style="text-align: left;"><code class="inline">{:noreply, new_state, {:continue, term}}</code></td></tr><tr><td style="text-align: left;"><code class="inline">hanlde_continue/2</code></td><td style="text-align: left;"><code class="inline">{:noreply, new_state, {:continue, term()}}</code></td></tr></tbody></table><p><code class="inline">handle_continue/2</code> 返回值, 以及引发的服务状态由下表表示:</p><table><thead><tr><th style="text-align: left;"><code class="inline">hanlde_continue/2</code> 返回值</th><th style="text-align: left;">状态</th></tr></thead><tbody><tr><td style="text-align: left;"><code class="inline">{:noreply, new_state}</code></td><td style="text-align: left;">修改进程状态</td></tr><tr><td style="text-align: left;"><code class="inline">{:noreply, new_state, timeout}</code></td><td style="text-align: left;">修改进程状态, 如果 timeout 毫秒内, 消息队列依旧为空, 服务进入超时状态, 触发 <code class="inline">handle_info</code></td></tr><tr><td style="text-align: left;"><code class="inline">{:noreply, new_state,:hibernate}</code></td><td style="text-align: left;">修改进程状态, 如果消息队列依旧为空, 服务进入冬眠状态</td></tr><tr><td style="text-align: left;"><code class="inline">{:noreply, new_state, {:continue, term}}</code></td><td style="text-align: left;">继续执行 <code class="inline">handle_continue/2</code> 子句</td></tr></tbody></table><h2 id="基于-genserver-的其他模块" class="section-heading">
  <a href="#基于-genserver-的其他模块" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i>
  <p class="sr-only">基于-genserver-的其他模块</p>
  </a>
  基于 <a href="https://hexdocs.pm/elixir/GenServer.html"><code class="inline">GenServer</code></a> 的其他模块
</h2>
<p><a href="https://hexdocs.pm/elixir/GenServer.html"><code class="inline">GenServer</code></a> Elixir 为我们提供的最重要的抽象.
在 <a href="https://hexdocs.pm/elixir/GenServer.html"><code class="inline">GenServer</code></a> 的基础上, Elixir 还未我们提供了如下的模块:</p><ul><li><a href="https://hexdocs.pm/elixir/Task.html"><code class="inline">Task</code></a> 使用进程来完成异步计算</li><li><a href="https://hexdocs.pm/elixir/Agent.html"><code class="inline">Agent</code></a> 使用服务进程来保存状态</li></ul><p>OTP 的自愈特性, 是基于对进程的监督和重启的.</p><ul><li><a href="https://hexdocs.pm/elixir/Supervisor.html"><code class="inline">Supervisor</code></a> 模块是一个行为, 用来帮助我们写出一致的管理者进程.</li><li><a href="https://hexdocs.pm/elixir/DynamicSupervisor.html"><code class="inline">DynamicSupervisor</code></a> 模型是一个行为, 用来帮助我们些出一致的动态管理者进程.</li><li><a href="https://hexdocs.pm/elixir/Application.html"><code class="inline">Application</code></a> 模块是一个行为, 用来帮助我们统一启动进程数的格式和代码.</li></ul><p>后面的章节, 会对这些模块作一一介绍.</p>
<div class="bottom-actions">
  <div class="bottom-actions-item">

      <a href="ch11-macro.html" class="bottom-actions-button" rel="prev">
        <span class="subheader">
          ← Previous Page
        </span>
        <span class="title">
第十一章 如何理解宏
        </span>
      </a>

  </div>
  <div class="bottom-actions-item">

      <a href="chx-cold_knowledge.html" class="bottom-actions-button" rel="next">
        <span class="subheader">
          Next Page →
        </span>
        <span class="title">
附录 冷知识
        </span>
      </a>

  </div>
</div>

      <footer class="footer">

        <p>
          Built using
          <a href="https://github.com/elixir-lang/ex_doc" title="ExDoc" target="_blank" rel="help noopener" translate="no">ExDoc</a> (v0.28.4) for the

            <a href="https://elixir-lang.org" title="Elixir" target="_blank" translate="no">Elixir programming language</a>

        </p>
      </footer>
    </div>
  </div>
</section>
</div>


  </body>
</html>
